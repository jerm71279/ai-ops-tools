<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Command Center - OberaConnect</title>
    <!-- Build: 2025-11-29-v1 -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.1/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.6.0/lib/msal-browser.min.js"></script>
    <!-- Chart.js CDN for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Socket.IO client library -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <!-- Diff-match-patch library for visual diffing -->
    <script src="https://unpkg.com/diff-match-patch@latest/index.js"></script>
    <!-- Modular JavaScript -->
    <script src="js/core.js"></script>
    <script src="js/data-store.js"></script>
    <script src="js/loading-states.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surface: #ffffff;
            --surface-dark: #f8fafc;
            --surface-darker: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --ai-claude: #d97706;
            --ai-gemini: #059669;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* Accessibility - Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus visible for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Toast Notification System */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 20px;
            border-radius: var(--radius-md);
            background: var(--surface);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-info { border-left: 4px solid var(--secondary); }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-warning { border-left: 4px solid var(--warning); }
        .toast-error { border-left: 4px solid var(--danger); }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        .toast-info .toast-icon { color: var(--secondary); }
        .toast-success .toast-icon { color: var(--success); }
        .toast-warning .toast-icon { color: var(--warning); }
        .toast-error .toast-icon { color: var(--danger); }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .toast-close:hover { color: var(--text-primary); }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: inherit;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 12px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Form Validation Errors */
        .form-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-input.error {
            border-color: var(--danger);
        }



        .header-left { display: flex; align-items: center; gap: 16px; }

        .logo-container { display: flex; align-items: center; gap: 12px; }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 14px rgba(99,102,241,0.4);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 500;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-agent-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: var(--radius-md);
            border: 2px solid;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-agent-btn.claude {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: var(--ai-claude);
            color: #92400e;
        }

        .ai-agent-btn.claude:hover {
            background: linear-gradient(135deg, #fde68a, #fcd34d);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217,119,6,0.3);
        }

        .ai-agent-btn.gemini {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: var(--ai-gemini);
            color: #065f46;
        }

        .ai-agent-btn.gemini:hover {
            background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5,150,105,0.3);
        }

        .ai-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .ai-status.active { background: var(--success); }
        .ai-status.idle { background: var(--text-muted); }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .header-right { display: flex; align-items: center; gap: 12px; }

        .header-time {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 8px 14px;
            background: var(--surface-dark);
            border-radius: var(--radius-md);
            font-weight: 500;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(99,102,241,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99,102,241,0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 8px 12px;
        }

        .btn-ghost:hover {
            background: var(--surface-dark);
            color: var(--primary);
        }

        /* Envelope Container */
        .envelope-container {
            padding: 24px 32px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Envelope Tabs */
        .envelope-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: -2px;
            position: relative;
            z-index: 10;
        }

        .envelope-tab {
            padding: 14px 28px;
            background: rgba(255,255,255,0.85);
            border: none;
            border-radius: 20px 20px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .envelope-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            border-radius: 20px 20px 0 0;
            transition: background 0.3s ease;
        }

        .envelope-tab:hover {
            background: rgba(255,255,255,0.95);
            transform: translateY(-3px);
        }

        .envelope-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .envelope-tab.active::before {
            background: linear-gradient(90deg, var(--primary) 0%, #8b5cf6 100%);
        }

        .tab-badge {
            background: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 22px;
            text-align: center;
        }

        /* Envelope Content */
        .envelope-content {
            background: white;
            border-radius: 0 24px 24px 24px;
            box-shadow: var(--shadow-xl);
            min-height: 700px;
            overflow: hidden;
        }

        .tab-panel {
            display: none;
            padding: 28px;
            animation: fadeIn 0.3s ease;
        }

        .tab-panel.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--surface-dark) 0%, white 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .stat-card.total::before { background: var(--primary); }
        .stat-card.progress::before { background: var(--warning); }
        .stat-card.priority::before { background: var(--danger); }
        .stat-card.completed::before { background: var(--success); }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card.total .stat-icon { background: rgba(99,102,241,0.1); color: var(--primary); }
        .stat-card.progress .stat-icon { background: rgba(245,158,11,0.1); color: var(--warning); }
        .stat-card.priority .stat-icon { background: rgba(239,68,68,0.1); color: var(--danger); }
        .stat-card.completed .stat-icon { background: rgba(16,185,129,0.1); color: var(--success); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 500px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            transition: all 0.3s ease;
            background: var(--surface-dark);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .filter-group { display: flex; gap: 8px; }

        .filter-select {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            background: var(--surface-dark);
            cursor: pointer;
            min-width: 130px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .view-toggle {
            display: flex;
            background: var(--surface-dark);
            border-radius: var(--radius-md);
            padding: 3px;
        }

        .view-btn {
            padding: 8px 14px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* Export Button */
        .export-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .export-btn:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 150px;
            z-index: 100;
            display: none;
        }

        .export-dropdown.show {
            display: block;
        }

        .export-option {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.2s ease;
        }

        .export-option:hover {
            background: var(--surface);
        }

        .export-option:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .export-option:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        /* Global Search */
        .global-search-container {
            position: relative;
            width: 300px;
        }

        .global-search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
            transition: all 0.2s ease;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }

        .global-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 4px;
        }

        .search-results-dropdown.show {
            display: block;
        }

        .search-result-group {
            padding: 8px;
        }

        .search-result-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 6px 8px;
            background: var(--surface);
            border-radius: var(--radius-sm);
            margin-bottom: 4px;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.2s ease;
        }

        .search-result-item:hover {
            background: var(--surface);
        }

        .search-result-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
            font-size: 14px;
        }

        .search-result-title mark {
            background: #fef08a;
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }

        .search-result-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .search-loading {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Version History Panel */
        .version-history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--surface);
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 1001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .version-history-panel.open {
            right: 0;
        }

        .version-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface-dark);
        }

        .version-panel-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .version-panel-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .version-panel-close:hover {
            background: var(--surface-darker);
            color: var(--text-primary);
        }

        .version-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .version-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .version-item {
            background: var(--surface-dark);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .version-item:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-sm);
        }

        .version-item.current {
            border-color: var(--success);
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .version-info {
            flex: 1;
        }

        .version-number {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .version-number .current-badge {
            font-size: 10px;
            padding: 2px 8px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-weight: 500;
        }

        .version-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .version-author {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .version-restore-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .version-restore-btn:hover {
            background: var(--primary-dark);
        }

        .version-restore-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .version-changes {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .version-change-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .version-change-field {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 80px;
        }

        .version-change-old {
            color: var(--danger);
            text-decoration: line-through;
        }

        .version-change-new {
            color: var(--success);
        }

        .version-change-arrow {
            color: var(--text-muted);
        }

        .version-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .version-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .history-btn {
            padding: 8px;
            background: none;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* File Attachments */
        .attachments-section {
            border-top: 1px solid var(--border);
            margin-top: 20px;
            padding-top: 20px;
        }

        .attachments-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .attachment-dropzone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--surface-dark);
        }

        .attachment-dropzone:hover {
            border-color: var(--primary-light);
            background: var(--surface-darker);
        }

        .attachment-dropzone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .attachment-dropzone-icon {
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .attachment-dropzone-text {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .attachment-dropzone-text strong {
            color: var(--primary);
            cursor: pointer;
        }

        .attachment-dropzone-hint {
            color: var(--text-muted);
            font-size: 11px;
            margin-top: 6px;
        }

        .attachment-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--surface-dark);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .attachment-item:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-sm);
        }

        .attachment-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .attachment-icon.pdf { background: #fee2e2; color: #dc2626; }
        .attachment-icon.doc { background: #dbeafe; color: #2563eb; }
        .attachment-icon.xls { background: #d1fae5; color: #059669; }
        .attachment-icon.img { background: #fef3c7; color: #d97706; }
        .attachment-icon.default { background: var(--surface-darker); color: var(--text-secondary); }

        .attachment-info {
            flex: 1;
            min-width: 0;
        }

        .attachment-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .attachment-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .attachment-actions {
            display: flex;
            gap: 4px;
        }

        .attachment-btn {
            padding: 6px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .attachment-btn:hover {
            background: var(--surface-darker);
            color: var(--text-primary);
        }

        .attachment-btn.download:hover {
            background: var(--primary);
            color: white;
        }

        .attachment-btn.delete:hover {
            background: var(--danger);
            color: white;
        }

        .attachment-upload-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--surface-dark);
            border-radius: var(--radius-sm);
            border: 1px solid var(--primary-light);
        }

        .attachment-progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .attachment-progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .attachment-empty {
            text-align: center;
            padding: 16px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .attachment-loading {
            text-align: center;
            padding: 16px;
            color: var(--text-muted);
        }

        /* Calendar View */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calendar-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            min-width: 200px;
            text-align: center;
        }

        .calendar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-filter {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .filter-checkbox input {
            display: none;
        }

        .filter-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .filter-checkbox input:not(:checked) + .filter-dot {
            opacity: 0.3;
        }

        .calendar-grid {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--surface-dark);
            border-bottom: 1px solid var(--border);
        }

        .calendar-weekday {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day {
            min-height: 120px;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 8px;
            background: white;
            transition: background 0.2s;
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background: var(--surface-dark);
        }

        .calendar-day.other-month {
            background: var(--surface-darker);
        }

        .calendar-day.other-month .calendar-day-number {
            color: var(--text-muted);
        }

        .calendar-day.today {
            background: rgba(99, 102, 241, 0.05);
        }

        .calendar-day.today .calendar-day-number {
            background: var(--primary);
            color: white;
        }

        .calendar-day-number {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            border-radius: 50%;
            margin-bottom: 6px;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 80px;
            overflow-y: auto;
        }

        .calendar-event {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-event:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-sm);
        }

        .calendar-event.project {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary-dark);
            border-left: 3px solid var(--primary);
        }

        .calendar-event.ticket {
            background: rgba(245, 158, 11, 0.15);
            color: #b45309;
            border-left: 3px solid var(--warning);
        }

        .calendar-event.task {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
            border-left: 3px solid var(--success);
        }

        .calendar-more {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
            padding: 2px;
            cursor: pointer;
        }

        .calendar-more:hover {
            color: var(--primary);
        }

        /* Bulk Edit */
        .bulk-actions-bar {
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 100;
            align-items: center;
            gap: 16px;
            animation: slideUp 0.3s ease;
        }

        .bulk-actions-bar.show {
            display: flex;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .bulk-selected-count {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .bulk-btn.primary {
            background: var(--primary);
            color: white;
        }

        .bulk-btn.primary:hover {
            background: var(--primary-dark);
        }

        .bulk-btn.secondary {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .bulk-btn.secondary:hover {
            background: rgba(255,255,255,0.25);
        }

        .bulk-btn.danger {
            background: var(--danger);
            color: white;
        }

        .bulk-btn.danger:hover {
            background: #dc2626;
        }

        .bulk-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
        }

        .bulk-close:hover {
            color: white;
        }

        .chat-card-checkbox {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }

        .chat-card:hover .chat-card-checkbox,
        .chat-card.selected .chat-card-checkbox {
            opacity: 1;
        }

        .chat-card.selected .chat-card-checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }

        .chat-card.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.03);
        }

        .bulk-edit-modal .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .bulk-field-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .bulk-field-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* Kanban Board - Draggable */
        .kanban-board {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .kanban-column {
            min-width: 300px;
            max-width: 300px;
            background: var(--surface-dark);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
        }

        .kanban-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .kanban-header.not-started { background: linear-gradient(135deg, #e2e8f0, #cbd5e1); }
        .kanban-header.open { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .kanban-header.in-progress { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .kanban-header.on-hold { background: linear-gradient(135deg, #fce7f3, #fbcfe8); }
        .kanban-header.pending { background: linear-gradient(135deg, #ede9fe, #ddd6fe); }
        .kanban-header.completed { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
        .kanban-header.resolved { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
        .kanban-header.closed { background: linear-gradient(135deg, #e5e7eb, #d1d5db); }
        .kanban-header.archived { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); }

        .kanban-title {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }

        .kanban-count {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .kanban-cards {
            padding: 8px;
            flex: 1;
            min-height: 100px;
        }

        .kanban-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 8px 10px;
            margin-bottom: 6px;
            box-shadow: var(--shadow-sm);
            cursor: grab;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .kanban-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .kanban-card.sortable-ghost {
            opacity: 0.4;
            border: 1px dashed var(--primary);
        }

        .kanban-card.sortable-drag {
            box-shadow: var(--shadow-lg);
            transform: rotate(2deg);
        }

        .kanban-card-title {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .kanban-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .kanban-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 4px;
            border-top: 1px solid var(--border);
            font-size: 10px;
        }

        .comment-count {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .comment-count:hover { color: var(--primary); }

        /* Chat Card System */
        .chat-cards-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-card {
            display: flex;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .chat-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .chat-body { flex: 1; min-width: 0; }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .chat-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .chat-preview {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chat-tag {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .tag-priority-low { background: rgba(16,185,129,0.1); color: var(--success); }
        .tag-priority-medium { background: rgba(245,158,11,0.1); color: var(--warning); }
        .tag-priority-high { background: rgba(239,68,68,0.1); color: var(--danger); }
        .tag-priority-critical { background: var(--danger); color: white; }

        .tag-status-not-started { background: rgba(148,163,184,0.2); color: var(--text-secondary); }
        .tag-status-open { background: rgba(14,165,233,0.1); color: var(--secondary); }
        .tag-status-in-progress { background: rgba(245,158,11,0.1); color: var(--warning); }
        .tag-status-on-hold { background: rgba(236,72,153,0.1); color: #ec4899; }
        .tag-status-pending { background: rgba(139,92,246,0.1); color: #8b5cf6; }
        .tag-status-completed { background: rgba(16,185,129,0.1); color: var(--success); }
        .tag-status-resolved { background: rgba(16,185,129,0.1); color: var(--success); }
        .tag-status-closed { background: rgba(100,116,139,0.1); color: var(--text-secondary); }
        .tag-status-archived { background: rgba(107,114,128,0.1); color: #6b7280; }

        .chat-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .chat-assignee-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--surface-darker);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Tools Index */
        .tools-categories { display: grid; gap: 20px; }

        .tool-category {
            background: var(--surface-dark);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 14px;
            border-bottom: 2px solid var(--border);
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .category-icon.data { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .category-icon.network { background: linear-gradient(135deg, #0ea5e9, #06b6d4); }
        .category-icon.document { background: linear-gradient(135deg, #10b981, #34d399); }
        .category-icon.automation { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .category-icon.agent { background: linear-gradient(135deg, #ec4899, #f472b6); }
        .category-icon.config { background: linear-gradient(135deg, #64748b, #94a3b8); }

        .category-title { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .category-count { font-size: 13px; color: var(--text-muted); }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
        }

        .tool-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 14px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tool-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .tool-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tool-name .file-icon { color: var(--primary); }

        .tool-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .tool-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .tool-action-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .tool-action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99,102,241,0.05);
        }

        .tool-action-btn:active {
            transform: scale(0.95);
        }

        .tool-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .tool-detail-row:last-child {
            border-bottom: none;
        }

        .tool-detail-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .tool-detail-value {
            font-size: 12px;
            color: var(--text-primary);
            font-family: monospace;
        }

        /* Planner */
        .planner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .planner-date {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .planner-nav { display: flex; gap: 8px; }

        .planner-nav-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--border);
            background: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .planner-nav-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .planner-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }

        .day-column {
            background: var(--surface-dark);
            border-radius: var(--radius-lg);
            padding: 12px;
            min-height: 250px;
        }

        .day-header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 10px;
        }

        .day-name {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .day-date {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .day-column.today .day-date {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .day-tasks { display: flex; flex-direction: column; gap: 6px; }

        .day-task {
            padding: 8px;
            background: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            border-left: 3px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-task:hover {
            box-shadow: var(--shadow-sm);
            transform: translateX(2px);
        }

        .day-task.priority-high { border-left-color: var(--danger); }
        .day-task.priority-medium { border-left-color: var(--warning); }

        /* Assignee Sections */
        .assignee-sections { display: flex; flex-direction: column; gap: 24px; }

        .assignee-section {
            background: var(--surface-dark);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .assignee-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid var(--border);
        }

        .assignee-avatar-lg {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .assignee-info { flex: 1; }
        .assignee-name { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .assignee-stats { display: flex; gap: 14px; margin-top: 4px; }

        .assignee-stat {
            font-size: 12px;
            color: var(--text-muted);
        }

        .assignee-stat strong { color: var(--text-secondary); }

        .todo-list { padding: 12px; }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: var(--radius-md);
            margin-bottom: 6px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .todo-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .todo-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .todo-checkbox:hover { border-color: var(--primary); }

        .todo-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .todo-content { flex: 1; }
        .todo-title { font-weight: 500; color: var(--text-primary); margin-bottom: 4px; font-size: 14px; }
        .todo-item.completed .todo-title { text-decoration: line-through; color: var(--text-muted); }
        .todo-meta { display: flex; gap: 10px; font-size: 11px; color: var(--text-muted); }

        .todo-due { display: flex; align-items: center; gap: 4px; }
        .todo-due.overdue { color: var(--danger); }
        .todo-due.soon { color: var(--warning); }

        /* Ticket Groups with Task Rollup */
        .todo-ticket-group {
            background: white;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .todo-ticket-group.completed {
            opacity: 0.7;
        }

        .todo-ticket-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .todo-ticket-header:hover {
            background: var(--surface);
        }

        .todo-ticket-content {
            flex: 1;
            min-width: 0;
        }

        .todo-ticket-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .todo-ticket-group.completed .todo-ticket-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .ticket-expand-icon {
            transition: transform 0.2s ease;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .reference-badge {
            font-size: 10px;
            background: var(--primary-light);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
        }

        .task-progress-badge {
            font-size: 11px;
            background: var(--surface);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .task-progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .todo-tasks-list {
            border-top: 1px solid var(--border);
            background: var(--surface);
            padding: 8px;
        }

        .todo-task-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .todo-task-item:last-child {
            margin-bottom: 0;
        }

        .todo-task-item:hover {
            border-color: var(--primary);
        }

        .todo-task-item.completed {
            opacity: 0.6;
        }

        .todo-task-content {
            flex: 1;
            min-width: 0;
        }

        .todo-task-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 13px;
        }

        .todo-task-item.completed .todo-task-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .tag-phase {
            background: #e8f4fd;
            color: #1976d2;
        }

        .tag-project {
            background: #fff3e0;
            color: #e65100;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .task-assignee-badge {
            font-size: 10px;
            background: var(--surface-dark);
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .no-tasks-msg {
            text-align: center;
            padding: 16px;
            color: var(--text-muted);
            font-size: 12px;
            font-style: italic;
        }

        /* Quick Add */
        .quick-add {
            background: linear-gradient(135deg, var(--surface-dark) 0%, white 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed var(--border);
        }

        .quick-add-title { font-weight: 600; margin-bottom: 12px; color: var(--text-primary); }

        .quick-add-form { display: flex; gap: 10px; }

        .quick-add-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .quick-add-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* AI Assistant Panel */
        .ai-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            z-index: 200;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .ai-panel.open { right: 0; }

        .ai-panel-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-panel-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-panel-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .ai-chat-messages {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ai-message {
            display: flex;
            gap: 12px;
        }

        .ai-message.user { flex-direction: row-reverse; }

        .ai-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ai-message.assistant .ai-message-avatar {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
        }

        .ai-message.user .ai-message-avatar {
            background: var(--surface-dark);
            color: var(--text-secondary);
        }

        .ai-message-content {
            background: var(--surface-dark);
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            max-width: 85%;
            font-size: 14px;
            line-height: 1.5;
        }

        .ai-message.user .ai-message-content {
            background: var(--primary);
            color: white;
        }

        .ai-panel-input {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .ai-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 14px;
            resize: none;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .ai-send-btn {
            width: 44px;
            height: 44px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .ai-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99,102,241,0.4);
        }

        /* Project/Ticket Detail Modal - Full View */
        .detail-modal {
            max-width: 1200px;
            max-height: 95vh;
        }

        .detail-modal .modal-body {
            padding: 0;
        }

        .detail-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 600px;
        }

        .detail-sidebar {
            background: var(--surface-dark);
            padding: 24px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        .detail-main {
            padding: 24px;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .detail-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tasks Mini-Kanban */
        .tasks-kanban {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .tasks-column {
            min-width: 200px;
            background: var(--surface-darker);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .tasks-column-header {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tasks-column-count {
            background: var(--surface-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .task-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid var(--primary);
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .task-card.priority-high { border-left-color: var(--danger); }
        .task-card.priority-critical { border-left-color: #dc2626; }
        .task-card.priority-low { border-left-color: var(--success); }

        .task-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .task-assignee-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
        }

        /* Documentation Log */
        .doc-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .doc-entry {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .doc-entry:last-child { border-bottom: none; }

        .doc-entry-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .doc-entry-icon.created { background: rgba(16,185,129,0.1); color: var(--success); }
        .doc-entry-icon.task_created { background: rgba(99,102,241,0.1); color: var(--primary); }
        .doc-entry-icon.task_updated { background: rgba(245,158,11,0.1); color: var(--warning); }
        .doc-entry-icon.note { background: rgba(14,165,233,0.1); color: var(--secondary); }
        .doc-entry-icon.status_change { background: rgba(139,92,246,0.1); color: #8b5cf6; }

        .doc-entry-content { flex: 1; }

        .doc-entry-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .doc-entry-author {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .doc-entry-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .doc-entry-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .doc-entry-type {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--surface-dark);
            color: var(--text-muted);
        }

        /* Add Documentation Input */
        .doc-input-container {
            display: flex;
            gap: 10px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .doc-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            resize: none;
        }

        .doc-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Add Task Modal */
        .add-task-form {
            display: grid;
            gap: 12px;
        }

        /* Task Row in Project Modal */
        .task-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 8px;
            align-items: center;
            padding: 10px 12px;
            background: var(--surface-dark);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border-left: 3px solid var(--primary);
        }

        .task-row.priority-high { border-left-color: var(--danger); }
        .task-row.priority-critical { border-left-color: #dc2626; }
        .task-row.priority-low { border-left-color: var(--success); }

        .task-row-title {
            font-size: 13px;
            font-weight: 500;
        }

        .task-row-field {
            font-size: 11px;
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .task-row-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .task-row-remove:hover {
            background: var(--danger);
            color: white;
        }

        /* Inline Task Add Form */
        .task-add-row {
            display: grid;
            grid-template-columns: 1fr 100px 100px 80px auto;
            gap: 8px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 2px dashed var(--border);
        }

        .task-add-row input,
        .task-add-row select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
        }

        .task-add-row input:focus,
        .task-add-row select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Progress indicator */
        .progress-ring {
            width: 60px;
            height: 60px;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 700;
            fill: var(--text-primary);
        }

        /* Linked ticket indicator */
        .linked-ticket-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid var(--warning);
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            color: #92400e;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .linked-ticket-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        @media (max-width: 900px) {
            .detail-content { grid-template-columns: 1fr; }
            .detail-sidebar { border-right: none; border-bottom: 1px solid var(--border); }
        }

        /* Detail Modal with Comments */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15,23,42,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: modalSlide 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 18px; font-weight: 700; color: var(--text-primary); }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--surface-dark);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-content-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 24px;
        }

        .modal-main { }

        .modal-sidebar {
            border-left: 1px solid var(--border);
            padding-left: 24px;
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .form-label .required { color: var(--danger); }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }

        .form-textarea { min-height: 80px; resize: vertical; }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Comments Section */
        .comments-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .comments-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .comment-item {
            display: flex;
            gap: 10px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #06b6d4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .comment-content { flex: 1; }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .comment-author { font-weight: 600; font-size: 13px; color: var(--text-primary); }
        .comment-time { font-size: 11px; color: var(--text-muted); }

        .comment-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            background: var(--surface-dark);
            padding: 10px 14px;
            border-radius: var(--radius-md);
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            resize: none;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .comment-send {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Activity Log in Sidebar */
        .activity-section { margin-bottom: 20px; }
        .activity-title { font-weight: 600; font-size: 14px; margin-bottom: 12px; color: var(--text-primary); }

        .activity-list { display: flex; flex-direction: column; gap: 10px; }

        .activity-item {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }

        .activity-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--surface-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-text { color: var(--text-secondary); line-height: 1.4; }
        .activity-text strong { color: var(--text-primary); }
        .activity-time { color: var(--text-muted); font-size: 11px; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
        }

        .empty-state-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 20px;
            background: var(--surface-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state p { color: var(--text-muted); margin-bottom: 20px; }

        /* Loading */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .planner-grid { grid-template-columns: repeat(4, 1fr); }
            .modal-content-grid { grid-template-columns: 1fr; }
            .modal-sidebar { border-left: none; border-top: 1px solid var(--border); padding-left: 0; padding-top: 20px; }
        }

        @media (max-width: 768px) {
            .envelope-container { padding: 16px; }
            .envelope-tabs { flex-wrap: wrap; }
            .envelope-tab { padding: 10px 16px; font-size: 12px; }
            .stats-grid { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; }
            .search-container { max-width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            .planner-grid { grid-template-columns: 1fr; }
            .header-center { display: none; }
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <img src="oberaconnect-logo.png" alt="OberaConnect" class="login-logo" onerror="this.style.display='none'">
            <h1 class="login-title">Engineering Command Center</h1>
            <p class="login-subtitle">Sign in with your OberaConnect account to continue</p>
            <button class="login-btn" id="loginBtn" onclick="signIn()">
                <svg width="20" height="20" viewBox="0 0 21 21" fill="none"><path d="M10 0H0V10H10V0Z" fill="#F25022"/><path d="M21 0H11V10H21V0Z" fill="#7FBA00"/><path d="M10 11H0V21H10V11Z" fill="#00A4EF"/><path d="M21 11H11V21H21V11Z" fill="#FFB900"/></svg>
                Sign in with Microsoft
            </button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <header class="header">
        <div class="header-left">
            <div class="logo-container">
                <div class="logo-icon">
                    <i data-feather="cpu" style="width:26px;height:26px;"></i>
                </div>
                <div>
                    <h1>Engineering Command Center</h1>
                    <span class="header-subtitle">OberaConnect Second Brain</span>
                </div>
            </div>
        </div>
        <div class="header-center">
            <button class="ai-agent-btn claude">
                <span class="ai-status active"></span>
                <i data-feather="cpu" style="width:16px;height:16px;"></i>
                Claude Agent
            </button>
            <button class="ai-agent-btn gemini">
                <span class="ai-status active"></span>
                <i data-feather="star" style="width:16px;height:16px;"></i>
                Gemini Agent
            </button>
        </div>
        <div class="header-right">
            <div class="global-search-container">
                <i data-feather="search" class="global-search-icon" style="width:16px;height:16px;"></i>
                <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Search projects, tasks, tickets...">
                <div class="search-results-dropdown" id="searchResultsDropdown">
                    <div class="search-loading" id="searchLoading" style="display:none;">
                        Searching...
                    </div>
                    <div id="searchResultsContent"></div>
                </div>
            </div>
            <div class="user-selector" style="display:flex;align-items:center;gap:8px;margin-right:16px;">
                <div class="user-avatar" id="currentUserAvatar" style="width:32px;height:32px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;">?</div>
                <select id="currentUserSelect" class="form-select" style="min-width:150px;font-size:13px;padding:6px 10px;">
                    <option value="">Select Your Name...</option>
                </select>
            </div>
            <div class="header-time" id="currentTime"></div>
            <button class="btn btn-secondary">
                <i data-feather="refresh-cw" style="width:14px;height:14px;"></i>
                Sync
            </button>
        </div>
    </header>

    <div class="envelope-container">
        <div class="envelope-tabs" role="tablist" aria-label="Main navigation tabs">
            <button class="envelope-tab active" data-tab="projects" role="tab" aria-selected="true" aria-controls="projects-panel" id="tab-projects">
                <i data-feather="folder" style="width:18px;height:18px;" aria-hidden="true"></i>
                Projects
                <span class="tab-badge" id="projects-count" aria-label="project count">0</span>
            </button>
            <button class="envelope-tab" data-tab="todos" role="tab" aria-selected="false" aria-controls="todos-panel" id="tab-todos">
                <i data-feather="check-square" style="width:18px;height:18px;" aria-hidden="true"></i>
                To-Do List
                <span class="tab-badge" id="todos-count" aria-label="todo count">0</span>
            </button>
            <button class="envelope-tab" data-tab="calendar" role="tab" aria-selected="false" aria-controls="calendar-panel" id="tab-calendar">
                <i data-feather="calendar" style="width:18px;height:18px;" aria-hidden="true"></i>
                Calendar
            </button>
            <button class="envelope-tab" data-tab="tools" role="tab" aria-selected="false" aria-controls="tools-panel" id="tab-tools">
                <i data-feather="tool" style="width:18px;height:18px;" aria-hidden="true"></i>
                Tools Index
                <span class="tab-badge" id="tools-count" aria-label="tools count">0</span>
            </button>
            <button class="envelope-tab" data-tab="timereports" role="tab" aria-selected="false" aria-controls="timereports-panel" id="tab-timereports">
                <i data-feather="clock" style="width:18px;height:18px;" aria-hidden="true"></i>
                Time Reports
            </button>
        </div>

        <div class="envelope-content">
            <!-- Projects Tab -->
            <div class="tab-panel active" id="projects-panel" role="tabpanel" aria-labelledby="tab-projects">
                <!-- Stats removed for compact view -->
                <div class="toolbar" style="margin-top:0;">
                    <div class="search-container">
                        <div class="search-box">
                            <i data-feather="search" class="search-icon" style="width:16px;height:16px;"></i>
                            <input type="text" placeholder="Search projects..." id="projectSearchInput">
                        </div>
                        <div class="filter-group">
                            <select class="filter-select" id="projectStatusFilter">
                                <option value="">Active Only</option>
                                <option value="Not Started">Not Started</option>
                                <option value="In Progress">In Progress</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                                <option value="Archived">Archived</option>
                            </select>
                            <select class="filter-select" id="projectPriorityFilter">
                                <option value="">All Priorities</option>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                            <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-secondary);cursor:pointer;margin-left:8px;">
                                <input type="checkbox" id="projectShowArchived" style="cursor:pointer;">
                                Show Archived
                            </label>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <div class="view-toggle">
                            <button class="view-btn active">
                                <i data-feather="list" style="width:14px;height:14px;"></i>
                                Cards
                            </button>
                            <button class="view-btn">
                                <i data-feather="columns" style="width:14px;height:14px;"></i>
                                Kanban
                            </button>
                        </div>
                        <div style="position:relative;">
                            <button class="export-btn" data-type="projects">
                                <i data-feather="download" style="width:14px;height:14px;"></i>
                                Export
                            </button>
                            <div class="export-dropdown" id="export-dropdown-projects">
                                <div class="export-option" data-format="excel" data-type="projects">
                                    <i data-feather="file-text" style="width:14px;height:14px;color:var(--success);"></i>
                                    Excel (.xlsx)
                                </div>
                                <div class="export-option" data-format="csv" data-type="projects">
                                    <i data-feather="file" style="width:14px;height:14px;color:var(--primary);"></i>
                                    CSV (.csv)
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary">
                            <i data-feather="plus" style="width:16px;height:16px;"></i>
                            New Project
                        </button>
                    </div>
                </div>

                <div id="projects-chat-view" class="chat-cards-container"></div>
                <div id="projects-kanban-view" class="kanban-board" style="display:none;"></div>
            </div>

            <!-- Tools Index Tab -->
            <div class="tab-panel" id="tools-panel" role="tabpanel" aria-labelledby="tab-tools">
                <div class="toolbar" style="margin-bottom:20px;">
                    <div class="search-container" style="flex:1;">
                        <div class="search-box">
                            <i data-feather="search" class="search-icon" style="width:16px;height:16px;"></i>
                            <input type="text" placeholder="Search tools..." id="toolSearchInput">
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="btn btn-secondary" id="containerSettingsBtn" style="padding:8px 12px;font-size:12px;">
                            <i data-feather="settings" style="width:14px;height:14px;"></i>
                            Container Settings
                        </button>
                        <button class="btn btn-secondary" id="refreshJobsBtn" style="padding:8px 12px;font-size:12px;">
                            <i data-feather="refresh-cw" style="width:14px;height:14px;"></i>
                            Refresh Jobs
                        </button>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 280px;gap:20px;">
                    <!-- Tools Grid -->
                    <div class="tools-categories" id="tools-container"></div>

                    <!-- Container Jobs Panel -->
                    <div style="background:var(--card-bg);border-radius:var(--radius-lg);border:1px solid var(--border);overflow:hidden;">
                        <div style="padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
                            <i data-feather="box" style="width:16px;height:16px;color:var(--primary);"></i>
                            <span style="font-weight:600;font-size:13px;">Container Jobs</span>
                            <span id="runningJobsCount" style="margin-left:auto;background:var(--primary);color:white;padding:2px 8px;border-radius:10px;font-size:11px;">0</span>
                        </div>
                        <div id="containerJobsPanel" style="max-height:400px;overflow-y:auto;">
                            <div style="color:var(--text-muted);font-size:12px;padding:16px;text-align:center;">
                                <i data-feather="inbox" style="width:24px;height:24px;margin-bottom:8px;opacity:0.5;"></i>
                                <div>No container jobs yet</div>
                                <div style="font-size:11px;margin-top:4px;">Click "Run in Container" on any tool</div>
                            </div>
                        </div>
                        <div style="padding:12px;border-top:1px solid var(--border);background:var(--bg);">
                            <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted);">
                                <span id="containerGatewayStatus" style="width:8px;height:8px;border-radius:50%;background:var(--text-muted);"></span>
                                <span id="containerGatewayUrl">Gateway: localhost:8080</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Reports Tab -->
            <div class="tab-panel" id="timereports-panel" role="tabpanel" aria-labelledby="tab-timereports">
                <div class="toolbar" style="margin-bottom:20px;">
                    <div class="search-container" style="flex:1;display:flex;gap:12px;align-items:center;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <label for="timeReportStartDate" style="font-size:13px;color:var(--text-secondary);">From:</label>
                            <input type="date" id="timeReportStartDate" class="form-input" style="width:auto;">
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <label for="timeReportEndDate" style="font-size:13px;color:var(--text-secondary);">To:</label>
                            <input type="date" id="timeReportEndDate" class="form-input" style="width:auto;">
                        </div>
                        <select id="timeReportEmployee" class="filter-select">
                            <option value="">All Employees</option>
                        </select>
                        <select id="timeReportProject" class="filter-select">
                            <option value="">All Projects/Tickets</option>
                        </select>
                        <button class="btn btn-secondary" onclick="applyTimeReportFilters()">
                            <i data-feather="filter" style="width:14px;height:14px;"></i>
                            Apply
                        </button>
                    </div>
                    <!-- Sync indicator for offline changes -->
                    <div id="syncIndicator" style="display:none;align-items:center;gap:8px;padding:4px 12px;background:var(--warning-light);border-radius:6px;margin-right:12px;"></div>
                    <button class="btn btn-primary" onclick="showTimeEntryModal()">
                        <i data-feather="plus" style="width:16px;height:16px;"></i>
                        Log Time
                    </button>
                </div>

                <!-- Time Report Summary Cards -->
                <div class="time-report-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalHoursWorked">0</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:var(--success);" id="billableHoursTotal">0</div>
                        <div class="stat-label">Billable Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:var(--primary);" id="billableAmount">$0</div>
                        <div class="stat-label">Billable Amount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="utilizationRate">0%</div>
                        <div class="stat-label">Utilization</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="uniqueEmployees">0</div>
                        <div class="stat-label">Team Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="projectsCovered">0</div>
                        <div class="stat-label">Projects</div>
                    </div>
                </div>

                <!-- Time Report Charts -->
                <div id="timeReportCharts" style="margin-bottom:24px;">
                    <div style="background:white;border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow-sm);border:1px solid var(--border);">
                        <h3 style="font-size:16px;font-weight:600;margin-bottom:15px;color:var(--text-primary);">Hours by Work Type</h3>
                        <canvas id="hoursByWorkTypeChart"></canvas>
                    </div>
                </div>

                <!-- Time Report Views Toggle -->
                <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                    <button class="btn btn-secondary time-view-btn active" data-view="byEmployee" onclick="setTimeReportView('byEmployee')">
                        <i data-feather="users" style="width:14px;height:14px;"></i>
                        By Employee
                    </button>
                    <button class="btn btn-secondary time-view-btn" data-view="byProject" onclick="setTimeReportView('byProject')">
                        <i data-feather="folder" style="width:14px;height:14px;"></i>
                        By Project
                    </button>
                    <button class="btn btn-secondary time-view-btn" data-view="byTask" onclick="setTimeReportView('byTask')">
                        <i data-feather="check-square" style="width:14px;height:14px;"></i>
                        By Task
                    </button>
                    <button class="btn btn-secondary time-view-btn" data-view="entries" onclick="setTimeReportView('entries')">
                        <i data-feather="list" style="width:14px;height:14px;"></i>
                        All Entries
                    </button>
                    <button class="btn btn-secondary time-view-btn" data-view="billing" onclick="setTimeReportView('billing')" style="background:var(--success);color:white;">
                        <i data-feather="dollar-sign" style="width:14px;height:14px;"></i>
                        Billing Summary
                    </button>
                    <div style="flex:1;"></div>
                    <button class="export-btn" onclick="exportTimeReport()" title="Export to CSV">
                        <i data-feather="download" style="width:14px;height:14px;"></i>
                        Export
                    </button>
                </div>

                <!-- Time Report Content -->
                <div id="timeReportContent" class="time-report-content">
                    <div class="empty-state" style="padding:60px;text-align:center;">
                        <i data-feather="clock" style="width:48px;height:48px;color:var(--text-muted);margin-bottom:16px;"></i>
                        <h3 style="color:var(--text);margin-bottom:8px;">No Time Entries Yet</h3>
                        <p style="color:var(--text-muted);margin-bottom:20px;">Start logging time to see reports here</p>
                        <button class="btn btn-primary" onclick="showTimeEntryModal()">
                            <i data-feather="plus" style="width:16px;height:16px;"></i>
                            Log Your First Entry
                        </button>
                    </div>
                </div>
            </div>

            <!-- To-Do List Tab -->
            <div class="tab-panel" id="todos-panel" role="tabpanel" aria-labelledby="tab-todos">
                <div class="todos-header" style="display:flex;justify-content:space-between;align-items:center;padding:16px 0;margin-bottom:12px;">
                    <h2 style="font-size:18px;font-weight:600;color:var(--text-primary);">Tasks by Assignee</h2>
                    <div style="position:relative;">
                        <button class="export-btn" data-type="todos">
                            <i data-feather="download" style="width:14px;height:14px;"></i>
                            Export
                        </button>
                        <div class="export-dropdown" id="export-dropdown-todos">
                            <div class="export-option" data-format="excel" data-type="todos">
                                <i data-feather="file-text" style="width:14px;height:14px;color:var(--success);"></i>
                                Excel (.xlsx)
                            </div>
                            <div class="export-option" data-format="csv" data-type="todos">
                                <i data-feather="file" style="width:14px;height:14px;color:var(--primary);"></i>
                                CSV (.csv)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="quick-add">
                    <div class="quick-add-title">Quick Add Task</div>
                    <div class="quick-add-form">
                        <input type="text" class="quick-add-input" id="quickAddInput" placeholder="What needs to be done?">
                        <select class="filter-select" id="quickAddAssignee">
                            <option value="">Assign to...</option>
                        </select>
                        <button class="btn btn-primary">
                            <i data-feather="plus" style="width:16px;height:16px;"></i>
                            Add
                        </button>
                    </div>
                </div>

                <div class="assignee-sections" id="assignee-sections"></div>
            </div>

            <!-- Calendar Tab -->
            <div class="tab-panel" id="calendar-panel" role="tabpanel" aria-labelledby="tab-calendar">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="calendarPrev">
                            <i data-feather="chevron-left" style="width:20px;height:20px;"></i>
                        </button>
                        <h2 class="calendar-title" id="calendarTitle">November 2025</h2>
                        <button class="calendar-nav-btn" id="calendarNext">
                            <i data-feather="chevron-right" style="width:20px;height:20px;"></i>
                        </button>
                    </div>
                    <div class="calendar-actions">
                        <button class="btn btn-secondary" id="calendarToday">Today</button>
                        <div class="calendar-filter">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="calShowProjects" checked>
                                <span class="filter-dot" style="background:var(--primary);"></span>
                                Projects
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="calShowTickets" checked>
                                <span class="filter-dot" style="background:var(--warning);"></span>
                                Tickets
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="calShowTasks" checked>
                                <span class="filter-dot" style="background:var(--success);"></span>
                                Tasks
                            </label>
                        </div>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">Sun</div>
                        <div class="calendar-weekday">Mon</div>
                        <div class="calendar-weekday">Tue</div>
                        <div class="calendar-weekday">Wed</div>
                        <div class="calendar-weekday">Thu</div>
                        <div class="calendar-weekday">Fri</div>
                        <div class="calendar-weekday">Sat</div>
                    </div>
                    <div class="calendar-days" id="calendarDays"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Panel -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <div class="ai-panel-title">
                <i data-feather="cpu" style="width:20px;height:20px;"></i>
                <span id="aiPanelTitle">AI Assistant</span>
            </div>
            <button class="ai-panel-close">
                <i data-feather="x" style="width:18px;height:18px;"></i>
            </button>
        </div>
        <div class="ai-panel-body">
            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="ai-message assistant">
                    <div class="ai-message-avatar">
                        <i data-feather="cpu" style="width:16px;height:16px;"></i>
                    </div>
                    <div class="ai-message-content">
                        Hello! I'm your AI assistant. I can help you:
                        <ul style="margin:8px 0 0 16px;font-size:13px;">
                            <li>Summarize overdue tasks</li>
                            <li>Analyze ticket trends</li>
                            <li>Generate meeting schedules</li>
                            <li>Create project templates</li>
                            <li>Automate reminders</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="ai-panel-input">
            <textarea class="ai-input" id="aiInput" placeholder="Ask me anything..." rows="2"></textarea>
            <button class="ai-send-btn">
                <i data-feather="send" style="width:18px;height:18px;"></i>
            </button>
        </div>
    </div>

    <!-- Tool Detail Modal -->
    <div class="modal-overlay" id="toolModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="toolModalTitle">Tool Name</h2>
                <button class="modal-close">
                    <i data-feather="x" style="width:18px;height:18px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentToolName">
                <div style="margin-bottom:16px;">
                    <span class="chat-tag" style="background:var(--primary);color:white;" id="toolModalCategory">Category</span>
                </div>
                <p style="color:var(--text-secondary);margin-bottom:20px;line-height:1.6;" id="toolModalDesc">Tool description</p>
                <div id="toolModalDetails" style="background:var(--surface-dark);border-radius:var(--radius-md);padding:16px;"></div>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-secondary">
                        <i data-feather="code" style="width:14px;height:14px;"></i> View Code
                    </button>
                    <button class="btn btn-secondary">
                        <i data-feather="book-open" style="width:14px;height:14px;"></i> Docs
                    </button>
                </div>
                <button class="btn btn-primary">
                    <i data-feather="play" style="width:14px;height:14px;"></i> Run Tool
                </button>
            </div>
        </div>
    </div>

    <!-- Detail Modal with Comments -->
    <div class="modal-overlay" id="modal" role="presentation">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Item Details</h2>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="history-btn" id="modalHistoryBtn" title="View Version History" aria-label="View version history">
                        <i data-feather="clock" style="width:16px;height:16px;" aria-hidden="true"></i>
                    </button>
                    <button class="modal-close" aria-label="Close dialog">
                        <i data-feather="x" style="width:18px;height:18px;" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-content-grid">
                    <div class="modal-main">
                        <input type="hidden" id="itemId">
                        <input type="hidden" id="itemType">

                        <div class="form-group">
                            <label class="form-label" for="itemName">Title <span class="required" aria-hidden="true">*</span></label>
                            <input type="text" class="form-input" id="itemName" placeholder="Enter title..." aria-required="true" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="itemDescription">Description</label>
                            <textarea class="form-textarea" id="itemDescription" placeholder="Describe the item..."></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="itemStatus">Status</label>
                                <select class="form-select" id="itemStatus">
                                    <option value="Not Started">Not Started</option>
                                    <option value="Open">Open</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Resolved">Resolved</option>
                                    <option value="Closed">Closed</option>
                                    <option value="Archived">Archived</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="itemPriority">Priority</label>
                                <select class="form-select" id="itemPriority">
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="itemAssignee">Assigned To</label>
                                <select class="form-select" id="itemAssignee">
                                    <option value="">Unassigned</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="itemTeam">Team</label>
                                <select class="form-select" id="itemTeam">
                                    <option value="Engineering">Engineering</option>
                                    <option value="Network">Network</option>
                                    <option value="Security">Security</option>
                                    <option value="Support">Support</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="itemCustomer">Customer</label>
                                <input type="text" class="form-input" id="itemCustomer" placeholder="Customer name...">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="itemDueDate">Due Date</label>
                                <input type="date" class="form-input" id="itemDueDate">
                            </div>
                        </div>

                        <!-- PROJECT-SPECIFIC FIELDS -->
                        <div id="projectFields" style="display:none;">
                            <div style="border-top: 1px solid var(--border); margin: 20px 0; padding-top: 15px;">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i data-feather="folder" style="width:18px;height:18px;color:var(--primary);"></i>
                                    Project Details
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="projectStartDate">Start Date</label>
                                        <input type="date" class="form-input" id="projectStartDate">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="projectEndDate">End Date</label>
                                        <input type="date" class="form-input" id="projectEndDate">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="projectPercent">% Complete</label>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="range" id="projectPercent" min="0" max="100" value="0" style="flex:1;">
                                            <span id="percentLabel" style="min-width: 45px; font-weight: 600; color: var(--primary);">0%</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="projectBudgetHours">Budget Hours</label>
                                        <input type="number" class="form-input" id="projectBudgetHours" placeholder="0" min="0">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="projectHoursSpent">Hours Spent</label>
                                        <input type="number" class="form-input" id="projectHoursSpent" placeholder="0" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="projectNumber">Project Number</label>
                                        <input type="text" class="form-input" id="projectNumber" placeholder="Auto-generated" readonly style="background: var(--bg-tertiary);">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="projectMilestones">SOW</label>
                                    <textarea class="form-textarea" id="projectMilestones" placeholder="Statement of Work details..." rows="2"></textarea>
                                </div>
                            </div>

                            <!-- TASKS PANEL IN PROJECT MODAL -->
                            <div style="border-top: 1px solid var(--border); margin: 20px 0; padding-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div style="font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px;">
                                        <i data-feather="check-square" style="width:18px;height:18px;color:var(--success);"></i>
                                        Project Tasks
                                    </div>
                                    <button type="button" class="btn btn-secondary" style="padding:6px 12px;font-size:12px;">
                                        <i data-feather="plus" style="width:14px;height:14px;"></i> Add Task
                                    </button>
                                </div>
                                <div id="projectTasksList" style="max-height:250px;overflow-y:auto;">
                                    <!-- Task rows will be added here -->
                                    <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;" id="noTasksMessage">
                                        No tasks yet. Click "Add Task" to create tasks for this project.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TICKET-SPECIFIC FIELDS -->
                        <div id="ticketFields" style="display:none;">
                            <div style="border-top: 1px solid var(--border); margin: 20px 0; padding-top: 15px;">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i data-feather="tag" style="width:18px;height:18px;color:var(--warning);"></i>
                                    Ticket Details
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="ticketNumber">Ticket #</label>
                                        <input type="text" class="form-input" id="ticketNumber" placeholder="Auto-generated" readonly style="background: var(--bg-tertiary);">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="ticketSource">Source</label>
                                        <select class="form-select" id="ticketSource">
                                            <option value="Portal">Portal</option>
                                            <option value="Email">Email</option>
                                            <option value="Phone">Phone</option>
                                            <option value="Teams">Teams</option>
                                            <option value="Internal">Internal</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="ticketUrgency">Urgency</label>
                                        <select class="form-select" id="ticketUrgency">
                                            <option value="Low">Low</option>
                                            <option value="Medium" selected>Medium</option>
                                            <option value="High">High</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="ticketSLA">SLA Status</label>
                                        <select class="form-select" id="ticketSLA">
                                            <option value="N/A">N/A</option>
                                            <option value="On Track">On Track</option>
                                            <option value="At Risk">At Risk</option>
                                            <option value="Breached">Breached</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="ticketTimeSpent">Time Spent</label>
                                        <input type="text" class="form-input" id="ticketTimeSpent" placeholder="e.g., 2h 30m">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="ticketRelatedProject">Related Project</label>
                                        <select class="form-select" id="ticketRelatedProject">
                                            <option value="">None</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="ticketResolution">Resolution Notes</label>
                                    <textarea class="form-textarea" id="ticketResolution" placeholder="How was this resolved?" rows="2"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Attachments Section -->
                        <div class="attachments-section">
                            <div class="attachments-title">
                                <i data-feather="paperclip" style="width:18px;height:18px;color:var(--primary);"></i>
                                Attachments
                            </div>
                            <div class="attachment-dropzone" id="attachmentDropzone">
                                <div class="attachment-dropzone-icon">
                                    <i data-feather="upload-cloud" style="width:32px;height:32px;"></i>
                                </div>
                                <div class="attachment-dropzone-text">
                                    Drag files here or <strong>click to upload</strong>
                                </div>
                                <div class="attachment-dropzone-hint">Max file size: 10MB</div>
                                <input type="file" id="attachmentFileInput" style="display:none;" multiple>
                            </div>
                            <div class="attachment-list" id="attachmentList">
                                <div class="attachment-loading">Loading attachments...</div>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="comments-section">
                            <div class="comments-title">
                                <i data-feather="message-circle" style="width:18px;height:18px;"></i>
                                Comments
                            </div>
                            <div class="comments-list" id="commentsList"></div>
                            <div class="comment-input-container">
                                <textarea class="comment-input" id="commentInput" placeholder="Add a comment..." rows="2"></textarea>
                                <button class="comment-send">
                                    <i data-feather="send" style="width:16px;height:16px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="modal-sidebar">
                        <div class="activity-section">
                            <div class="activity-title">Activity Log</div>
                            <div class="activity-list" id="activityList">
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i data-feather="plus" style="width:12px;height:12px;color:var(--success);"></i>
                                    </div>
                                    <div>
                                        <div class="activity-text"><strong>Jeremy Smith</strong> created this item</div>
                                        <div class="activity-time">2 hours ago</div>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i data-feather="edit" style="width:12px;height:12px;color:var(--primary);"></i>
                                    </div>
                                    <div>
                                        <div class="activity-text">Status changed to <strong>In Progress</strong></div>
                                        <div class="activity-time">1 hour ago</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="itemNotes" placeholder="Additional notes..." rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary">Cancel</button>
                <button class="btn btn-primary">
                    <i data-feather="save" style="width:14px;height:14px;"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Version History Panel -->
    <div class="version-history-panel" id="versionHistoryPanel">
        <div class="version-panel-header">
            <div class="version-panel-title">
                <i data-feather="clock" style="width:20px;height:20px;color:var(--primary);"></i>
                Version History
            </div>
            <button class="version-panel-close" id="closeVersionPanel">
                <i data-feather="x" style="width:18px;height:18px;"></i>
            </button>
        </div>
        <div class="version-panel-body">
            <div class="version-list" id="versionList">
                <div class="version-loading">Loading version history...</div>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal with Tasks -->
    <div class="modal-overlay" id="projectDetailModal">
        <div class="modal detail-modal">
            <div class="modal-header">
                <div style="display:flex;align-items:center;gap:12px;">
                    <h2 class="modal-title" id="projectDetailTitle">Project Details</h2>
                    <span id="projectDetailStatus" class="chat-tag" style="background:var(--primary);color:white;">Status</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="btn btn-secondary" onclick="editProjectFromDetail()">
                        <i data-feather="edit" style="width:14px;height:14px;"></i> Edit
                    </button>
                    <button class="modal-close" onclick="closeProjectDetailModal()">
                        <i data-feather="x" style="width:18px;height:18px;"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="detail-content">
                    <!-- Left Sidebar: Project Info -->
                    <div class="detail-sidebar">
                        <div class="detail-section">
                            <div class="detail-section-title">
                                <i data-feather="info" style="width:16px;height:16px;color:var(--primary);"></i>
                                Project Info
                            </div>
                            <div id="projectDetailInfo"></div>
                        </div>

                        <div class="detail-section">
                            <div class="detail-section-title">
                                <i data-feather="pie-chart" style="width:16px;height:16px;color:var(--success);"></i>
                                Progress
                            </div>
                            <div id="projectDetailProgress" style="text-align:center;padding:16px;"></div>
                        </div>

                        <div class="detail-section">
                            <div class="detail-section-title">
                                <i data-feather="tag" style="width:16px;height:16px;color:var(--warning);"></i>
                                Linked Ticket
                            </div>
                            <div id="projectLinkedTicketInfo"></div>
                        </div>
                    </div>

                    <!-- Main Content: Tasks & Documentation -->
                    <div class="detail-main">
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <div class="detail-section-title">
                                    <i data-feather="check-square" style="width:18px;height:18px;color:var(--primary);"></i>
                                    Tasks
                                </div>
                                <button class="btn btn-primary" style="padding:8px 14px;font-size:12px;">
                                    <i data-feather="plus" style="width:14px;height:14px;"></i> Add Task
                                </button>
                            </div>
                            <div class="tasks-kanban" id="projectTasksKanban">
                                <!-- Tasks columns will be rendered here -->
                            </div>
                        </div>

                        <div class="detail-section">
                            <div class="detail-section-header">
                                <div class="detail-section-title">
                                    <i data-feather="file-text" style="width:18px;height:18px;color:var(--secondary);"></i>
                                    Documentation Log
                                </div>
                            </div>
                            <div class="doc-log" id="projectDocLog">
                                <!-- Documentation entries will be rendered here -->
                            </div>
                            <div class="doc-input-container">
                                <textarea class="doc-input" id="projectDocInput" placeholder="Add a documentation note..." rows="2"></textarea>
                                <button class="btn btn-primary" style="padding:10px 16px;">
                                    <i data-feather="plus" style="width:14px;height:14px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h2 class="modal-title">Add New Task</h2>
                <button class="modal-close">
                    <i data-feather="x" style="width:18px;height:18px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="add-task-form">
                    <div class="form-group">
                        <label class="form-label">Task Title <span class="required">*</span></label>
                        <input type="text" class="form-input" id="newTaskTitle" placeholder="Enter task title...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="newTaskDesc" placeholder="Task description..." rows="2"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="newTaskPriority">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Assigned To</label>
                            <select class="form-select" id="newTaskAssignee">
                                <option value="">Unassigned</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="newTaskStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="newTaskDueDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Estimated Hours</label>
                            <input type="number" class="form-input" id="newTaskHours" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stage / Phase</label>
                            <select class="form-select" id="newTaskPhase">
                                <option value="Planning">Planning</option>
                                <option value="Design">Design</option>
                                <option value="Development">Development</option>
                                <option value="Testing">Testing</option>
                                <option value="Deployment">Deployment</option>
                                <option value="Execution" selected>Execution</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary">Cancel</button>
                <button class="btn btn-primary">
                    <i data-feather="plus" style="width:14px;height:14px;"></i>
                    Create Task
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <span class="bulk-selected-count">
            <i data-feather="check-square" style="width:16px;height:16px;"></i>
            <span id="bulkSelectedCount">0</span> selected
        </span>
        <button class="bulk-btn primary" onclick="openBulkEditModal()">
            <i data-feather="edit-2" style="width:14px;height:14px;"></i>
            Edit
        </button>
        <button class="bulk-btn secondary" onclick="bulkChangeStatus()">
            <i data-feather="refresh-cw" style="width:14px;height:14px;"></i>
            Change Status
        </button>
        <button class="bulk-btn secondary" onclick="bulkChangeAssignee()">
            <i data-feather="user" style="width:14px;height:14px;"></i>
            Assign
        </button>
        <button class="bulk-close" onclick="clearBulkSelection()">
            <i data-feather="x" style="width:18px;height:18px;"></i>
        </button>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal-overlay" id="bulkEditModal">
        <div class="modal bulk-edit-modal" style="max-width:500px;">
            <div class="modal-header">
                <h2 class="modal-title">Bulk Edit <span id="bulkEditCount">0</span> Items</h2>
                <button class="modal-close" onclick="closeBulkEditModal()">
                    <i data-feather="x" style="width:18px;height:18px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="color:var(--text-secondary);margin-bottom:20px;font-size:13px;">
                    Check the fields you want to update. Only checked fields will be modified.
                </p>

                <div class="form-group">
                    <div class="bulk-field-toggle">
                        <input type="checkbox" id="bulkUpdateStatus">
                        <label class="form-label" style="margin:0;">Status</label>
                    </div>
                    <select class="form-select" id="bulkStatus" disabled>
                        <option value="Not Started">Not Started</option>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="bulk-field-toggle">
                        <input type="checkbox" id="bulkUpdatePriority">
                        <label class="form-label" style="margin:0;">Priority</label>
                    </div>
                    <select class="form-select" id="bulkPriority" disabled>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="bulk-field-toggle">
                        <input type="checkbox" id="bulkUpdateAssignee">
                        <label class="form-label" style="margin:0;">Assigned To</label>
                    </div>
                    <select class="form-select" id="bulkAssignee" disabled>
                        <option value="">Unassigned</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="bulk-field-toggle">
                        <input type="checkbox" id="bulkUpdateTeam">
                        <label class="form-label" style="margin:0;">Team</label>
                    </div>
                    <select class="form-select" id="bulkTeam" disabled>
                        <option value="Engineering">Engineering</option>
                        <option value="Network">Network</option>
                        <option value="Security">Security</option>
                        <option value="Support">Support</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="bulk-field-toggle">
                        <input type="checkbox" id="bulkUpdateDueDate">
                        <label class="form-label" style="margin:0;">Due Date</label>
                    </div>
                    <input type="date" class="form-input" id="bulkDueDate" disabled>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBulkEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="applyBulkEdit()">
                    <i data-feather="check" style="width:14px;height:14px;"></i>
                    Apply Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Time Entry Modal -->
    <div class="modal-overlay" id="timeEntryModal">
        <div class="modal" style="max-width:500px;" role="dialog" aria-modal="true" aria-labelledby="timeEntryModalTitle">
            <div class="modal-header">
                <h2 class="modal-title" id="timeEntryModalTitle">
                    <i data-feather="clock" style="width:20px;height:20px;color:var(--primary);"></i>
                    Log Time Entry
                </h2>
                <button class="modal-close" onclick="closeTimeEntryModal()" aria-label="Close modal">
                    <i data-feather="x" style="width:18px;height:18px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="timeEntryId">

                <div class="form-group">
                    <label class="form-label" for="timeEntryEmployee">Employee <span class="required">*</span></label>
                    <select class="form-select" id="timeEntryEmployee" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="timeEntryDate">Date <span class="required">*</span></label>
                        <input type="date" class="form-input" id="timeEntryDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="timeEntryHours">Hours <span class="required">*</span></label>
                        <input type="number" class="form-input" id="timeEntryHours" min="0.25" max="24" step="0.25" placeholder="0.00" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="timeEntryType">Work Type</label>
                    <select class="form-select" id="timeEntryType">
                        <option value="Project">Project Work</option>
                        <option value="Ticket">Ticket/Support</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Admin">Administrative</option>
                        <option value="Training">Training</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="timeEntryProject">Project/Ticket</label>
                    <select class="form-select" id="timeEntryProject" onchange="updateTaskDropdown()">
                        <option value="">None (General)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="timeEntryTask">Task (Optional)</label>
                    <select class="form-select" id="timeEntryTask">
                        <option value="">No Task Selected</option>
                    </select>
                    <small style="color:var(--text-muted);font-size:11px;margin-top:4px;display:block;">Select a project first to see linked tasks</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="timeEntryDescription">Description</label>
                    <textarea class="form-textarea" id="timeEntryDescription" rows="3" placeholder="What did you work on?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="timeEntryBillable">
                        <input type="checkbox" id="timeEntryBillable" checked style="margin-right:8px;">
                        Billable Time
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTimeEntryModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTimeEntry()">
                    <i data-feather="save" style="width:14px;height:14px;"></i>
                    Save Entry
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            siteId: 'oberaconnect.sharepoint.com,3894a9a1-76ac-4955-88b2-a1d335f35f78,522e18b4-c876-4c61-b74b-53adb0e6ddef',
            projectsListId: 'a310c2d1-634f-44d0-862b-6750bf8788ce',
            ticketsListId: 'd135fb01-4f30-429d-94ad-b908a0c6a9f7',
            tasksListId: '92c85920-31bd-49ae-a4ae-8cee71ee5f39',
            timeEntriesListId: null, // Will be discovered dynamically
            accessToken: null,     // Managed by MSAL
            // Aliases for backwards compatibility with uppercase references
            get SITE_ID() { return this.siteId; },
            get PROJECTS_LIST_ID() { return this.projectsListId; },
            get TICKETS_LIST_ID() { return this.ticketsListId; },
            get TASKS_LIST_ID() { return this.tasksListId; },
            get TIME_ENTRIES_LIST_ID() { return this.timeEntriesListId; },
            get ACCESS_TOKEN() { return this.accessToken; }
        };

        const GRAPH_API = 'https://graph.microsoft.com/v1.0';

        // ========================================
        // SECURITY UTILITIES
        // ========================================

        // HTML escape function to prevent XSS attacks
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Safe HTML attribute escaping
        function escapeAttr(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            })[m]);
        }

        // ========================================
        // ERROR HANDLING & NOTIFICATIONS
        // ========================================

        // Toast notification system for user feedback
        function showNotification(message, type = 'info', duration = 5000) {
            // Remove existing notifications
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'polite');
            toast.innerHTML = `
                <span class="toast-icon">${type === 'error' ? '' : type === 'success' ? '' : ''}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
                <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Close notification"></button>
            `;
            document.body.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => toast.remove(), duration);
        }

        // ========================================
        // FETCH WITH RETRY & RATE LIMITING
        // ========================================

        // Sleep utility for retry delays
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Fetch with automatic retry and rate limit handling
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            let lastError;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);

                    // Handle rate limiting (429)
                    if (response.status === 429) {
                        const retryAfter = parseInt(response.headers.get('Retry-After') || '1', 10);
                        const delayMs = Math.min(retryAfter * 1000, 60000); // Max 60 seconds
                        console.warn(`Rate limited. Retrying after ${delayMs}ms (attempt ${attempt + 1}/${maxRetries})`);
                        showNotification('API rate limit reached. Retrying...', 'warning');
                        await sleep(delayMs);
                        continue;
                    }

                    // Handle server errors with retry
                    if (response.status >= 500 && attempt < maxRetries - 1) {
                        const delayMs = Math.pow(2, attempt) * 1000; // Exponential backoff
                        console.warn(`Server error ${response.status}. Retrying after ${delayMs}ms`);
                        await sleep(delayMs);
                        continue;
                    }

                    return response;
                } catch (error) {
                    lastError = error;

                    // Network errors - retry with exponential backoff
                    if (attempt < maxRetries - 1) {
                        const delayMs = Math.pow(2, attempt) * 1000;
                        console.warn(`Network error. Retrying after ${delayMs}ms (attempt ${attempt + 1}/${maxRetries})`);
                        await sleep(delayMs);
                        continue;
                    }
                }
            }

            // All retries failed
            throw lastError || new Error('Request failed after retries');
        }

        // ========================================
        // INPUT VALIDATION
        // ========================================

        function validateItemFields(fields, type) {
            const errors = [];

            // Title validation
            const titleField = type === 'projects' ? 'Title' : 'TicketTitle';
            if (!fields[titleField] || fields[titleField].trim() === '') {
                errors.push('Title is required');
            } else if (fields[titleField].length > 255) {
                errors.push('Title must be 255 characters or less');
            }

            // Description validation
            if (fields.Description && fields.Description.length > 10000) {
                errors.push('Description must be 10,000 characters or less');
            }

            // Date validation
            if (fields.DueDate) {
                const date = new Date(fields.DueDate);
                if (isNaN(date.getTime())) {
                    errors.push('Invalid due date format');
                }
            }

            // Percentage validation
            if (fields.PercentComplete !== undefined && fields.PercentComplete !== '') {
                const pct = parseInt(fields.PercentComplete, 10);
                if (isNaN(pct) || pct < 0 || pct > 100) {
                    errors.push('Percentage must be between 0 and 100');
                }
            }

            // Budget validation
            if (fields.Budget !== undefined && fields.Budget !== '') {
                const budget = parseFloat(fields.Budget);
                if (isNaN(budget) || budget < 0) {
                    errors.push('Budget must be a positive number');
                }
            }

            return errors;
        }

        function validateCommentText(text) {
            if (!text || text.trim() === '') {
                return 'Comment cannot be empty';
            }
            if (text.length > 2000) {
                return 'Comment must be 2000 characters or less';
            }
            return null;
        }

        /**
         * Check if a project can be archived (all tasks must be complete)
         * @param {string} projectId - The project ID to check
         * @returns {object} { canArchive: boolean, reason: string, incompleteTasks: array }
         */
        function canArchiveProject(projectId) {
            // Find linked ticket for this project
            const linkedTicket = ticketsData.find(t =>
                String(t.fields?.ProjectID) === String(projectId) ||
                String(t.fields?.RelatedProject) === String(projectId)
            );

            if (!linkedTicket) {
                // No linked ticket means no tasks - can archive
                return { canArchive: true, reason: '', incompleteTasks: [] };
            }

            // Find all tasks linked to this ticket
            const projectTasks = tasksData.filter(task =>
                String(task.fields?.TicketID) === String(linkedTicket.id)
            );

            if (projectTasks.length === 0) {
                // No tasks - can archive
                return { canArchive: true, reason: '', incompleteTasks: [] };
            }

            // Check for incomplete tasks
            const completedStatuses = ['Done', 'Completed', 'Closed'];
            const incompleteTasks = projectTasks.filter(task =>
                !completedStatuses.includes(task.fields?.Status)
            );

            if (incompleteTasks.length > 0) {
                const taskNames = incompleteTasks.slice(0, 3).map(t => t.fields?.TaskTitle || 'Untitled').join(', ');
                const moreCount = incompleteTasks.length > 3 ? ` and ${incompleteTasks.length - 3} more` : '';
                return {
                    canArchive: false,
                    reason: `Cannot archive: ${incompleteTasks.length} task(s) not complete (${taskNames}${moreCount})`,
                    incompleteTasks
                };
            }

            return { canArchive: true, reason: '', incompleteTasks: [] };
        }

        // Safe wrapper for Feather icons - handles case where library hasn't loaded
        function safeFeatherReplace() {
            if (typeof feather !== 'undefined' && feather.replace) {
                try {
                    feather.replace();
                } catch (e) {
                    console.warn('Feather icons replace failed:', e);
                }
            } else {
                console.warn('Feather library not loaded yet');
            }
        }

        // MSAL Configuration for user authentication
        const msalConfig = {
            auth: {
                clientId: '2527689c-fd5b-47d6-820c-45e4157f9a4f',
                authority: 'https://login.microsoftonline.com/ad6cfe8e-bf9d-4bb0-bfd7-05058c2c69dd',
                redirectUri: window.location.origin,
                postLogoutRedirectUri: window.location.origin
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = {
            scopes: ['User.Read', 'Sites.ReadWrite.All']
        };

        let msalInstance = null;
        let isAuthenticated = false;

        // Initialize MSAL
        async function initializeMsal() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();

                // Handle redirect response
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    await handleLoginResponse(response);
                } else {
                    // Check for existing session
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        await silentLogin(accounts[0]);
                    }
                }
            } catch (error) {
                console.error('MSAL initialization error:', error);
                showLoginError('Failed to initialize authentication');
            }
        }

        async function signIn() {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>Signing in...</span>';

            try {
                await msalInstance.loginRedirect(loginRequest);
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Sign in failed. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 21 21" fill="none"><path d="M10 0H0V10H10V0Z" fill="#F25022"/><path d="M21 0H11V10H21V0Z" fill="#7FBA00"/><path d="M10 11H0V21H10V11Z" fill="#00A4EF"/><path d="M21 11H11V21H21V11Z" fill="#FFB900"/></svg> Sign in with Microsoft';
            }
        }

        async function silentLogin(account) {
            try {
                const response = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account: account
                });
                await handleLoginResponse(response);
            } catch (error) {
                console.log('Silent login failed, showing login screen');
            }
        }

        async function handleLoginResponse(response) {
            if (!response || !response.account) return;

            const userEmail = response.account.username.toLowerCase();
            const allowedEmails = ALLOWED_USERS.map(u => u.mail.toLowerCase());

            if (!allowedEmails.includes(userEmail)) {
                showLoginError(`Access denied. ${response.account.name} is not authorized to use this application.`);
                await msalInstance.logoutRedirect();
                return;
            }

            // User is authorized
            isAuthenticated = true;
            CONFIG.accessToken = response.accessToken;
            currentUser = {
                displayName: response.account.name,
                mail: response.account.username
            };

            // Hide login overlay and show app
            document.getElementById('loginOverlay').classList.add('hidden');
            console.log('Logged in as:', currentUser.displayName);

            // Show user info in header
            showUserInfo();

            // Initialize the app
            console.log('Initializing app after login...');
            loadADUsers();
            renderPlanner();
            console.log('About to call loadData()...');
            try {
                await loadData();
            } catch (err) {
                console.error('loadData() threw an error:', err);
            }
        }

        function showUserInfo() {
            const headerRight = document.querySelector('.header-right');
            if (headerRight) {
                const userInfoHtml = `
                    <div class="user-info" id="userInfoDisplay">
                        <div class="user-avatar">${getInitials(currentUser.displayName)}</div>
                        <span class="user-name">${currentUser.displayName}</span>
                        <button class="logout-btn" onclick="signOut()" title="Sign out">
                            <i data-feather="log-out" style="width:16px;height:16px;"></i>
                        </button>
                    </div>
                `;
                headerRight.insertAdjacentHTML('beforeend', userInfoHtml);
                safeFeatherReplace();
            }
        }

        async function signOut() {
            if (msalInstance) {
                await msalInstance.logoutRedirect();
            }
        }

        async function getAccessToken() {
            if (!msalInstance) return CONFIG.accessToken;

            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) return CONFIG.accessToken;

            try {
                const response = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account: accounts[0]
                });
                CONFIG.accessToken = response.accessToken;
                return response.accessToken;
            } catch (error) {
                console.error('Token refresh error:', error);
                return CONFIG.accessToken;
            }
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        // Engineering Team Members - Also used for access control
        const ALLOWED_USERS = [
            { displayName: 'Jim Boudreaux', mail: 'jim.boudreaux@oberaconnect.com' },
            { displayName: 'Samuel Blake', mail: 'samuel.blake@oberaconnect.com' },
            { displayName: 'Jeremy Smith', mail: 'jeremy.smith@oberaconnect.com' },
            { displayName: 'Philip Durant', mail: 'philip.durant@oberaconnect.com' }
        ];
        const FALLBACK_USERS = ALLOWED_USERS;

        // State
        let currentTab = 'projects';
        let currentViews = { projects: 'chat', tickets: 'chat' };
        let projectsData = [];
        let ticketsData = [];
        let tasksData = [];
        let timeEntriesData = []; // Time entries for employee hours tracking
        let commentsData = {};
        let documentationLogs = {}; // Store documentation logs per ticket
        let currentWeekStart = getWeekStart(new Date());
        let currentAIAgent = 'claude';
        let adUsers = []; // Azure AD users for AssignedTo dropdown
        let currentUser = { displayName: 'Unknown User', mail: '' }; // Current logged-in user
        let currentProjectId = null; // Currently selected project for detail view
        let currentTicketId = null; // Currently selected ticket for task view

        // Container API Configuration
        const CONTAINER_CONFIG = {
            // Set to your container endpoints (local or Azure)
            gateway: localStorage.getItem('CONTAINER_GATEWAY') || 'http://localhost:8080',
            services: {
                'data-processing': { port: 8081, endpoint: '/api/data' },
                'rag-engine': { port: 8082, endpoint: '/api/rag' },
                'engineering-api': { port: 8083, endpoint: '/api/engineering' },
                'call-flow': { port: 8084, endpoint: '/api/callflow' },
                'agents': { port: 8085, endpoint: '/api/agents' }
            }
        };

        // Track running container jobs
        let containerJobs = {};

        // Tools Index with container mapping
        const TOOLS_INDEX = {
            'Data Processing & Import': {
                icon: 'data',
                container: 'data-processing',
                tools: [
                    { name: 'sharepoint_importer.py', desc: 'Import documents from SharePoint', containerTool: 'sharepoint_importer' },
                    { name: 'download_sharepoint.py', desc: 'Download files from SharePoint sites', containerTool: 'download_sharepoint' },
                    { name: 'download_all_sharepoint.py', desc: 'Bulk download all SharePoint content', containerTool: 'download_all_sharepoint' },
                    { name: 'slack_importer.py', desc: 'Import Slack channel exports', containerTool: 'slack_importer' },
                    { name: 'slab_importer.py', desc: 'Import documentation from Slab', containerTool: 'slab_importer' },
                    { name: 'sync_sharepoint.py', desc: 'Sync SharePoint sites', containerTool: 'sync_sharepoint' }
                ]
            },
            'RAG & Search': {
                icon: 'document',
                container: 'rag-engine',
                tools: [
                    { name: 'query_brain.py', desc: 'RAG query engine', containerTool: 'query' },
                    { name: 'vector_store.py', desc: 'ChromaDB vector storage', containerTool: 'vector_store' },
                    { name: 'rebuild_index.py', desc: 'Rebuild search index', containerTool: 'rebuild_index' },
                    { name: 'suggest_links.py', desc: 'AI-suggested document links', containerTool: 'suggest_links' },
                    { name: 'rag_web.py', desc: 'Web interface for RAG system', containerTool: 'rag_web', isWebApp: true }
                ]
            },
            'Engineering & Automation': {
                icon: 'automation',
                container: 'engineering-api',
                tools: [
                    { name: 'daily_engineering_summary.py', desc: 'Generate daily email summaries', containerTool: 'daily_summary' },
                    { name: 'engineering_tracker.py', desc: 'Engineering projects/tickets API', containerTool: 'engineering_tracker' },
                    { name: 'contract_tracker.py', desc: 'Customer contract management', containerTool: 'contract_tracker' },
                    { name: 'ee_team_dashboard.py', desc: 'EE Team dashboard backend', containerTool: 'ee_team_dashboard' }
                ]
            },
            'AI Agents & MCP': {
                icon: 'agent',
                container: 'agents',
                tools: [
                    { name: 'agent_orchestrator.py', desc: 'Multi-agent orchestration system', containerTool: 'orchestrator' },
                    { name: 'agent_notebooklm_analyst.py', desc: 'NotebookLM analysis agent', containerTool: 'notebooklm_analyst' },
                    { name: 'agent_obsidian_manager.py', desc: 'Obsidian vault management', containerTool: 'obsidian_manager' },
                    { name: 'mcp_obsidian_server.py', desc: 'MCP server for Obsidian', containerTool: 'mcp_obsidian' }
                ]
            },
            'Configuration & Utilities': {
                icon: 'config',
                container: null,  // No container - local only
                tools: [
                    { name: 'config.py', desc: 'Application configuration' },
                    { name: 'cleanup_vault.py', desc: 'Clean up Obsidian vault' }
                ]
            },
            'Network Discovery': {
                icon: 'network',
                container: null,  // External service
                tools: [
                    { name: 'Network Scanner', desc: 'Scan networks for hosts, ports, and services', isExternal: true, externalUrl: 'http://localhost:8080', projectPath: '/home/mavrick/Projects/NetworkScannerSuite' },
                    { name: 'Quick Discovery', desc: 'Fast host discovery scan (nmap -sn)', scanType: 'quick' },
                    { name: 'Standard Scan', desc: 'Ports + service detection (nmap -F -sV)', scanType: 'standard' },
                    { name: 'Intensive Scan', desc: 'Full port scan + OS detection (nmap -p- -sV -sC -O)', scanType: 'intense' }
                ]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded - initializing...');
            try {
                safeFeatherReplace();
                console.log('Feather icons created');
            } catch(e) {
                console.error('Feather icons error:', e);
            }
            updateTime();
            setInterval(updateTime, 1000);
            renderToolsIndex();

            // Bind all event listeners (Teams CSP compatibility)
            bindEventListeners();

            // Initialize MSAL authentication
            await initializeMsal();

            // --- Initialize Socket.IO Client ---
            try {
                // Ensure the URL points to the Flask-SocketIO server (engineering-api service)
                // Use the configured gateway but specify the engineering-api port (8083)
                const engineeringApiUrl = CONTAINER_CONFIG.gateway.replace(/:\d+$/, ':8083');
                socket = io(engineeringApiUrl, {
                    transports: ['websocket', 'polling'], // Prioritize WebSocket, fallback to polling
                    autoConnect: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000,
                });

                socket.on('connect', () => {
                    console.log('Connected to WebSocket server (engineering-api)');
                    showNotification('Real-time updates enabled', 'success', 3000);
                });

                socket.on('disconnect', () => {
                    console.warn('Disconnected from WebSocket server');
                    showNotification('Real-time updates disconnected', 'warning', 5000);
                });

                // Listen for data_updated events from the backend
                socket.on('data_updated', (data) => {
                    console.log('Received data_updated event:', data);
                    // Prevent infinite loops if multiple clients trigger updates.
                    // Only reload if the update didn't originate from this client (optional, but good practice).
                    // For now, a simple reload is fine.
                    showNotification(`Data updated: ${data.type || 'unknown'}`, 'info', 2000);
                    // Trigger a full data reload and re-render of affected sections
                    loadData();
                });

                socket.on('connect_error', (error) => {
                    console.error('Socket.IO connection error:', error);
                    showNotification('Real-time connection error', 'error', 5000);
                });

            } catch (e) {
                console.error('Failed to initialize Socket.IO:', e);
                showNotification('Failed to establish real-time connection', 'error', 5000);
            }
            // --- End Initialize Socket.IO Client ---

            console.log('Initialization complete');
        });
        
        // --- Helper to send update notifications to backend for broadcasting ---
        async function sendUpdateToBackend(type, itemId, action = 'modified') {
            try {
                const engineeringApiUrl = CONTAINER_CONFIG.gateway.replace(/:\d+$/, ':8083');
                await fetch(engineeringApiUrl + '/broadcast_update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_type: 'data_updated',
                        data: { type: type, id: itemId, action: action }
                    })
                });
                console.log(`Update broadcasted for ${type} ${itemId}`);
            } catch (error) {
                console.error('Failed to send update to backend for broadcasting:', error);
            }
        }
        // --- End Helper ---

        // Fallback - also try on window load
        window.addEventListener('load', () => {
            console.log('Window loaded - checking buttons...');
            const tabs = document.querySelectorAll('.envelope-tab');
            console.log('Found ' + tabs.length + ' tabs');
            if (tabs.length > 0 && !tabs[0]._bound) {
                console.log('Re-binding event listeners...');
                bindEventListeners();
            }
        });

        function bindEventListeners() {
            console.log('bindEventListeners called');

            // Tab switching
            document.querySelectorAll('.envelope-tab').forEach(tab => {
                tab._bound = true;
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Tab clicked:', tab.dataset.tab);
                    switchTab(tab.dataset.tab);
                });
            });

            // AI Panel buttons
            document.querySelectorAll('.ai-agent-btn').forEach(btn => {
                if (btn.classList.contains('claude')) {
                    btn.addEventListener('click', () => toggleAIPanel('claude'));
                } else if (btn.classList.contains('gemini')) {
                    btn.addEventListener('click', () => toggleAIPanel('gemini'));
                }
            });

            // Sync/Refresh button
            const refreshBtn = document.querySelector('.btn-secondary[style*="Sync"], .header .btn-secondary');
            document.querySelectorAll('.header .btn-secondary').forEach(btn => {
                if (btn.textContent.trim() === 'Sync') {
                    btn.addEventListener('click', refreshData);
                }
            });

            // View toggle buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const panel = e.target.closest('.tab-panel');
                    const type = panel ? panel.id.replace('-panel', '') : 'projects';
                    const view = btn.textContent.toLowerCase().includes('kanban') ? 'kanban' : 'chat';
                    console.log('View switch clicked:', type, view);
                    switchView(type, view, btn);
                });
            });

            // New Project button
            document.querySelectorAll('.btn-primary').forEach(btn => {
                if (btn.textContent.includes('New Project')) {
                    btn.addEventListener('click', () => showModal('add', 'projects'));
                }
            });

            // Week navigation
            document.querySelectorAll('.planner-nav-btn').forEach((btn, idx) => {
                btn.addEventListener('click', () => navigateWeek(idx === 0 ? -1 : 1));
            });

            // Today button
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                if (btn.textContent.trim() === 'Today') {
                    btn.addEventListener('click', goToToday);
                }
                if (btn.textContent.trim() === 'Cancel') {
                    btn.addEventListener('click', closeModal);
                }
            });

            // Quick add task
            document.querySelectorAll('.btn-primary').forEach(btn => {
                if (btn.querySelector('i[data-feather="plus"]') && btn.closest('.planner-header')) {
                    btn.addEventListener('click', quickAddTask);
                }
            });

            // AI Panel close
            document.querySelectorAll('.ai-panel-close').forEach(btn => {
                btn.addEventListener('click', closeAIPanel);
            });

            // AI Send button
            document.querySelectorAll('.ai-send-btn').forEach(btn => {
                btn.addEventListener('click', sendAIMessage);
            });

            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                const modal = btn.closest('.modal-overlay');
                if (modal) {
                    if (modal.id === 'toolModal') {
                        btn.addEventListener('click', closeToolModal);
                    } else if (modal.id === 'projectDetailModal') {
                        btn.addEventListener('click', closeProjectDetailModal);
                    } else if (modal.id === 'addTaskModal') {
                        btn.addEventListener('click', closeAddTaskModal);
                    } else {
                        btn.addEventListener('click', closeModal);
                    }
                }
            });

            // Save button in modal (check both modal-footer and modal-actions)
            document.querySelectorAll('.modal-footer .btn-primary, .modal-actions .btn-primary').forEach(btn => {
                if (btn._saveBound) return; // Prevent duplicate listeners
                if (btn.textContent.includes('Save') || btn.textContent.includes('Create') || btn.textContent.includes('Update')) {
                    const modal = btn.closest('.modal-overlay');
                    if (modal && modal.id === 'addTaskModal') {
                        btn.addEventListener('click', submitNewTask);
                        btn._saveBound = true;
                    } else if (modal && modal.id === 'modal') {
                        btn.addEventListener('click', saveItem);
                        btn._saveBound = true;
                    }
                }
            });

            // Add Task Row button in project modal - find button near projectTasksList
            document.querySelectorAll('#modal .btn-secondary').forEach(btn => {
                if (btn._taskBound) return; // Prevent duplicate listeners
                if (btn.textContent.includes('Add Task')) {
                    btn.addEventListener('click', addTaskRow);
                    btn._taskBound = true;
                }
            });

            // Comment send button
            document.querySelectorAll('.comment-send').forEach(btn => {
                btn.addEventListener('click', addComment);
            });

            // Project detail edit button
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                if (btn.querySelector('i[data-feather="edit"]')) {
                    btn.addEventListener('click', editProjectFromDetail);
                }
            });

            // Add Task button in project detail
            document.querySelectorAll('.btn-primary').forEach(btn => {
                if (btn.textContent.includes('Add Task') && btn.closest('#projectDetailModal')) {
                    btn.addEventListener('click', showAddTaskModal);
                }
            });

            // Add Doc Note button
            document.querySelectorAll('.btn-primary').forEach(btn => {
                if (btn.textContent.includes('Add Note') || btn.closest('.project-doc-input')) {
                    btn.addEventListener('click', addProjectDocNote);
                }
            });

            // User selector
            const userSelect = document.getElementById('currentUserSelect');
            if (userSelect) {
                userSelect.addEventListener('change', (e) => setCurrentUser(e.target.value));
            }

            // Tool modal buttons
            document.querySelectorAll('.tool-modal-actions .btn-secondary').forEach(btn => {
                if (btn.textContent.includes('View Code')) {
                    btn.addEventListener('click', () => viewToolCode(document.getElementById('currentToolName').value));
                } else if (btn.textContent.includes('Docs')) {
                    btn.addEventListener('click', () => showToolDocs(document.getElementById('currentToolName').value));
                }
            });
            document.querySelectorAll('.tool-modal-actions .btn-primary').forEach(btn => {
                if (btn.textContent.includes('Run Tool')) {
                    btn.addEventListener('click', () => runTool(document.getElementById('currentToolName').value));
                }
            });

            // Search inputs
            const projectSearch = document.getElementById('projectSearchInput');
            if (projectSearch) {
                projectSearch.addEventListener('input', () => filterItems('projects'));
            }

            // Show Archived checkboxes
            const projectShowArchived = document.getElementById('projectShowArchived');
            if (projectShowArchived) {
                projectShowArchived.addEventListener('change', () => renderItems('projects'));
            }
            const ticketShowArchived = document.getElementById('ticketShowArchived');
            if (ticketShowArchived) {
                ticketShowArchived.addEventListener('change', () => renderItems('tickets'));
            }

            const toolSearch = document.getElementById('toolSearchInput');
            if (toolSearch) {
                toolSearch.addEventListener('input', filterTools);
            }

            // Percent slider
            const percentSlider = document.getElementById('projectPercent');
            if (percentSlider) {
                percentSlider.addEventListener('input', function() {
                    document.getElementById('percentLabel').textContent = this.value + '%';
                });
            }

            // Export buttons
            document.querySelectorAll('.export-btn').forEach(btn => {
                if (btn._exportBound) return;
                btn._exportBound = true;
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const type = btn.dataset.type;
                    toggleExportDropdown(type);
                });
            });

            // Export options
            document.querySelectorAll('.export-option').forEach(option => {
                if (option._exportBound) return;
                option._exportBound = true;
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const format = option.dataset.format;
                    const type = option.dataset.type;
                    exportData(type, format);
                });
            });

            // Container settings button
            const containerSettingsBtn = document.getElementById('containerSettingsBtn');
            if (containerSettingsBtn && !containerSettingsBtn._bound) {
                containerSettingsBtn._bound = true;
                containerSettingsBtn.addEventListener('click', showContainerSettingsModal);
            }

            // Refresh jobs button
            const refreshJobsBtn = document.getElementById('refreshJobsBtn');
            if (refreshJobsBtn && !refreshJobsBtn._bound) {
                refreshJobsBtn._bound = true;
                refreshJobsBtn.addEventListener('click', async () => {
                    refreshJobsBtn.disabled = true;
                    refreshJobsBtn.innerHTML = '<i data-feather="loader" style="width:14px;height:14px;animation:spin 1s linear infinite;"></i> Refreshing...';
                    safeFeatherReplace();
                    await refreshAllJobs();
                    await checkGatewayHealth();
                    refreshJobsBtn.disabled = false;
                    refreshJobsBtn.innerHTML = '<i data-feather="refresh-cw" style="width:14px;height:14px;"></i> Refresh Jobs';
                    safeFeatherReplace();
                });
            }

            // Initial gateway health check
            checkGatewayHealth();

            console.log('Event listeners bound successfully');
        }

        async function checkGatewayHealth() {
            const statusDot = document.getElementById('containerGatewayStatus');
            const urlDisplay = document.getElementById('containerGatewayUrl');
            if (!statusDot || !urlDisplay) return;

            urlDisplay.textContent = `Gateway: ${CONTAINER_CONFIG.gateway.replace('http://', '')}`;

            try {
                const response = await fetch(`${CONTAINER_CONFIG.gateway}/health`, { method: 'GET' });
                if (response.ok) {
                    statusDot.style.background = 'var(--success)';
                    statusDot.title = 'Gateway online';
                } else {
                    statusDot.style.background = 'var(--warning)';
                    statusDot.title = 'Gateway error';
                }
            } catch (error) {
                statusDot.style.background = 'var(--danger)';
                statusDot.title = 'Gateway offline';
            }
        }

        function showContainerSettingsModal() {
            const currentGateway = CONTAINER_CONFIG.gateway;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'containerSettingsModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
            modal.innerHTML = `
                <div style="background:var(--card-bg);border-radius:12px;padding:24px;max-width:500px;width:90%;box-shadow:var(--shadow-lg);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="margin:0;font-size:16px;">Container Settings</h3>
                        <button onclick="document.getElementById('containerSettingsModal').remove()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);">
                            <i data-feather="x" style="width:20px;height:20px;"></i>
                        </button>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label style="display:block;font-size:13px;font-weight:500;margin-bottom:6px;">Gateway URL</label>
                        <input type="text" id="gatewayUrlInput" value="${escapeAttr(currentGateway)}" class="form-input" style="width:100%;" placeholder="http://localhost:8080">
                        <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">
                            Local: http://localhost:8080 | Azure: https://your-app.azurecontainerapps.io
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-size:13px;font-weight:500;margin-bottom:8px;">Container Services</label>
                        <div id="serviceHealthList" style="display:flex;flex-direction:column;gap:8px;">
                            ${Object.entries(CONTAINER_CONFIG.services).map(([name, config]) => `
                                <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg);border-radius:6px;">
                                    <span id="health-${escapeAttr(name)}" style="width:8px;height:8px;border-radius:50%;background:var(--text-muted);"></span>
                                    <span style="font-weight:500;font-size:12px;">${escapeHtml(name)}</span>
                                    <span style="color:var(--text-muted);font-size:11px;margin-left:auto;">:${config.port}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display:flex;gap:10px;">
                        <button id="checkHealthBtn" class="btn btn-secondary" style="flex:1;">
                            <i data-feather="activity" style="width:14px;height:14px;"></i>
                            Check Health
                        </button>
                        <button id="saveGatewayBtn" class="btn btn-primary" style="flex:1;">
                            <i data-feather="save" style="width:14px;height:14px;"></i>
                            Save Settings
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            safeFeatherReplace();

            // Check health button
            document.getElementById('checkHealthBtn').onclick = async () => {
                for (const serviceName of Object.keys(CONTAINER_CONFIG.services)) {
                    const dot = document.getElementById(`health-${serviceName}`);
                    if (dot) {
                        dot.style.background = 'var(--warning)';
                        const health = await checkContainerHealth(serviceName);
                        dot.style.background = health.healthy ? 'var(--success)' : 'var(--danger)';
                    }
                }
            };

            // Save settings button
            document.getElementById('saveGatewayBtn').onclick = () => {
                const newGateway = document.getElementById('gatewayUrlInput').value.trim();
                if (newGateway) {
                    CONTAINER_CONFIG.gateway = newGateway;
                    localStorage.setItem('CONTAINER_GATEWAY', newGateway);
                    showNotification('Container settings saved', 'success');
                    checkGatewayHealth();
                }
                modal.remove();
            };

            // Close on overlay click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            // Initial health check
            document.getElementById('checkHealthBtn').click();
        }

        async function loadADUsers() {
            if (!CONFIG.accessToken || CONFIG.accessToken.includes('{{')) {
                // Demo mode - use sample users
                console.log('No access token, using fallback users');
                adUsers = FALLBACK_USERS;
                populateAssigneeDropdowns();
                return;
            }

            try {
                // Fetch all users (up to 999)
                const token = await getAccessToken();
                const response = await fetch(
                    `${GRAPH_API}/users?$select=displayName,mail,jobTitle,department&$filter=accountEnabled eq true&$top=999`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                if (response.ok) {
                    const data = await response.json();
                    const rawUsers = data.value || [];
                    console.log(`Graph API returned ${rawUsers.length} raw users`);

                    // Filter out obvious service accounts only (keep most users)
                    adUsers = rawUsers.filter(u =>
                        u.mail &&
                        u.displayName &&
                        !u.displayName.toLowerCase().includes('conference') &&
                        !u.displayName.toLowerCase().includes('room') &&
                        !u.displayName.toLowerCase().includes('mailbox') &&
                        !u.displayName.toLowerCase().includes('test user') &&
                        !u.displayName.toLowerCase().includes('service account')
                    ).sort((a, b) => a.displayName.localeCompare(b.displayName));

                    console.log(`After filtering: ${adUsers.length} users (filtered out ${rawUsers.length - adUsers.length})`);

                    // If no users from API, use fallback
                    if (adUsers.length === 0) {
                        console.log('No users from API, using fallback users');
                        adUsers = FALLBACK_USERS;
                    }
                } else {
                    console.error('Graph API error:', response.status, await response.text());
                    console.log('Using fallback users due to API error');
                    adUsers = FALLBACK_USERS;
                }
            } catch (error) {
                console.error('Error loading AD users:', error);
                console.log('Using fallback users due to error');
                adUsers = FALLBACK_USERS;
            }

            populateAssigneeDropdowns();
        }

        // Populate all assignee dropdowns with AD users
        function populateAssigneeDropdowns() {
            const options = '<option value="">Unassigned</option>' +
                adUsers.map(u => `<option value="${u.displayName}">${u.displayName}</option>`).join('');

            // Main form dropdown
            const assigneeSelect = document.getElementById('itemAssignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = options;
            }

            // Current user selector in header
            const userSelect = document.getElementById('currentUserSelect');
            if (userSelect) {
                const savedUser = localStorage.getItem('currentUserName');
                userSelect.innerHTML = '<option value="">Select Your Name...</option>' +
                    adUsers.map(u => `<option value="${u.displayName}" ${savedUser === u.displayName ? 'selected' : ''}>${u.displayName}</option>`).join('');

                // If we have a saved user, set them as current
                if (savedUser) {
                    const user = adUsers.find(u => u.displayName === savedUser);
                    if (user) {
                        setCurrentUser(savedUser, false);
                    }
                }
            }

            // Quick add dropdown
            const quickAddSelect = document.getElementById('quickAddAssignee');
            if (quickAddSelect) {
                quickAddSelect.innerHTML = '<option value="">Assign to...</option>' +
                    adUsers.map(u => `<option value="${u.displayName}">${u.displayName}</option>`).join('');
            }
        }

        // Set current user (for comments and documentation)
        function setCurrentUser(userName, save = true) {
            if (!userName) {
                currentUser = { displayName: 'Unknown User', mail: '' };
                document.getElementById('currentUserAvatar').textContent = '?';
                if (save) localStorage.removeItem('currentUserName');
                return;
            }

            const user = adUsers.find(u => u.displayName === userName);
            if (user) {
                currentUser = user;
                document.getElementById('currentUserAvatar').textContent = getInitials(user.displayName);
                if (save) localStorage.setItem('currentUserName', userName);
                console.log('Current user set to:', user.displayName);
            }
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        // Tab & View switching
        function switchTab(tab) {
            currentTab = tab;
            // Update tab buttons - remove active class and update aria-selected
            document.querySelectorAll('.envelope-tab').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            const activeTab = document.querySelector(`[data-tab="${tab}"]`);
            activeTab.classList.add('active');
            activeTab.setAttribute('aria-selected', 'true');

            // Update panels
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${tab}-panel`).classList.add('active');
            safeFeatherReplace();
        }

        function switchView(type, view, clickedBtn) {
            currentViews[type] = view;
            const container = document.getElementById(`${type}-panel`);
            container.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            if (clickedBtn) clickedBtn.classList.add('active');

            document.getElementById(`${type}-chat-view`).style.display = view === 'chat' ? 'flex' : 'none';
            document.getElementById(`${type}-kanban-view`).style.display = view === 'kanban' ? 'flex' : 'none';

            renderItems(type);
        }

        // Data Loading - SharePoint Integration with Historical Tracking

        // Create TimeEntries list if it doesn't exist
        async function createTimeEntriesList() {
            try {
                const token = await getAccessToken();

                // First, create the list
                const listData = {
                    displayName: "TimeEntries",
                    description: "Time tracking entries for employees",
                    list: { template: "genericList" }
                };

                console.log('Creating TimeEntries list...');
                const listResponse = await fetchWithRetry(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(listData)
                    }
                );

                if (!listResponse.ok) {
                    const errorText = await listResponse.text();
                    console.error('Failed to create TimeEntries list:', errorText);
                    return null;
                }

                const newList = await listResponse.json();
                console.log('TimeEntries list created:', newList.id);

                // Add custom columns
                const columns = [
                    { name: "Employee", displayName: "Employee", text: { maxLength: 255 } },
                    { name: "EntryDate", displayName: "Entry Date", dateTime: { format: "dateOnly" } },
                    { name: "Hours", displayName: "Hours", number: { decimalPlaces: "two", minimum: 0, maximum: 24 } },
                    { name: "WorkType", displayName: "Work Type", choice: { choices: ["Regular", "Overtime", "PTO", "Training", "Meeting"], displayAs: "dropDownMenu" } },
                    { name: "ProjectId", displayName: "Project ID", text: { maxLength: 255 } },
                    { name: "ProjectType", displayName: "Project Type", choice: { choices: ["project", "ticket"], displayAs: "dropDownMenu" } },
                    { name: "ProjectName", displayName: "Project Name", text: { maxLength: 255 } },
                    { name: "Description", displayName: "Description", text: { allowMultipleLines: true, maxLength: 5000 } },
                    { name: "Billable", displayName: "Billable", boolean: {} }
                ];

                for (const col of columns) {
                    try {
                        await fetchWithRetry(
                            `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${newList.id}/columns`,
                            {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(col)
                            }
                        );
                        console.log(`Added column: ${col.displayName}`);
                    } catch (colError) {
                        console.warn(`Could not add column ${col.displayName}:`, colError);
                    }
                }

                showNotification('TimeEntries list created in SharePoint!', 'success');
                return newList.id;
            } catch (error) {
                console.error('Error creating TimeEntries list:', error);
                return null;
            }
        }

        // Discover SharePoint list IDs by name
        async function discoverListIds() {
            console.log('=== discoverListIds() START ===');
            try {
                console.log('Getting access token...');
                const token = await getAccessToken();
                console.log('Token obtained:', token ? 'YES (length: ' + token.length + ')' : 'NO');

                const url = `${GRAPH_API}/sites/${CONFIG.siteId}/lists`;
                console.log('Fetching lists from:', url);

                const response = await fetchWithRetry(
                    url,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                console.log('Response status:', response.status);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to fetch lists:', response.status, errorText);
                    return false;
                }

                const data = await response.json();
                const lists = data.value || [];

                // Log all available lists for debugging
                console.log('Available SharePoint lists:', lists.map(l => ({ name: l.displayName, id: l.id })));

                for (const list of lists) {
                    const name = list.displayName.toLowerCase();
                    if (name === 'projects' || name === 'engineering projects') {
                        CONFIG.projectsListId = list.id;
                        console.log('Found Projects list:', list.id);
                    } else if (name === 'tickets' || name === 'support tickets' || name === 'engineering tickets') {
                        CONFIG.ticketsListId = list.id;
                        console.log('Found Tickets list:', list.id);
                    } else if (name === 'tasks' || name === 'project tasks' || name === 'engineering tasks') {
                        CONFIG.tasksListId = list.id;
                        console.log('Found Tasks list:', list.id);
                    } else if (name === 'timeentries' || name === 'time entries') {
                        CONFIG.timeEntriesListId = list.id;
                        console.log('Found TimeEntries list:', list.id);
                    }
                }

                // Auto-create TimeEntries list if it doesn't exist
                if (!CONFIG.timeEntriesListId && (CONFIG.projectsListId || CONFIG.ticketsListId)) {
                    console.log('TimeEntries list not found, creating it...');
                    CONFIG.timeEntriesListId = await createTimeEntriesList();
                }

                return CONFIG.projectsListId || CONFIG.ticketsListId;
            } catch (error) {
                console.error('Error discovering lists:', error);
                return false;
            }
        }

        async function loadData() {
            console.log('=== loadData() START ===');
            console.log('CONFIG.siteId:', CONFIG.siteId);
            console.log('CONFIG.projectsListId:', CONFIG.projectsListId);
            console.log('CONFIG.ticketsListId:', CONFIG.ticketsListId);
            console.log('CONFIG.tasksListId:', CONFIG.tasksListId);

            // Show loading skeletons in main areas
            const mainContent = document.querySelector('.main-content');
            const todoArea = document.getElementById('todoGrid');

            if (window.loadingStates && todoArea) {
                todoArea.innerHTML = window.loadingStates.createSkeleton('kanban', { columns: 3, cardsPerColumn: 2 });
            }

            // Try to load from cache first (offline-first)
            if (window.dataStore && !navigator.onLine) {
                console.log('Offline - loading from cache');
                try {
                    const cachedProjects = await window.dataStore.getAll('projects');
                    const cachedTickets = await window.dataStore.getAll('tickets');
                    const cachedTasks = await window.dataStore.getAll('tasks');
                    const cachedTimeEntries = await window.dataStore.getAll('timeEntries');

                    if (cachedProjects.length > 0) {
                        projectsData = cachedProjects;
                        ticketsData = cachedTickets;
                        tasksData = cachedTasks;
                        timeEntriesData = cachedTimeEntries;

                        renderTodosByAssignee();
                        renderCalendar();
                        renderPlanner();
                        renderTimeReports();
                        showNotification('Loaded from offline cache', 'info');
                        return;
                    }
                } catch (e) {
                    console.warn('Cache load failed:', e);
                }
            }

            // Check if SharePoint is configured
            console.log('Checking SharePoint config...');
            console.log('siteId exists:', !!CONFIG.siteId);
            console.log('siteId contains placeholder:', CONFIG.siteId?.includes('{{'));

            if (CONFIG.siteId && !CONFIG.siteId.includes('{{')) {
                console.log('SharePoint is configured, discovering lists...');
                // Discover list IDs if not already set
                if (!CONFIG.projectsListId || !CONFIG.ticketsListId) {
                    const discovered = await discoverListIds();
                    console.log('List discovery result:', discovered);
                    console.log('After discovery - projectsListId:', CONFIG.projectsListId);
                    console.log('After discovery - ticketsListId:', CONFIG.ticketsListId);
                    console.log('After discovery - tasksListId:', CONFIG.tasksListId);

                    if (!discovered) {
                        console.warn('Could not discover SharePoint lists, falling back to demo mode');
                        showDemoData('projects');
                        showDemoData('tickets');
                        renderTodosByAssignee();
                        renderCalendar();
                        renderPlanner();
                        return;
                    }
                }

                try {
                    console.log('Loading data from SharePoint...');
                    await Promise.all([
                        loadFromSharePoint('projects'),
                        loadFromSharePoint('tickets'),
                        loadFromSharePoint('tasks'),
                        loadTimeEntriesFromSharePoint()
                    ]);
                    console.log('Data loaded - projectsData:', projectsData?.length, 'items');
                    console.log('Data loaded - ticketsData:', ticketsData?.length, 'items');
                    console.log('Data loaded - tasksData:', tasksData?.length, 'items');

                    // Cache data for offline use
                    if (window.dataStore) {
                        await Promise.all([
                            window.dataStore.putAll('projects', projectsData),
                            window.dataStore.putAll('tickets', ticketsData),
                            window.dataStore.putAll('tasks', tasksData),
                            window.dataStore.putAll('timeEntries', timeEntriesData)
                        ]);
                    }
                } catch (error) {
                    console.error('Error loading from SharePoint:', error);
                    if (window.errorBoundary) {
                        window.errorBoundary.captureError({
                            type: 'data_load_error',
                            message: error.message,
                            stack: error.stack
                        });
                    }

                    // Try to load from cache on error
                    if (window.dataStore) {
                        const cachedProjects = await window.dataStore.getAll('projects');
                        if (cachedProjects.length > 0) {
                            projectsData = cachedProjects;
                            ticketsData = await window.dataStore.getAll('tickets');
                            tasksData = await window.dataStore.getAll('tasks');
                            timeEntriesData = await window.dataStore.getAll('timeEntries');
                            showNotification('Loaded from cache (connection error)', 'warning');
                        }
                    }
                }
            } else {
                // Demo mode - local data
                showDemoData('projects');
                showDemoData('tickets');
                // Load time entries from localStorage in demo mode
                const savedTimeEntries = localStorage.getItem('timeEntriesData');
                if (savedTimeEntries) {
                    timeEntriesData = JSON.parse(savedTimeEntries);
                }
            }
            // Render all views AFTER data is loaded
            renderTodosByAssignee();
            renderCalendar();
            renderPlanner();
            renderTimeReports();
            console.log('All data loaded - views rendered');
            // --- Send WebSocket update ---
            if (socket && newItem.id) {
                sendUpdateToBackend(type, newItem.id, isNew ? 'created' : 'updated');
            }
        }

        async function loadFromSharePoint(type) {
            console.log(`=== loadFromSharePoint(${type}) START ===`);
            let listId;
            if (type === 'projects') listId = CONFIG.projectsListId;
            else if (type === 'tickets') listId = CONFIG.ticketsListId;
            else if (type === 'tasks') listId = CONFIG.tasksListId;

            console.log(`${type} listId:`, listId);

            if (!listId || listId.includes('{{')) {
                console.log(`${type} list not configured - SKIPPING`);
                return;
            }

            try {
                const token = await getAccessToken();
                let allItems = [];
                let nextLink = `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${listId}/items?expand=fields&$top=200`;

                // Pagination support - follow @odata.nextLink
                while (nextLink) {
                    const response = await fetchWithRetry(
                        nextLink,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`SharePoint API error (${response.status}):`, errorText);
                        showNotification(`Failed to load ${type}: ${response.status}`, 'error');
                        throw new Error(`SharePoint API error: ${response.status}`);
                    }

                    const data = await response.json();
                    allItems = allItems.concat(data.value || []);

                    // Check for more pages
                    nextLink = data['@odata.nextLink'] || null;
                }

                const items = allItems;

                // Map SharePoint version history metadata
                items.forEach(item => {
                    item.sharePointId = item.id;
                    item.createdDateTime = item.createdDateTime;
                    item.lastModifiedDateTime = item.lastModifiedDateTime;
                    item.createdBy = item.createdBy?.user?.displayName || 'Unknown';
                    item.modifiedBy = item.lastModifiedBy?.user?.displayName || 'Unknown';

                    // Parse Comments from SharePoint JSON string (for tickets)
                    if (item.fields?.Comments) {
                        try {
                            commentsData[item.id] = JSON.parse(item.fields.Comments);
                        } catch (e) {
                            commentsData[item.id] = item.fields.Comments ? [{
                                author: 'System',
                                text: item.fields.Comments,
                                time: 'Imported'
                            }] : [];
                        }
                    }

                    // Parse DocumentationLog for tickets
                    if (item.fields?.DocumentationLog) {
                        try {
                            documentationLogs[item.id] = JSON.parse(item.fields.DocumentationLog);
                        } catch (e) {
                            documentationLogs[item.id] = [];
                        }
                    }
                });

                if (type === 'projects') {
                    projectsData = items;
                    // Calculate % complete from linked tasks
                    calculateAllProjectProgress();
                    updateProjectStats();
                    renderItems('projects');
                } else if (type === 'tickets') {
                    ticketsData = items;
                    updateTicketStats();
                    renderItems('tickets');
                } else if (type === 'tasks') {
                    tasksData = items;
                    console.log(`Loaded ${items.length} tasks`);
                    // Re-render to-do list after tasks are loaded
                    renderTodosByAssignee();
                }

                console.log(`Loaded ${items.length} ${type} from SharePoint`);
            } catch (error) {
                console.error(`Error loading ${type} from SharePoint:`, error);
                if (type !== 'tasks') showDemoData(type);
            }
        }

        // ========================================
        // TIME ENTRIES - SHAREPOINT INTEGRATION
        // ========================================

        // Sync queue for offline changes
        let timeEntrySyncQueue = [];

        function loadSyncQueue() {
            try {
                const saved = localStorage.getItem('timeEntrySyncQueue');
                timeEntrySyncQueue = saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error('Failed to load sync queue:', e);
                timeEntrySyncQueue = [];
            }
        }

        function saveSyncQueue() {
            localStorage.setItem('timeEntrySyncQueue', JSON.stringify(timeEntrySyncQueue));
        }

        function addToSyncQueue(operation, entry) {
            // Remove any existing operation for this entry
            timeEntrySyncQueue = timeEntrySyncQueue.filter(q => q.entry.id !== entry.id);
            timeEntrySyncQueue.push({
                operation, // 'create', 'update', 'delete'
                entry: { ...entry },
                timestamp: new Date().toISOString()
            });
            saveSyncQueue();
            updateSyncIndicator();
        }

        function removeFromSyncQueue(entryId) {
            timeEntrySyncQueue = timeEntrySyncQueue.filter(q => q.entry.id !== entryId);
            saveSyncQueue();
            updateSyncIndicator();
        }

        function updateSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;

            if (timeEntrySyncQueue.length > 0) {
                indicator.style.display = 'flex';
                indicator.innerHTML = `
                    <i data-feather="cloud-off" style="width:14px;height:14px;color:var(--warning);"></i>
                    <span style="font-size:12px;color:var(--warning);">${timeEntrySyncQueue.length} pending</span>
                    <button class="btn btn-secondary" style="padding:2px 8px;font-size:11px;" onclick="processSyncQueue()">Sync Now</button>
                `;
                safeFeatherReplace();
            } else {
                indicator.style.display = 'none';
            }
        }

        async function processSyncQueue() {
            if (timeEntrySyncQueue.length === 0) return;
            if (!CONFIG.timeEntriesListId) {
                showNotification('SharePoint not configured. Cannot sync.', 'warning');
                return;
            }

            showNotification(`Syncing ${timeEntrySyncQueue.length} pending changes...`, 'info');

            const queueCopy = [...timeEntrySyncQueue];
            let successCount = 0;
            let failCount = 0;

            for (const item of queueCopy) {
                try {
                    if (item.operation === 'create') {
                        const success = await saveTimeEntryToSharePoint(item.entry, true);
                        if (success) {
                            // Update local entry with SharePoint ID
                            const localEntry = timeEntriesData.find(e => e.id === item.entry.id);
                            if (localEntry) {
                                localEntry.sharePointId = item.entry.sharePointId;
                                localEntry.etag = item.entry.etag;
                            }
                            removeFromSyncQueue(item.entry.id);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } else if (item.operation === 'update') {
                        const success = await saveTimeEntryToSharePoint(item.entry, false);
                        if (success) {
                            removeFromSyncQueue(item.entry.id);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } else if (item.operation === 'delete') {
                        const success = await deleteTimeEntryFromSharePoint(item.entry.sharePointId);
                        if (success) {
                            removeFromSyncQueue(item.entry.id);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                    failCount++;
                }
            }

            localStorage.setItem('timeEntriesData', JSON.stringify(timeEntriesData));

            if (failCount === 0) {
                showNotification(`Synced ${successCount} changes successfully!`, 'success');
            } else {
                showNotification(`Synced ${successCount}, failed ${failCount}. Will retry later.`, 'warning');
            }

            updateSyncIndicator();
        }

        async function loadTimeEntriesFromSharePoint() {
            if (!CONFIG.timeEntriesListId) {
                console.log('TimeEntries list not configured, loading from localStorage');
                const saved = localStorage.getItem('timeEntriesData');
                if (saved) {
                    try {
                        timeEntriesData = JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to load time entries from localStorage:', e);
                    }
                }
                return;
            }

            try {
                const token = await getAccessToken();
                let allItems = [];
                let nextLink = `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.timeEntriesListId}/items?expand=fields&$top=200`;

                while (nextLink) {
                    const response = await fetchWithRetry(
                        nextLink,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`SharePoint API error (${response.status}):`, errorText);
                        throw new Error(`SharePoint API error: ${response.status}`);
                    }

                    const data = await response.json();
                    allItems = allItems.concat(data.value || []);
                    nextLink = data['@odata.nextLink'] || null;
                }

                // Map SharePoint items to time entry format with ETag for concurrency
                timeEntriesData = allItems.map(item => ({
                    id: String(item.id),
                    sharePointId: item.id,
                    etag: item['@odata.etag'] || null, // Capture ETag for concurrency control
                    employee: item.fields.Employee || '',
                    date: item.fields.EntryDate ? item.fields.EntryDate.split('T')[0] : '',
                    hours: parseFloat(item.fields.Hours) || 0,
                    type: item.fields.WorkType || 'Project',
                    projectId: item.fields.ProjectId || null,
                    projectType: item.fields.ProjectType || null,
                    projectName: item.fields.Title || item.fields.LinkTitle || 'General',
                    description: item.fields.Description || '',
                    billable: item.fields.Billable === true,
                    createdAt: item.createdDateTime,
                    updatedAt: item.lastModifiedDateTime
                }));

                console.log(`Loaded ${timeEntriesData.length} time entries from SharePoint`);
                localStorage.setItem('timeEntriesData', JSON.stringify(timeEntriesData));
            } catch (error) {
                console.error('Error loading time entries from SharePoint:', error);
                const saved = localStorage.getItem('timeEntriesData');
                if (saved) {
                    try {
                        timeEntriesData = JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to load time entries from localStorage:', e);
                    }
                }
            }
        }

        async function saveTimeEntryToSharePoint(entry, isNew = false) {
            if (!CONFIG.timeEntriesListId) {
                console.log('TimeEntries list not configured, saving to localStorage only');
                return true;
            }

            try {
                const token = await getAccessToken();

                const data = {
                    fields: {
                        Title: `${entry.employee} - ${entry.date}`,
                        Employee: entry.employee,
                        EntryDate: entry.date,
                        Hours: parseFloat(entry.hours),
                        WorkType: entry.type,
                        ProjectId: entry.projectId || '',
                        ProjectType: entry.projectType || '',
                        ProjectName: entry.projectName || 'General',
                        Description: entry.description || '',
                        Billable: entry.billable === true
                    }
                };

                let response;
                let url;

                if (isNew || !entry.sharePointId) {
                    url = `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.timeEntriesListId}/items`;
                    response = await fetchWithRetry(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    url = `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.timeEntriesListId}/items/${entry.sharePointId}`;
                    const headers = {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    };
                    // Add ETag for optimistic concurrency control
                    if (entry.etag) {
                        headers['If-Match'] = entry.etag;
                    }
                    response = await fetchWithRetry(url, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify(data)
                    });
                }

                // Handle concurrency conflict (412 Precondition Failed)
                if (response.status === 412) {
                    showNotification('This entry was modified by someone else. Please refresh and try again.', 'error');
                    return false;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('SharePoint save error:', errorText);
                    throw new Error(`SharePoint API error: ${response.status}`);
                }

                const savedItem = await response.json();
                entry.sharePointId = savedItem.id;
                entry.id = String(savedItem.id);
                entry.etag = savedItem['@odata.etag'] || null; // Update ETag after save
                entry.updatedAt = savedItem.lastModifiedDateTime;
                if (isNew) entry.createdAt = savedItem.createdDateTime;

                console.log(`Time entry ${isNew ? 'created' : 'updated'} in SharePoint:`, savedItem.id);
                return true;
            } catch (error) {
                console.error('Error saving time entry to SharePoint:', error);
                showNotification('Failed to save to SharePoint. Saved locally only.', 'warning');
                return false;
            }
        }

        async function deleteTimeEntryFromSharePoint(sharePointId) {
            if (!CONFIG.timeEntriesListId || !sharePointId) {
                return true;
            }

            try {
                const token = await getAccessToken();
                const url = `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.timeEntriesListId}/items/${sharePointId}`;

                const response = await fetchWithRetry(url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok && response.status !== 404) {
                    throw new Error(`SharePoint API error: ${response.status}`);
                }

                console.log('Time entry deleted from SharePoint:', sharePointId);
                return true;
            } catch (error) {
                console.error('Error deleting time entry from SharePoint:', error);
                showNotification('Failed to delete from SharePoint.', 'warning');
                return false;
            }
        }

        // Calculate project progress from tasks
        function calculateAllProjectProgress() {
            projectsData.forEach(project => {
                const linkedTicket = ticketsData.find(t => String(t.fields.ProjectID) === String(project.id));
                if (linkedTicket) {
                    const projectTasks = tasksData.filter(t => String(t.fields.TicketID) === String(linkedTicket.id));
                    if (projectTasks.length > 0) {
                        const doneTasks = projectTasks.filter(t => t.fields.Status === 'Done').length;
                        project.fields.PercentComplete = Math.round((doneTasks / projectTasks.length) * 100);
                    }
                }
            });
        }

        function getProjectTasks(projectId) {
            const linkedTicket = ticketsData.find(t => String(t.fields.ProjectID) === String(projectId));
            if (!linkedTicket) return [];
            return tasksData.filter(t => String(t.fields.TicketID) === String(linkedTicket.id));
        }

        function getTicketTasks(ticketId) {
            return tasksData.filter(t => String(t.fields.TicketID) === String(ticketId));
        }

        // Save to SharePoint with version tracking
        async function saveToSharePoint(type, item, isNew = false) {
            const listId = type === 'projects' ? CONFIG.projectsListId : CONFIG.ticketsListId;
            const titleField = type === 'projects' ? 'Title' : 'TicketTitle';
            const f = item.fields;

            // Common fields
            const data = {
                fields: {
                    [titleField]: f[titleField] || f.Title || f.TicketTitle,
                    Description: f.Description || '',
                    Status: f.Status || (type === 'tickets' ? 'Open' : 'Not Started'),
                    Priority: f.Priority || 'Medium',
                    AssignedTo: f.AssignedTo || '',
                    Team: f.Team || 'Engineering',
                    Customer: f.Customer || ''
                }
            };

            if (f.DueDate) data.fields.DueDate = f.DueDate;

            // Project-specific fields
            if (type === 'projects') {
                if (f.StartDate) data.fields.StartDate = f.StartDate;
                if (f.EndDate) data.fields.EndDate = f.EndDate;
                if (f.PercentComplete !== undefined) data.fields.PercentComplete = f.PercentComplete;
                if (f.BudgetHours) data.fields.BudgetHours = f.BudgetHours;
                if (f.HoursSpent) data.fields.HoursSpent = f.HoursSpent;
                if (f.ProjectNumber) data.fields.ProjectNumber = f.ProjectNumber;
                if (f.Milestones) data.fields.Milestones = f.Milestones;
            }

            // Ticket-specific fields
            if (type === 'tickets') {
                if (f.TicketNumber) data.fields.TicketNumber = f.TicketNumber;
                if (f.Source) data.fields.Source = f.Source;
                if (f.Urgency) data.fields.Urgency = f.Urgency;
                if (f.SLAStatus) data.fields.SLAStatus = f.SLAStatus;
                if (f.TimeSpent) data.fields.TimeSpent = f.TimeSpent;
                if (f.RelatedProject) data.fields.RelatedProject = f.RelatedProject;
                if (f.Resolution) data.fields.Resolution = f.Resolution;
            }

            try {
                const url = isNew
                    ? `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${listId}/items`
                    : `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${listId}/items/${item.sharePointId || item.id}`;

                // Get fresh token from MSAL (if authenticated) or fallback to config token
                const token = await getAccessToken();

                const response = await fetch(url, {
                    method: isNew ? 'POST' : 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`${isNew ? 'Created' : 'Updated'} in SharePoint with version tracking`);

                    // Log activity for audit trail
                    logActivity(type, item, isNew ? 'created' : 'updated');

                    return result;
                } else {
                    const errorText = await response.text();
                    console.error('SharePoint error response:', errorText);
                    console.error('Data sent:', JSON.stringify(data, null, 2));
                    throw new Error(`SharePoint save failed: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('SharePoint save error:', error);
                return null;
            }
        }

        // Get item version history from SharePoint
        async function getVersionHistory(type, itemId) {
            const listId = type === 'projects' ? CONFIG.projectsListId : CONFIG.ticketsListId;

            try {
                const token = await getAccessToken();
                const response = await fetchWithRetry(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${listId}/items/${itemId}/versions`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                if (response.ok) {
                    const data = await response.json();
                    return data.value || [];
                } else {
                    showNotification('Failed to load version history', 'error');
                }
            } catch (error) {
                console.error('Error fetching version history:', error);
                showNotification('Error loading version history', 'error');
            }
            return [];
        }

        // Activity logging for audit trail
        function logActivity(type, item, action) {
            const activity = {
                timestamp: new Date().toISOString(),
                type: type,
                itemId: item.id,
                action: action,
                user: 'Current User', // Would be from MSAL auth
                changes: item.fields
            };

            // Store locally for quick access (also persisted in SharePoint)
            const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
            activityLog.unshift(activity);
            localStorage.setItem('activityLog', JSON.stringify(activityLog.slice(0, 100)));

            console.log('Activity logged:', activity);
        }

        function showDemoData(type) {
            // Clean slate - no demo data, start fresh
            const demoProjects = [];

            const demoTickets = [];

            if (type === 'projects') {
                projectsData = demoProjects;
                demoProjects.forEach(p => commentsData[p.id] = p.comments || []);
                updateProjectStats();
                renderItems('projects');
            } else {
                ticketsData = demoTickets;
                demoTickets.forEach(t => commentsData[t.id] = t.comments || []);
                updateTicketStats();
                renderItems('tickets');
            }
        }

        // Admin function to clear all SharePoint data - run clearAllData() in browser console
        async function clearAllData() {
            if (!confirm('WARNING: This will DELETE all projects, tickets, and tasks from SharePoint. Are you sure?')) {
                return;
            }

            const token = await getAccessToken();
            if (!token) {
                console.error('No access token available');
                return;
            }

            const deleteItems = async (listId, items, type) => {
                if (!listId || !items.length) return;
                console.log(`Deleting ${items.length} ${type}...`);

                for (const item of items) {
                    try {
                        await fetch(
                            `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${listId}/items/${item.id}`,
                            { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }
                        );
                        console.log(`Deleted ${type} ${item.id}`);
                    } catch (e) {
                        console.error(`Failed to delete ${type} ${item.id}:`, e);
                    }
                }
            };

            try {
                await deleteItems(CONFIG.tasksListId, tasksData, 'task');
                await deleteItems(CONFIG.ticketsListId, ticketsData, 'ticket');
                await deleteItems(CONFIG.projectsListId, projectsData, 'project');

                // Clear local data
                projectsData = [];
                ticketsData = [];
                tasksData = [];

                // Clear localStorage
                localStorage.clear();

                // Re-render
                updateProjectStats();
                renderItems('projects');
                renderTodosByAssignee();

                showNotification('All data cleared successfully!', 'success');
                console.log('All data cleared!');
            } catch (e) {
                console.error('Error clearing data:', e);
                showNotification('Error clearing data', 'error');
            }
        }
        window.clearAllData = clearAllData; // Expose to console

        // Stats
        function updateProjectStats() {
            const total = projectsData.length;
            const inProgress = projectsData.filter(i => i.fields.Status === 'In Progress').length;
            const high = projectsData.filter(i => ['High', 'Critical'].includes(i.fields.Priority)).length;
            const completed = projectsData.filter(i => i.fields.Status === 'Completed').length;

            // Stats cards may be removed for compact view - use null checks
            const statTotal = document.getElementById('stat-projects-total');
            const statProgress = document.getElementById('stat-projects-progress');
            const statHigh = document.getElementById('stat-projects-high');
            const statCompleted = document.getElementById('stat-projects-completed');
            const projectsCount = document.getElementById('projects-count');

            if (statTotal) statTotal.textContent = total;
            if (statProgress) statProgress.textContent = inProgress;
            if (statHigh) statHigh.textContent = high;
            if (statCompleted) statCompleted.textContent = completed;
            if (projectsCount) projectsCount.textContent = total;
        }

        function updateTicketStats() {
            const total = ticketsData.length;
            const open = ticketsData.filter(i => ['Open', 'In Progress'].includes(i.fields?.Status)).length;
            const high = ticketsData.filter(i => ['High', 'Critical'].includes(i.fields?.Priority)).length;
            const resolved = ticketsData.filter(i => ['Resolved', 'Closed'].includes(i.fields?.Status)).length;

            const statTotal = document.getElementById('stat-tickets-total');
            const statOpen = document.getElementById('stat-tickets-open');
            const statHigh = document.getElementById('stat-tickets-high');
            const statResolved = document.getElementById('stat-tickets-resolved');
            const ticketsCount = document.getElementById('tickets-count');

            if (statTotal) statTotal.textContent = total;
            if (statOpen) statOpen.textContent = open;
            if (statHigh) statHigh.textContent = high;
            if (statResolved) statResolved.textContent = resolved;
            if (ticketsCount) ticketsCount.textContent = total;
        }

        // Rendering
        function renderItems(type) {
            const view = currentViews[type];
            if (view === 'chat') {
                renderChatView(type);
            } else {
                renderKanbanView(type);
            }
        }

        function renderChatView(type) {
            const container = document.getElementById(`${type}-chat-view`);
            if (!container) return; // DOM not ready yet

            const items = type === 'projects' ? getFilteredProjects() : getFilteredTickets();

            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon"><i data-feather="${type === 'projects' ? 'folder' : 'tag'}" style="width:36px;height:36px;"></i></div>
                    <h3>No ${type} found</h3>
                    <p>Create a new item to get started</p>
                    <button class="btn btn-primary">
                        <i data-feather="plus" style="width:16px;height:16px;"></i> Add ${type === 'projects' ? 'Project' : 'Ticket'}
                    </button>
                </div>`;
                safeFeatherReplace();
                return;
            }

            container.innerHTML = items.map(item => {
                const f = item.fields;
                const title = escapeHtml(f.Title || f.LinkTitle || f.TicketTitle || 'Untitled');
                const commentCount = (commentsData[item.id] || []).length;
                const safeId = escapeAttr(item.id);
                const safeType = escapeAttr(type);

                // Type-specific info line
                let extraInfo = '';
                if (type === 'projects') {
                    const percent = parseInt(f.PercentComplete, 10) || 0;
                    const hoursInfo = f.BudgetHours ? `${f.HoursSpent || 0}/${f.BudgetHours}h` : '';
                    const projNum = escapeHtml(f.ProjectNumber || '');
                    extraInfo = `
                        ${projNum ? `<div style="font-size:11px;margin-top:4px;"><span style="background:var(--bg-secondary);padding:2px 8px;border-radius:4px;font-weight:600;color:var(--primary);">${projNum}</span></div>` : ''}
                        <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
                            <div style="flex:1;background:var(--bg-secondary);border-radius:4px;height:6px;overflow:hidden;">
                                <div style="width:${percent}%;height:100%;background:${percent >= 100 ? 'var(--success)' : 'var(--primary)'};transition:width 0.3s;"></div>
                            </div>
                            <span style="font-size:12px;font-weight:600;color:var(--primary);">${percent}%</span>
                            ${hoursInfo ? `<span style="font-size:11px;color:var(--text-secondary);">${escapeHtml(hoursInfo)}</span>` : ''}
                        </div>`;
                } else {
                    const ticketNum = escapeHtml(f.TicketNumber || '');
                    const source = escapeHtml(f.Source || '');
                    const sla = escapeHtml(f.SLAStatus || '');
                    const slaColor = sla === 'Breached' ? 'var(--danger)' : sla === 'At Risk' ? 'var(--warning)' : sla === 'On Track' ? 'var(--success)' : 'var(--text-secondary)';
                    extraInfo = `
                        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;font-size:11px;">
                            ${ticketNum ? `<span style="background:var(--bg-secondary);padding:2px 8px;border-radius:4px;font-weight:600;">${ticketNum}</span>` : ''}
                            ${source ? `<span style="color:var(--text-secondary);">via ${source}</span>` : ''}
                            ${sla && sla !== 'N/A' ? `<span style="color:${slaColor};font-weight:600;">SLA: ${sla}</span>` : ''}
                            ${f.TimeSpent ? `<span style="color:var(--text-secondary);"> ${escapeHtml(f.TimeSpent)}</span>` : ''}
                        </div>`;
                }

                return `<div class="chat-card" data-id="${safeId}" data-type="${safeType}" onclick="handleCardClick(event, '${safeId}', '${safeType}')" style="position:relative;">
                    <div class="chat-card-checkbox" onclick="event.stopPropagation(); toggleBulkSelect('${safeId}', '${safeType}')">
                        <i data-feather="check" style="width:14px;height:14px;color:white;"></i>
                    </div>
                    <div class="chat-avatar">${escapeHtml(getInitials(f.AssignedTo))}</div>
                    <div class="chat-body">
                        <div class="chat-header">
                            <span class="chat-title">${title}</span>
                            <span class="chat-time">${f.DueDate ? escapeHtml(formatDate(f.DueDate)) : ''}</span>
                        </div>
                        <div class="chat-preview">${escapeHtml(f.Description || 'No description')}</div>
                        ${extraInfo}
                        <div class="chat-footer">
                            <span class="chat-tag tag-status-${(f.Status || 'not-started').toLowerCase().replace(/\s+/g, '-')}">${escapeHtml(f.Status || 'Not Started')}</span>
                            <span class="chat-tag tag-priority-${(f.Priority || 'medium').toLowerCase()}">${escapeHtml(f.Priority || 'Medium')}</span>
                            <span class="chat-assignee">
                                <span class="chat-assignee-avatar">${escapeHtml(getInitials(f.AssignedTo))}</span>
                                ${escapeHtml(f.AssignedTo || 'Unassigned')}
                            </span>
                            ${commentCount > 0 ? `<span class="comment-count"><i data-feather="message-circle" style="width:14px;height:14px;"></i> ${commentCount}</span>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
            safeFeatherReplace();
        }

        function renderKanbanView(type) {
            const container = document.getElementById(`${type}-kanban-view`);
            if (!container) return; // DOM not ready yet

            const items = type === 'projects' ? getFilteredProjects() : getFilteredTickets();
            const archivedEl = type === 'projects'
                ? document.getElementById('projectShowArchived')
                : document.getElementById('ticketShowArchived');
            const showArchived = archivedEl ? archivedEl.checked : false;

            // Only show archived columns if "Show Archived" is checked
            let statuses = type === 'projects'
                ? ['Not Started', 'In Progress', 'On Hold']
                : ['Open', 'In Progress', 'Pending'];

            if (showArchived) {
                statuses = type === 'projects'
                    ? [...statuses, 'Completed', 'Archived']
                    : [...statuses, 'Resolved', 'Closed'];
            }

            container.innerHTML = statuses.map(status => {
                const statusItems = items.filter(i => (i.fields.Status || 'Not Started') === status);
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                return `<div class="kanban-column">
                    <div class="kanban-header ${statusClass}">
                        <span class="kanban-title">${status}</span>
                        <span class="kanban-count">${statusItems.length}</span>
                    </div>
                    <div class="kanban-cards" id="kanban-${type}-${statusClass}" data-status="${status}" data-type="${type}">
                        ${statusItems.map(item => {
                            const f = item.fields;
                            const title = escapeHtml(f.Title || f.LinkTitle || f.TicketTitle || 'Untitled');
                            const commentCount = (commentsData[item.id] || []).length;
                            const safeId = escapeAttr(item.id);
                            const priorityClass = escapeAttr((f.Priority || 'medium').toLowerCase());
                            const cardClick = type === 'projects' ? `showProjectDetail('${safeId}')` : `showModal('edit', '${escapeAttr(type)}', '${safeId}')`;
                            return `<div class="kanban-card" data-id="${safeId}" onclick="${cardClick}">
                                <div class="kanban-card-title">${title}</div>
                                <div class="kanban-card-meta">
                                    <span class="chat-tag tag-priority-${priorityClass}">${escapeHtml(f.Priority || 'Medium')}</span>
                                    <span class="chat-assignee-avatar">${escapeHtml(getInitials(f.AssignedTo))}</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <span class="comment-count">
                                        <i data-feather="message-circle" style="width:12px;height:12px;"></i> ${commentCount}
                                    </span>
                                    <span style="font-size:11px;color:var(--text-muted);">${f.DueDate ? escapeHtml(formatDate(f.DueDate)) : ''}</span>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');

            safeFeatherReplace();
            initKanbanDragDrop(type);
        }

        // Initialize Drag & Drop
        function initKanbanDragDrop(type) {
            const columns = document.querySelectorAll(`[id^="kanban-${type}"]`);
            columns.forEach(column => {
                new Sortable(column, {
                    group: `kanban-${type}`,
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: function(evt) {
                        const itemId = evt.item.dataset.id;
                        const newStatus = evt.to.dataset.status;
                        const itemType = evt.to.dataset.type;

                        // Validate archive: project can only be archived if all tasks are complete
                        if (itemType === 'projects' && newStatus === 'Archived') {
                            const archiveCheck = canArchiveProject(itemId);
                            if (!archiveCheck.canArchive) {
                                showNotification(archiveCheck.reason, 'error');
                                // Revert the drag by re-rendering
                                renderItems('projects');
                                return;
                            }
                        }

                        const items = itemType === 'projects' ? projectsData : ticketsData;
                        const item = items.find(i => String(i.id) === String(itemId));
                        if (item) {
                            item.fields.Status = newStatus;
                            if (itemType === 'projects') updateProjectStats();
                            else updateTicketStats();
                            renderTodosByAssignee();
                        }
                    }
                });
            });
        }

        // Filters
        // Archived statuses
        const ARCHIVED_PROJECT_STATUSES = ['Completed', 'Archived'];
        const ARCHIVED_TICKET_STATUSES = ['Resolved', 'Closed'];

        function getFilteredProjects() {
            const searchEl = document.getElementById('projectSearchInput');
            const statusEl = document.getElementById('projectStatusFilter');
            const priorityEl = document.getElementById('projectPriorityFilter');
            const archivedEl = document.getElementById('projectShowArchived');

            const search = searchEl ? searchEl.value.toLowerCase() : '';
            const status = statusEl ? statusEl.value : '';
            const priority = priorityEl ? priorityEl.value : '';
            const showArchived = archivedEl ? archivedEl.checked : false;

            if (!projectsData) return [];

            return projectsData.filter(item => {
                const f = item.fields;
                const itemStatus = f.Status || 'Not Started';

                // Hide archived unless checkbox is checked or specific status selected
                if (!showArchived && !status && ARCHIVED_PROJECT_STATUSES.includes(itemStatus)) return false;

                if (search && !(f.Title || f.LinkTitle || '').toLowerCase().includes(search) && !(f.Description || '').toLowerCase().includes(search)) return false;
                if (status && itemStatus !== status) return false;
                if (priority && f.Priority !== priority) return false;
                return true;
            });
        }

        function getFilteredTickets() {
            const searchEl = document.getElementById('ticketSearchInput');
            const statusEl = document.getElementById('ticketStatusFilter');
            const priorityEl = document.getElementById('ticketPriorityFilter');
            const archivedEl = document.getElementById('ticketShowArchived');

            const search = searchEl ? searchEl.value.toLowerCase() : '';
            const status = statusEl ? statusEl.value : '';
            const priority = priorityEl ? priorityEl.value : '';
            const showArchived = archivedEl ? archivedEl.checked : false;

            if (!ticketsData) return [];

            return ticketsData.filter(item => {
                const f = item.fields;
                const itemStatus = f.Status || 'Open';

                // Hide archived unless checkbox is checked or specific status selected
                if (!showArchived && !status && ARCHIVED_TICKET_STATUSES.includes(itemStatus)) return false;

                if (search && !(f.TicketTitle || '').toLowerCase().includes(search) && !(f.Description || '').toLowerCase().includes(search)) return false;
                if (status && itemStatus !== status) return false;
                if (priority && f.Priority !== priority) return false;
                return true;
            });
        }

        function filterItems(type) { renderItems(type); }

        // Tools Index
        function renderToolsIndex() {
            const container = document.getElementById('tools-container');
            let totalTools = 0;

            container.innerHTML = Object.entries(TOOLS_INDEX).map(([category, data]) => {
                totalTools += data.tools.length;
                const containerName = data.container;
                return `<div class="tool-category">
                    <div class="category-header">
                        <div class="category-icon ${escapeAttr(data.icon)}">
                            <i data-feather="${escapeAttr(getCategoryIcon(data.icon))}" style="width:22px;height:22px;"></i>
                        </div>
                        <div style="flex:1;">
                            <div class="category-title">${escapeHtml(category)}</div>
                            <div class="category-count">${data.tools.length} tools</div>
                        </div>
                        ${containerName ? `
                        <div style="display:flex;align-items:center;gap:6px;padding:4px 10px;background:var(--bg);border-radius:12px;font-size:11px;">
                            <i data-feather="box" style="width:12px;height:12px;color:var(--primary);"></i>
                            <span style="color:var(--text-secondary);">${escapeHtml(containerName)}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="tools-grid">
                        ${data.tools.map(tool => {
                            const hasContainer = tool.containerTool && containerName;
                            return `<div class="tool-card" data-container="${escapeAttr(containerName || '')}" data-container-tool="${escapeAttr(tool.containerTool || '')}">
                            <div class="tool-name">
                                <i data-feather="${hasContainer ? 'box' : 'file'}" class="file-icon" style="width:14px;height:14px;${hasContainer ? 'color:var(--primary);' : ''}"></i>
                                ${escapeHtml(tool.name)}
                                ${tool.isWebApp ? '<span style="background:var(--success);color:white;font-size:9px;padding:1px 5px;border-radius:8px;margin-left:6px;">WEB</span>' : ''}
                            </div>
                            <div class="tool-description">${escapeHtml(tool.desc)}</div>
                            <div class="tool-actions">
                                <button class="tool-action-btn" title="View Code">
                                    <i data-feather="code" style="width:14px;height:14px;"></i>
                                </button>
                                <button class="tool-action-btn ${hasContainer ? 'container-run-btn' : ''}" title="${hasContainer ? 'Run in Container' : 'Run Tool'}" style="${hasContainer ? 'background:var(--primary);color:white;' : ''}">
                                    <i data-feather="${hasContainer ? 'box' : 'play'}" style="width:14px;height:14px;"></i>
                                </button>
                                <button class="tool-action-btn" title="Documentation">
                                    <i data-feather="book-open" style="width:14px;height:14px;"></i>
                                </button>
                            </div>
                        </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');

            document.getElementById('tools-count').textContent = totalTools;
            safeFeatherReplace();

            // Attach event listeners to dynamically created tool buttons
            document.querySelectorAll('.tool-card').forEach(card => {
                const toolName = card.querySelector('.tool-name').textContent.trim().replace('WEB', '').trim();
                const toolDesc = card.querySelector('.tool-description').textContent.trim();
                const category = card.closest('.tool-category').querySelector('.category-title').textContent;
                const buttons = card.querySelectorAll('.tool-action-btn');

                // View Code button
                if (buttons[0]) buttons[0].addEventListener('click', () => viewToolCode(toolName));
                // Run Tool button
                if (buttons[1]) buttons[1].addEventListener('click', () => runTool(toolName));
                // Documentation button
                if (buttons[2]) buttons[2].addEventListener('click', () => showToolDocs(toolName));
            });
        }

        function getCategoryIcon(type) {
            const icons = { data: 'database', network: 'wifi', document: 'file-text', automation: 'activity', agent: 'cpu', config: 'settings' };
            return icons[type] || 'file';
        }

        function filterTools() {
            const search = document.getElementById('toolSearchInput').value.toLowerCase();
            document.querySelectorAll('.tool-card').forEach(card => {
                const name = card.querySelector('.tool-name').textContent.toLowerCase();
                const desc = card.querySelector('.tool-description').textContent.toLowerCase();
                card.style.display = (name.includes(search) || desc.includes(search)) ? 'block' : 'none';
            });
        }

        // Tool Modal and Actions
        function showToolModal(name, desc, category) {
            const toolInfo = getToolInfo(name);
            const safeName = escapeHtml(name);
            const safeRelatedTools = toolInfo.relatedTools ? toolInfo.relatedTools.map(t => escapeHtml(t)).join(', ') : '';

            document.getElementById('toolModalTitle').textContent = name;
            document.getElementById('toolModalCategory').textContent = category;
            document.getElementById('toolModalDesc').textContent = desc;
            document.getElementById('toolModalDetails').innerHTML = `
                <div class="tool-detail-row">
                    <span class="tool-detail-label">File Type:</span>
                    <span class="tool-detail-value">${name.endsWith('.py') ? 'Python Script' : name.endsWith('.html') ? 'HTML Application' : 'Script'}</span>
                </div>
                <div class="tool-detail-row">
                    <span class="tool-detail-label">Location:</span>
                    <span class="tool-detail-value">/home/mavrick/Projects/Secondbrain/${safeName}</span>
                </div>
                <div class="tool-detail-row">
                    <span class="tool-detail-label">Status:</span>
                    <span class="tool-detail-value" style="color:var(--success);">Available</span>
                </div>
                ${toolInfo.relatedTools ? `
                <div class="tool-detail-row">
                    <span class="tool-detail-label">Related Tools:</span>
                    <span class="tool-detail-value">${safeRelatedTools}</span>
                </div>` : ''}
            `;
            document.getElementById('currentToolName').value = name;
            document.getElementById('toolModal').style.display = 'flex';
            safeFeatherReplace();
        }

        function closeToolModal() {
            document.getElementById('toolModal').style.display = 'none';
        }

        function getToolInfo(name) {
            const toolRelations = {
                'sharepoint_importer.py': { relatedTools: ['download_sharepoint.py', 'process_sharepoint.py'] },
                'call_flow_processor.py': { relatedTools: ['call_flow_generator.py', 'call_flow_web.py'] },
                'query_brain.py': { relatedTools: ['vector_store.py', 'rag_web.py'] },
                'engineering_tracker.py': { relatedTools: ['daily_engineering_summary.py', 'ee_team_dashboard.py'] },
                'agent_orchestrator.py': { relatedTools: ['agent_notebooklm_analyst.py', 'mcp_obsidian_server.py'] }
            };
            return toolRelations[name] || {};
        }

        function viewToolCode(name) {
            // For web context, open in GitHub or show code viewer
            const githubBase = 'https://github.com/your-repo/secondbrain/blob/main/';
            const safeName = escapeHtml(name);

            // Show code in AI panel for analysis
            toggleAIPanel('claude');
            const messages = document.getElementById('aiChatMessages');
            messages.innerHTML += `<div class="ai-message user">
                <div class="ai-message-avatar"><i data-feather="user" style="width:14px;height:14px;"></i></div>
                <div class="ai-message-content">Show me the code for ${safeName}</div>
            </div>`;

            setTimeout(() => {
                messages.innerHTML += `<div class="ai-message assistant">
                    <div class="ai-message-avatar"><i data-feather="cpu" style="width:14px;height:14px;"></i></div>
                    <div class="ai-message-content">
                        <strong>${safeName}</strong><br><br>
                        To view the code, you can:<br>
                        <ul style="margin:8px 0 0 16px;font-size:13px;">
                            <li>Open in VS Code: <code>code /home/mavrick/Projects/Secondbrain/${safeName}</code></li>
                            <li>View in terminal: <code>cat ${safeName}</code></li>
                            <li>Open in GitHub (if synced)</li>
                        </ul>
                        <br>
                        Would you like me to explain what this tool does?
                    </div>
                </div>`;
                messages.scrollTop = messages.scrollHeight;
                safeFeatherReplace();
            }, 500);

            closeToolModal();
        }

        // ========================================
        // CONTAINER API FUNCTIONS
        // ========================================

        async function checkContainerHealth(serviceName) {
            const service = CONTAINER_CONFIG.services[serviceName];
            if (!service) return { healthy: false, error: 'Unknown service' };

            try {
                const url = `${CONTAINER_CONFIG.gateway}${service.endpoint}/health`;
                const response = await fetch(url, { method: 'GET', timeout: 5000 });
                if (response.ok) {
                    return { healthy: true, data: await response.json() };
                }
                return { healthy: false, status: response.status };
            } catch (error) {
                return { healthy: false, error: error.message };
            }
        }

        async function runContainerTool(containerName, toolName, args = {}) {
            const service = CONTAINER_CONFIG.services[containerName];
            if (!service) {
                showNotification(`Unknown container: ${containerName}`, 'error');
                return null;
            }

            try {
                const url = `${CONTAINER_CONFIG.gateway}${service.endpoint}/run/${toolName}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ args: args })
                });

                if (response.ok) {
                    const data = await response.json();
                    containerJobs[data.job_id] = {
                        ...data,
                        container: containerName,
                        tool: toolName,
                        startTime: new Date()
                    };
                    showNotification(`Job started: ${data.job_id}`, 'success');
                    updateJobsPanel();
                    return data;
                } else {
                    const error = await response.json();
                    showNotification(`Failed to start job: ${error.error || response.statusText}`, 'error');
                    return null;
                }
            } catch (error) {
                showNotification(`Container error: ${error.message}`, 'error');
                return null;
            }
        }

        async function getContainerJobStatus(containerName, jobId) {
            const service = CONTAINER_CONFIG.services[containerName];
            if (!service) return null;

            try {
                const url = `${CONTAINER_CONFIG.gateway}${service.endpoint}/jobs/${jobId}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    containerJobs[jobId] = { ...containerJobs[jobId], ...data };
                    return data;
                }
            } catch (error) {
                console.error('Failed to get job status:', error);
            }
            return null;
        }

        async function refreshAllJobs() {
            for (const [jobId, job] of Object.entries(containerJobs)) {
                if (job.status === 'queued' || job.status === 'running') {
                    await getContainerJobStatus(job.container, jobId);
                }
            }
            updateJobsPanel();
        }

        function updateJobsPanel() {
            const panel = document.getElementById('containerJobsPanel');
            if (!panel) return;

            const jobs = Object.values(containerJobs).sort((a, b) =>
                new Date(b.created_at || b.startTime) - new Date(a.created_at || a.startTime)
            ).slice(0, 10);

            if (jobs.length === 0) {
                panel.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:10px;">No recent jobs</div>';
                return;
            }

            panel.innerHTML = jobs.map(job => {
                const statusColor = {
                    'queued': 'var(--warning)',
                    'running': 'var(--primary)',
                    'completed': 'var(--success)',
                    'failed': 'var(--danger)',
                    'error': 'var(--danger)',
                    'timeout': 'var(--warning)'
                }[job.status] || 'var(--text-muted)';

                const statusIcon = {
                    'queued': 'clock',
                    'running': 'loader',
                    'completed': 'check-circle',
                    'failed': 'x-circle',
                    'error': 'alert-circle',
                    'timeout': 'alert-triangle'
                }[job.status] || 'help-circle';

                return `<div class="job-item" style="padding:8px;border-bottom:1px solid var(--border);font-size:12px;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <i data-feather="${escapeAttr(statusIcon)}" style="width:14px;height:14px;color:${statusColor};${job.status === 'running' ? 'animation:spin 1s linear infinite;' : ''}"></i>
                        <span style="font-weight:500;">${escapeHtml(job.tool || job.id)}</span>
                        <span style="color:var(--text-muted);margin-left:auto;">${escapeHtml(job.container)}</span>
                    </div>
                    <div style="color:${statusColor};margin-top:4px;">${escapeHtml(job.status)}</div>
                    ${job.error ? `<div style="color:var(--danger);font-size:11px;margin-top:4px;">${escapeHtml(job.error.substring(0, 100))}</div>` : ''}
                </div>`;
            }).join('');

            safeFeatherReplace();
        }

        function findToolContainer(toolName) {
            for (const [category, data] of Object.entries(TOOLS_INDEX)) {
                const tool = data.tools.find(t => t.name === toolName);
                if (tool && tool.containerTool && data.container) {
                    return { container: data.container, containerTool: tool.containerTool, isWebApp: tool.isWebApp };
                }
            }
            return null;
        }

        function runTool(name) {
            const safeName = escapeHtml(name);
            const containerInfo = findToolContainer(name);

            // If tool has container support, offer both options
            if (containerInfo) {
                showRunToolModal(name, containerInfo);
                return;
            }

            // Fallback to local command instructions
            const toolCommands = {
                'engineering_tracker.py': 'source venv/bin/activate && python engineering_tracker.py',
                'daily_engineering_summary.py': 'source venv/bin/activate && python daily_engineering_summary.py',
                'call_flow_web.py': 'source venv/bin/activate && python call_flow_web.py',
                'query_brain.py': 'source venv/bin/activate && python query_brain.py',
                'rag_web.py': 'source venv/bin/activate && python rag_web.py',
                'rebuild_index.py': 'source venv/bin/activate && python rebuild_index.py',
                'contract_tracker.py': 'source venv/bin/activate && python contract_tracker.py'
            };

            const command = toolCommands[name] || `source venv/bin/activate && python ${safeName}`;
            const safeCommand = escapeHtml(command);

            toggleAIPanel('gemini');
            const messages = document.getElementById('aiChatMessages');
            messages.innerHTML += `<div class="ai-message user">
                <div class="ai-message-avatar"><i data-feather="user" style="width:14px;height:14px;"></i></div>
                <div class="ai-message-content">Run ${safeName}</div>
            </div>`;

            setTimeout(() => {
                messages.innerHTML += `<div class="ai-message assistant">
                    <div class="ai-message-avatar"><i data-feather="cpu" style="width:14px;height:14px;"></i></div>
                    <div class="ai-message-content">
                        <strong>${safeName}</strong><br><br>
                        This tool is not containerized. Run locally:<br>
                        <code style="display:block;background:#1e293b;color:#e2e8f0;padding:10px;border-radius:6px;margin:8px 0;font-size:12px;">
                        cd /home/mavrick/Projects/Secondbrain<br>
                        ${safeCommand}
                        </code>
                    </div>
                </div>`;
                messages.scrollTop = messages.scrollHeight;
                safeFeatherReplace();
            }, 300);

            closeToolModal();
        }

        function showRunToolModal(name, containerInfo) {
            const safeName = escapeHtml(name);
            const safeContainer = escapeHtml(containerInfo.container);
            const safeTool = escapeHtml(containerInfo.containerTool);

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'runToolModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
            modal.innerHTML = `
                <div style="background:var(--card-bg);border-radius:12px;padding:24px;max-width:450px;width:90%;box-shadow:var(--shadow-lg);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;font-size:16px;">Run ${safeName}</h3>
                        <button onclick="document.getElementById('runToolModal').remove()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);">
                            <i data-feather="x" style="width:20px;height:20px;"></i>
                        </button>
                    </div>

                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <button id="runInContainerBtn" class="btn btn-primary" style="padding:12px;display:flex;align-items:center;gap:10px;justify-content:center;">
                            <i data-feather="box" style="width:18px;height:18px;"></i>
                            Run in Container
                            <span style="font-size:11px;opacity:0.8;">(${safeContainer})</span>
                        </button>

                        ${containerInfo.isWebApp ? `
                        <button id="openWebAppBtn" class="btn" style="padding:12px;display:flex;align-items:center;gap:10px;justify-content:center;background:var(--success);">
                            <i data-feather="external-link" style="width:18px;height:18px;"></i>
                            Open Web App
                        </button>
                        ` : ''}

                        <button id="showLocalCmdBtn" class="btn btn-secondary" style="padding:12px;display:flex;align-items:center;gap:10px;justify-content:center;">
                            <i data-feather="terminal" style="width:18px;height:18px;"></i>
                            Show Local Command
                        </button>
                    </div>

                    <div id="containerStatus" style="margin-top:16px;padding:10px;background:var(--bg);border-radius:8px;font-size:12px;display:none;">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            safeFeatherReplace();

            // Check container health
            checkContainerHealth(containerInfo.container).then(health => {
                const statusDiv = document.getElementById('containerStatus');
                if (health.healthy) {
                    statusDiv.innerHTML = `<span style="color:var(--success);">Container healthy</span>`;
                } else {
                    statusDiv.innerHTML = `<span style="color:var(--warning);">Container offline - start with: docker-compose up -d ${safeContainer}</span>`;
                }
                statusDiv.style.display = 'block';
            });

            // Bind button events
            document.getElementById('runInContainerBtn').onclick = async () => {
                const btn = document.getElementById('runInContainerBtn');
                btn.disabled = true;
                btn.innerHTML = '<i data-feather="loader" style="width:18px;height:18px;animation:spin 1s linear infinite;"></i> Starting...';
                safeFeatherReplace();

                const result = await runContainerTool(containerInfo.container, containerInfo.containerTool);
                modal.remove();

                if (result) {
                    // Start polling for job status
                    const pollInterval = setInterval(async () => {
                        const status = await getContainerJobStatus(containerInfo.container, result.job_id);
                        if (status && ['completed', 'failed', 'error', 'timeout'].includes(status.status)) {
                            clearInterval(pollInterval);
                            if (status.status === 'completed') {
                                showNotification(`Job completed: ${result.job_id}`, 'success');
                            } else {
                                showNotification(`Job ${status.status}: ${result.job_id}`, 'error');
                            }
                            updateJobsPanel();
                        }
                    }, 2000);
                }
            };

            if (containerInfo.isWebApp) {
                document.getElementById('openWebAppBtn').onclick = () => {
                    const service = CONTAINER_CONFIG.services[containerInfo.container];
                    const url = `${CONTAINER_CONFIG.gateway}${service.endpoint}/`;
                    window.open(url, '_blank');
                    modal.remove();
                };
            }

            document.getElementById('showLocalCmdBtn').onclick = () => {
                modal.remove();
                // Show local command in AI panel
                const command = `source venv/bin/activate && python ${name}`;
                toggleAIPanel('gemini');
                const messages = document.getElementById('aiChatMessages');
                messages.innerHTML += `<div class="ai-message assistant">
                    <div class="ai-message-avatar"><i data-feather="terminal" style="width:14px;height:14px;"></i></div>
                    <div class="ai-message-content">
                        <strong>Local command for ${safeName}</strong><br><br>
                        <code style="display:block;background:#1e293b;color:#e2e8f0;padding:10px;border-radius:6px;margin:8px 0;font-size:12px;">
                        cd /home/mavrick/Projects/Secondbrain<br>
                        ${escapeHtml(command)}
                        </code>
                    </div>
                </div>`;
                messages.scrollTop = messages.scrollHeight;
                safeFeatherReplace();
            };

            // Close on overlay click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        function showToolDocs(name) {
            const toolDocs = {
                'engineering_tracker.py': 'Manages engineering projects and tickets via SharePoint Lists. Provides CRUD operations and dashboard generation.',
                'daily_engineering_summary.py': 'Generates and sends daily email summaries of engineering projects and tickets. Runs on schedule (4 PM M-F).',
                'call_flow_processor.py': 'Processes customer call flow documents (Word files) and extracts structured data like phone numbers, hours, and routing.',
                'query_brain.py': 'RAG (Retrieval-Augmented Generation) query engine. Searches the vector database and returns relevant context.',
                'agent_orchestrator.py': 'Multi-agent orchestration system for coordinating AI agents on complex tasks.',
                'sharepoint_importer.py': 'Imports documents from SharePoint sites into the local knowledge base.',
                'vector_store.py': 'ChromaDB vector storage utilities for semantic search indexing.',
                'mcp_obsidian_server.py': 'Model Context Protocol server for Obsidian vault integration with AI tools.'
            };

            const safeName = escapeHtml(name);
            const doc = toolDocs[name] || `${safeName} - Python utility script for the Second Brain system.`;
            const safeDoc = escapeHtml(doc);

            toggleAIPanel('claude');
            const messages = document.getElementById('aiChatMessages');
            messages.innerHTML += `<div class="ai-message user">
                <div class="ai-message-avatar"><i data-feather="user" style="width:14px;height:14px;"></i></div>
                <div class="ai-message-content">Show documentation for ${safeName}</div>
            </div>`;

            setTimeout(() => {
                messages.innerHTML += `<div class="ai-message assistant">
                    <div class="ai-message-avatar"><i data-feather="cpu" style="width:14px;height:14px;"></i></div>
                    <div class="ai-message-content">
                        <strong>${safeName}</strong><br><br>
                        ${safeDoc}<br><br>
                        <strong>Usage:</strong><br>
                        <code style="display:block;background:#1e293b;color:#e2e8f0;padding:10px;border-radius:6px;margin:8px 0;font-size:12px;">
                        python ${safeName} --help
                        </code>
                        Would you like me to explain any specific functionality?
                    </div>
                </div>`;
                messages.scrollTop = messages.scrollHeight;
                safeFeatherReplace();
            }, 500);

            closeToolModal();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show brief confirmation
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i data-feather="check" style="width:12px;height:12px;"></i> Copied!';
                btn.style.background = 'var(--success)';
                safeFeatherReplace();
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    safeFeatherReplace();
                }, 2000);
            });
        }

        // To-Do by Assignee - Flat Task View (only tasks linked to projects)
        function renderTodosByAssignee() {
            // Guard against uninitialized data
            if (!Array.isArray(tasksData) || !Array.isArray(ticketsData)) {
                console.log('renderTodosByAssignee: Data not initialized (not arrays)');
                return;
            }

            console.log(`renderTodosByAssignee: ${tasksData.length} tasks, ${ticketsData.length} tickets`);

            // Build ticket lookup map for O(1) access
            const ticketMap = {};
            ticketsData.forEach(ticket => {
                ticketMap[String(ticket.id)] = ticket;
            });

            // Filter tasks: only those linked to projects (via ticket with ProjectID/RelatedProject)
            const tasksLinkedToProjects = tasksData.filter(task => {
                const ticketId = task.fields?.TicketID;
                if (!ticketId) return false;

                const ticket = ticketMap[String(ticketId)];
                if (!ticket) return false;

                // Task is linked to project if ticket has ProjectID or RelatedProject
                return ticket.fields?.ProjectID || ticket.fields?.RelatedProject;
            });

            // Filter out completed tasks
            const activeTasks = tasksLinkedToProjects.filter(task =>
                !['Done', 'Completed', 'Closed'].includes(task.fields?.Status)
            );

            // Group by assignee
            const assigneeMap = {};
            activeTasks.forEach(task => {
                const assignee = task.fields?.AssignedTo || 'Unassigned';
                if (!assigneeMap[assignee]) {
                    assigneeMap[assignee] = { tasks: [], highPriority: 0 };
                }

                const ticket = ticketMap[String(task.fields?.TicketID)];

                assigneeMap[assignee].tasks.push({
                    id: task.id,
                    title: task.fields?.TaskTitle || 'Untitled Task',
                    status: task.fields?.Status || 'To Do',
                    priority: task.fields?.Priority || 'Medium',
                    phase: task.fields?.Phase || 'Execution',
                    projectName: ticket?.fields?.RelatedProject || '',
                    ticketTitle: ticket?.fields?.TicketTitle || ''
                });

                if (['High', 'Critical'].includes(task.fields?.Priority)) {
                    assigneeMap[assignee].highPriority++;
                }
            });

            // Populate quick add dropdown
            const dropdown = document.getElementById('quickAddAssignee');
            const allAssignees = [...new Set([...Object.keys(assigneeMap), ...adUsers.map(u => u.displayName)])];
            dropdown.innerHTML = '<option value="">Assign to...</option>' + allAssignees.sort().map(a => `<option value="${a}">${a}</option>`).join('');

            // Update count
            document.getElementById('todos-count').textContent = activeTasks.length;

            // Build project lookup map for checking archived status
            const projectMap = {};
            projectsData.forEach(project => {
                const title = project.fields?.Title || '';
                projectMap[title] = project;
            });

            // Get completed tasks from last 7 days (only from non-archived projects)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const completedTasks = tasksLinkedToProjects.filter(task => {
                if (!['Done', 'Completed', 'Closed'].includes(task.fields?.Status)) return false;
                const modified = task.fields?.Modified ? new Date(task.fields.Modified) : null;
                if (!modified || modified < sevenDaysAgo) return false;

                // Check if project is archived
                const ticket = ticketMap[String(task.fields?.TicketID)];
                const projectName = ticket?.fields?.RelatedProject || '';
                const project = projectMap[projectName];
                if (project && project.fields?.Status === 'Archived') return false;

                return true;
            }).map(task => {
                const ticket = ticketMap[String(task.fields?.TicketID)];
                return {
                    id: task.id,
                    title: task.fields?.TaskTitle || 'Untitled Task',
                    status: task.fields?.Status || 'Done',
                    projectName: ticket?.fields?.RelatedProject || '',
                    completedDate: task.fields?.Modified
                };
            });

            const showCompleted = document.getElementById('showCompletedTasks')?.checked || false;

            // Render flat task cards grouped by assignee
            const container = document.getElementById('assignee-sections');

            // Show message if no active tasks
            if (Object.keys(assigneeMap).length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                        <i data-feather="check-circle" style="width:48px;height:48px;margin-bottom:12px;opacity:0.5;"></i>
                        <p style="font-size:16px;">No active tasks linked to projects</p>
                        <p style="font-size:14px;opacity:0.7;">Tasks will appear here when linked to projects via tickets</p>
                    </div>
                `;
            } else {
                container.innerHTML = Object.entries(assigneeMap)
                    .sort((a, b) => b[1].tasks.length - a[1].tasks.length)
                    .map(([assignee, data]) => `
                    <div class="assignee-section">
                        <div class="assignee-header">
                            <div class="assignee-avatar-lg">${getInitials(escapeHtml(assignee))}</div>
                            <div class="assignee-info">
                                <div class="assignee-name">${escapeHtml(assignee)}</div>
                                <div class="assignee-stats">
                                    <span class="assignee-stat"><strong>${data.tasks.length}</strong> active tasks</span>
                                    ${data.highPriority > 0 ? `<span class="assignee-stat"><strong>${data.highPriority}</strong> high priority</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="todo-list">
                            ${data.tasks.map(task => `
                                <div class="todo-task-item" data-task-id="${task.id}" onclick="openTaskDetail('${task.id}')" style="cursor:pointer;">
                                    <div class="todo-checkbox" onclick="event.stopPropagation(); toggleTaskStatus('${task.id}')"></div>
                                    <div class="todo-task-content">
                                        <div class="todo-task-title">${escapeHtml(task.title)}</div>
                                        <div class="todo-meta">
                                            ${task.projectName ? `<span class="chat-tag tag-project"><i data-feather="folder" style="width:10px;height:10px;"></i> ${escapeHtml(task.projectName)}</span>` : ''}
                                            <span class="chat-tag tag-phase">${escapeHtml(task.phase)}</span>
                                            <span class="chat-tag tag-priority-${escapeHtml(task.priority.toLowerCase())}">${escapeHtml(task.priority)}</span>
                                            <span class="chat-tag tag-status-${escapeHtml(task.status.toLowerCase().replace(/\\s+/g, '-'))}">${escapeHtml(task.status)}</span>
                                        </div>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // Add completed section toggle and tasks (always show)
            const completedSection = `
                <div class="completed-toggle-section" style="margin-top:20px;padding:15px;background:var(--surface-darker);border-radius:var(--radius-md);">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px;color:var(--text-secondary);">
                        <input type="checkbox" id="showCompletedTasks" ${showCompleted ? 'checked' : ''} onchange="renderTodosByAssignee()" style="width:16px;height:16px;">
                        <i data-feather="check-circle" style="width:16px;height:16px;"></i>
                        Show recently completed (${completedTasks.length} in last 7 days)
                    </label>
                    ${showCompleted && completedTasks.length > 0 ? `
                        <div class="completed-tasks-list" style="margin-top:15px;opacity:0.7;">
                            ${completedTasks.map(task => `
                                <div class="todo-task-item completed" data-task-id="${task.id}" style="cursor:pointer;text-decoration:line-through;" onclick="openTaskDetail('${task.id}')">
                                    <div class="todo-checkbox checked">
                                        <i data-feather="check" style="width:12px;height:12px;"></i>
                                    </div>
                                    <div class="todo-task-content">
                                        <div class="todo-task-title" style="color:var(--text-muted);">${escapeHtml(task.title)}</div>
                                        <div class="todo-meta">
                                            ${task.projectName ? `<span class="chat-tag tag-project"><i data-feather="folder" style="width:10px;height:10px;"></i> ${escapeHtml(task.projectName)}</span>` : ''}
                                            <span class="chat-tag" style="background:var(--success);color:white;">${escapeHtml(task.status)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            container.innerHTML += completedSection;

            safeFeatherReplace();
        }

        // Toggle ticket tasks visibility
        function toggleTicketTasks(ticketId) {
            const tasksList = document.getElementById(`tasks-${ticketId}`);
            const ticketGroup = tasksList?.closest('.todo-ticket-group');
            const icon = ticketGroup?.querySelector('.ticket-expand-icon');

            if (tasksList) {
                const isHidden = tasksList.style.display === 'none';
                tasksList.style.display = isHidden ? 'block' : 'none';
                if (icon) {
                    icon.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
                }
            }
        }

        // Toggle task status (checkbox)
        async function toggleTaskStatus(taskId) {
            const task = tasksData.find(t => String(t.id) === String(taskId));
            if (!task) return;

            const currentStatus = task.fields?.Status || 'To Do';
            const newStatus = ['Done', 'Completed', 'Closed'].includes(currentStatus) ? 'To Do' : 'Done';
            task.fields.Status = newStatus;

            // Update in SharePoint if configured
            if (CONFIG.siteId && !CONFIG.siteId.includes('{{') && CONFIG.tasksListId) {
                try {
                    const token = await getAccessToken();
                    const response = await fetch(
                        `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.tasksListId}/items/${taskId}/fields`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ Status: newStatus })
                        }
                    );
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`SharePoint API error ${response.status}: ${errorText}`);
                    }
                    console.log(`Task ${taskId} status updated to ${newStatus}`);
                } catch (error) {
                    console.error('Error updating task status:', error);
                    // Revert local change on failure
                    task.fields.Status = currentStatus;
                    renderTodosByAssignee();
                }
            }

            renderTodosByAssignee();
        }

        // Toggle ticket status
        async function toggleTicketStatus(ticketId) {
            const ticket = ticketsData.find(t => String(t.id) === String(ticketId));
            if (!ticket) return;

            const currentStatus = ticket.fields?.Status || 'Open';
            const newStatus = ['Resolved', 'Closed'].includes(currentStatus) ? 'Open' : 'Resolved';
            ticket.fields.Status = newStatus;

            // Update in SharePoint if configured
            if (CONFIG.siteId && !CONFIG.siteId.includes('{{') && CONFIG.ticketsListId) {
                try {
                    const token = await getAccessToken();
                    const response = await fetch(
                        `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.ticketsListId}/items/${ticketId}/fields`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ Status: newStatus })
                        }
                    );
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`SharePoint API error ${response.status}: ${errorText}`);
                    }
                    console.log(`Ticket ${ticketId} status updated to ${newStatus}`);
                } catch (error) {
                    console.error('Error updating ticket status:', error);
                    // Revert local change on failure
                    ticket.fields.Status = currentStatus;
                }
            }

            updateTicketStats();
            renderTodosByAssignee();
        }

        // Planner
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function renderPlanner() {
            // Guard against uninitialized data
            if (!Array.isArray(projectsData) || !Array.isArray(ticketsData)) {
                console.log('renderPlanner: Data not ready yet');
                return;
            }

            const plannerDate = document.getElementById('planner-date');
            const grid = document.getElementById('planner-grid');

            // Guard against missing planner elements (planner was removed from UI)
            if (!plannerDate || !grid) {
                console.log('renderPlanner: Planner elements not found in DOM, skipping');
                return;
            }

            const endOfWeek = new Date(currentWeekStart);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            plannerDate.textContent = `${currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date(); today.setHours(0, 0, 0, 0);

            grid.innerHTML = days.map((day, i) => {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const isToday = date.getTime() === today.getTime();
                const dateStr = date.toISOString().split('T')[0];
                const dayTasks = [...projectsData, ...ticketsData].filter(item => item.fields?.DueDate && item.fields.DueDate.startsWith(dateStr));

                return `<div class="day-column ${isToday ? 'today' : ''}">
                    <div class="day-header">
                        <div class="day-name">${day}</div>
                        <div class="day-date">${date.getDate()}</div>
                    </div>
                    <div class="day-tasks">
                        ${dayTasks.map(task => {
                            const title = task.fields.Title || task.fields.TicketTitle || 'Untitled';
                            const priority = (task.fields.Priority || 'medium').toLowerCase();
                            return `<div class="day-task priority-${priority}">${title}</div>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function navigateWeek(dir) { currentWeekStart.setDate(currentWeekStart.getDate() + (dir * 7)); renderPlanner(); }
        function goToToday() { currentWeekStart = getWeekStart(new Date()); renderPlanner(); }

        function quickAddTask() {
            const title = document.getElementById('quickAddInput').value.trim();
            const assignee = document.getElementById('quickAddAssignee').value;
            if (!title) { alert('Please enter a task title'); return; }

            ticketsData.push({
                id: 'new-' + Date.now(),
                fields: { TicketTitle: title, Status: 'Open', Priority: 'Medium', AssignedTo: assignee || 'Unassigned', DueDate: new Date().toISOString().split('T')[0] }
            });

            document.getElementById('quickAddInput').value = '';
            updateTicketStats();
            renderTodosByAssignee();
            renderPlanner();
        }

        function toggleTodo(type, itemId) {
            const items = type === 'projects' ? projectsData : ticketsData;
            const item = items.find(i => String(i.id) === String(itemId));
            if (item) {
                const completed = ['Completed', 'Resolved', 'Closed'].includes(item.fields.Status);
                item.fields.Status = completed ? 'In Progress' : (type === 'projects' ? 'Completed' : 'Resolved');
            }
            if (type === 'projects') updateProjectStats(); else updateTicketStats();
            renderItems(type);
            renderTodosByAssignee();
        }

        // Open task detail - opens the parent project detail modal
        function openTaskDetail(taskId) {
            const task = tasksData.find(t => String(t.id) === String(taskId));
            if (task && task.fields.ProjectID) {
                showProjectDetail(task.fields.ProjectID);
            } else {
                console.warn('Task not found or has no parent project:', taskId);
            }
        }

        // Modal
        function showModal(mode, type, itemId = null) {
            const modal = document.getElementById('modal');
            document.getElementById('itemType').value = type;

            // Show/hide type-specific fields
            document.getElementById('projectFields').style.display = type === 'projects' ? 'block' : 'none';
            document.getElementById('ticketFields').style.display = type === 'tickets' ? 'block' : 'none';

            // Populate Related Project dropdown for tickets
            if (type === 'tickets') {
                const projectSelect = document.getElementById('ticketRelatedProject');
                projectSelect.innerHTML = '<option value="">None</option>' +
                    projectsData.map(p => `<option value="${p.fields.Title || p.fields.LinkTitle}">${p.fields.Title || p.fields.LinkTitle}</option>`).join('');
            }

            if (mode === 'add') {
                document.getElementById('modalTitle').textContent = `New ${type === 'projects' ? 'Project' : 'Ticket'}`;
                clearForm(type);
                document.getElementById('commentsList').innerHTML = '';

                // Auto-generate ticket number for new tickets
                if (type === 'tickets') {
                    const ticketNum = 'TKT-' + String(ticketsData.length + 1).padStart(4, '0');
                    document.getElementById('ticketNumber').value = ticketNum;
                }

                // Auto-generate project number for new projects (YYYYMMDD_NNN)
                if (type === 'projects') {
                    const today = new Date();
                    const dateStr = today.getFullYear().toString() +
                        String(today.getMonth() + 1).padStart(2, '0') +
                        String(today.getDate()).padStart(2, '0');
                    // Count existing projects with same date prefix
                    const todayProjects = projectsData.filter(p => p.fields.ProjectNumber && p.fields.ProjectNumber.startsWith(dateStr));
                    const seq = String(todayProjects.length + 1).padStart(3, '0');
                    document.getElementById('projectNumber').value = `${dateStr}_${seq}`;
                }
            } else {
                document.getElementById('modalTitle').textContent = `Edit ${type === 'projects' ? 'Project' : 'Ticket'}`;
                const items = type === 'projects' ? projectsData : ticketsData;
                // Use String() coercion for consistent ID comparison
                const item = items.find(i => String(i.id) === String(itemId));
                if (item) {
                    populateForm(item, type);
                    renderComments(itemId);
                } else {
                    console.error('Item not found for edit. itemId:', itemId, 'Available IDs:', items.map(i => i.id));
                }
            }

            modal.style.display = 'flex';
            safeFeatherReplace();

            // Load attachments for the item
            loadAttachmentsOnModalOpen();
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // ========================================
        // PROJECT MODAL TASK MANAGEMENT
        // ========================================

        let pendingProjectTasks = []; // Tasks to be created when project is saved

        function clearProjectTasksList() {
            pendingProjectTasks = [];
            const container = document.getElementById('projectTasksList');
            container.innerHTML = `
                <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;" id="noTasksMessage">
                    No tasks yet. Click "Add Task" to create tasks for this project.
                </div>
            `;
        }

        function addTaskRow() {
            const container = document.getElementById('projectTasksList');
            const noTasksMsg = document.getElementById('noTasksMessage');
            if (noTasksMsg) noTasksMsg.remove();

            const taskId = 'task-' + Date.now();

            // Use adUsers if loaded, otherwise use fallback
            const usersToUse = adUsers.length > 0 ? adUsers : FALLBACK_USERS;
            console.log('addTaskRow called, using', usersToUse.length, 'users');

            const assigneeOptions = usersToUse.map(u => `<option value="${u.displayName}">${u.displayName}</option>`).join('');

            const taskRow = document.createElement('div');
            taskRow.className = 'task-add-row';
            taskRow.id = taskId;
            taskRow.innerHTML = `
                <input type="text" placeholder="Task title..." class="task-title-input" required>
                <select class="task-assignee-select">
                    <option value="">Assignee</option>
                    ${assigneeOptions}
                </select>
                <select class="task-phase-select">
                    <option value="Planning">Planning</option>
                    <option value="Design">Design</option>
                    <option value="Development">Development</option>
                    <option value="Testing">Testing</option>
                    <option value="Deployment">Deployment</option>
                    <option value="Execution" selected>Execution</option>
                </select>
                <select class="task-priority-select">
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
                <button type="button" class="task-row-remove" title="Remove">
                    <i data-feather="x" style="width:14px;height:14px;"></i>
                </button>
            `;

            container.appendChild(taskRow);
            safeFeatherReplace();

            // Attach remove button listener
            taskRow.querySelector('.task-row-remove').addEventListener('click', () => removeTaskRow(taskId));

            // Focus the title input
            taskRow.querySelector('.task-title-input').focus();
        }

        function removeTaskRow(taskId) {
            const row = document.getElementById(taskId);
            if (row) row.remove();

            // Show "no tasks" message if list is empty
            const container = document.getElementById('projectTasksList');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;" id="noTasksMessage">
                        No tasks yet. Click "Add Task" to create tasks for this project.
                    </div>
                `;
            }
        }

        function collectPendingTasks() {
            const tasks = [];
            const rows = document.querySelectorAll('.task-add-row');
            rows.forEach(row => {
                const title = row.querySelector('.task-title-input')?.value?.trim();
                if (title) {
                    tasks.push({
                        title: title,
                        assignee: row.querySelector('.task-assignee-select')?.value || '',
                        phase: row.querySelector('.task-phase-select')?.value || 'Execution',
                        priority: row.querySelector('.task-priority-select')?.value || 'Medium'
                    });
                }
            });
            return tasks;
        }

        function loadExistingTasksForProject(projectId) {
            // Find linked ticket
            const linkedTicket = ticketsData.find(t => String(t.fields.ProjectID) === String(projectId));
            if (!linkedTicket) {
                clearProjectTasksList();
                return;
            }

            // Get tasks for this ticket
            const projectTasks = tasksData.filter(t => String(t.fields.TicketID) === String(linkedTicket.id));
            const container = document.getElementById('projectTasksList');

            if (projectTasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;" id="noTasksMessage">
                        No tasks yet. Click "Add Task" to create tasks for this project.
                    </div>
                `;
                return;
            }

            // Show existing tasks as read-only rows
            container.innerHTML = projectTasks.map(task => {
                const f = task.fields;
                const priorityClass = f.Priority ? `priority-${f.Priority.toLowerCase()}` : '';
                return `
                    <div class="task-row ${priorityClass}">
                        <span class="task-row-title">${f.TaskTitle || 'Untitled'}</span>
                        <span class="task-row-field">${f.AssignedTo || 'Unassigned'}</span>
                        <span class="task-row-field">${f.Phase || ''}</span>
                        <span class="task-row-field" style="background:${f.Status === 'Done' ? 'var(--success)' : f.Status === 'In Progress' ? 'var(--warning)' : 'var(--surface-dark)'};color:${f.Status === 'Done' || f.Status === 'In Progress' ? 'white' : 'inherit'};">${f.Status || 'To Do'}</span>
                        <span></span>
                    </div>
                `;
            }).join('');

            safeFeatherReplace();
        }

        function clearForm(type) {
            // Common fields
            ['itemId', 'itemName', 'itemDescription', 'itemAssignee', 'itemCustomer', 'itemDueDate', 'itemNotes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('itemStatus').value = type === 'tickets' ? 'Open' : 'Not Started';
            document.getElementById('itemPriority').value = 'Medium';
            document.getElementById('itemTeam').value = 'Engineering';

            // Project-specific fields
            ['projectStartDate', 'projectEndDate', 'projectBudgetHours', 'projectHoursSpent', 'projectNumber', 'projectMilestones'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('projectPercent').value = 0;
            document.getElementById('percentLabel').textContent = '0%';

            // Clear tasks list in project modal
            clearProjectTasksList();

            // Ticket-specific fields
            ['ticketNumber', 'ticketTimeSpent', 'ticketResolution'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('ticketSource').value = 'Portal';
            document.getElementById('ticketUrgency').value = 'Medium';
            document.getElementById('ticketSLA').value = 'N/A';
            document.getElementById('ticketRelatedProject').value = '';
        }

        function populateForm(item, type) {
            const f = item.fields;

            // Common fields
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = f.Title || f.LinkTitle || f.TicketTitle || '';
            document.getElementById('itemDescription').value = f.Description || '';
            document.getElementById('itemStatus').value = f.Status || (type === 'tickets' ? 'Open' : 'Not Started');
            document.getElementById('itemPriority').value = f.Priority || 'Medium';
            document.getElementById('itemAssignee').value = f.AssignedTo || '';
            document.getElementById('itemTeam').value = f.Team || 'Engineering';
            document.getElementById('itemCustomer').value = f.Customer || '';
            document.getElementById('itemDueDate').value = f.DueDate ? f.DueDate.split('T')[0] : '';

            if (type === 'projects') {
                // Project-specific fields
                document.getElementById('projectStartDate').value = f.StartDate ? f.StartDate.split('T')[0] : '';
                document.getElementById('projectEndDate').value = f.EndDate ? f.EndDate.split('T')[0] : '';
                document.getElementById('projectPercent').value = f.PercentComplete || 0;
                document.getElementById('percentLabel').textContent = (f.PercentComplete || 0) + '%';
                document.getElementById('projectBudgetHours').value = f.BudgetHours || '';
                document.getElementById('projectHoursSpent').value = f.HoursSpent || '';
                document.getElementById('projectNumber').value = f.ProjectNumber || '';
                document.getElementById('projectMilestones').value = f.Milestones || '';

                // Load existing tasks for this project
                loadExistingTasksForProject(item.id);
            } else {
                // Ticket-specific fields
                document.getElementById('ticketNumber').value = f.TicketNumber || '';
                document.getElementById('ticketSource').value = f.Source || 'Portal';
                document.getElementById('ticketUrgency').value = f.Urgency || 'Medium';
                document.getElementById('ticketSLA').value = f.SLAStatus || 'N/A';
                document.getElementById('ticketTimeSpent').value = f.TimeSpent || '';
                document.getElementById('ticketRelatedProject').value = f.RelatedProject || '';
                document.getElementById('ticketResolution').value = f.Resolution || '';
            }
        }

        function renderComments(itemId) {
            const comments = commentsData[itemId] || [];
            const container = document.getElementById('commentsList');
            container.innerHTML = comments.length === 0 ? '<p style="color:var(--text-muted);font-size:13px;">No comments yet</p>' :
                comments.map(c => `<div class="comment-item">
                    <div class="comment-avatar">${escapeHtml(getInitials(c.author))}</div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(c.author)}</span>
                            <span class="comment-time">${escapeHtml(c.time)}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(c.text)}</div>
                    </div>
                </div>`).join('');
        }

        async function addComment() {
            const itemId = document.getElementById('itemId').value;
            const type = document.getElementById('itemType').value;
            const text = document.getElementById('commentInput').value.trim();

            // Validate comment
            const commentError = validateCommentText(text);
            if (commentError) {
                showNotification(commentError, 'error');
                return;
            }

            if (!itemId) {
                showNotification('Cannot add comment: No item selected', 'error');
                return;
            }

            // Require user to be selected
            if (!currentUser.displayName || currentUser.displayName === 'Unknown User') {
                showNotification('Please select your name from the dropdown in the header before adding comments.', 'warning');
                return;
            }

            const newComment = {
                author: escapeHtml(currentUser.displayName),
                text: escapeHtml(text),
                time: new Date().toLocaleString()
            };

            if (!commentsData[itemId]) commentsData[itemId] = [];
            commentsData[itemId].push(newComment);

            document.getElementById('commentInput').value = '';
            renderComments(itemId);

            // Sync comments to SharePoint
            await syncCommentsToSharePoint(type, itemId);
        }

        // Sync comments to SharePoint Comments column
        async function syncCommentsToSharePoint(type, itemId) {
            if (!CONFIG.siteId || CONFIG.siteId.includes('{{')) return;

            const listId = type === 'projects' ? CONFIG.projectsListId : CONFIG.ticketsListId;
            const comments = commentsData[itemId] || [];
            const commentsJson = JSON.stringify(comments);

            try {
                const token = await getAccessToken();
                const response = await fetch(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${listId}/items/${itemId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields: { Comments: commentsJson } })
                    }
                );

                if (response.ok) {
                    console.log('Comments synced to SharePoint');
                    logActivity(type, { id: itemId, fields: {} }, 'comment_added');
                } else {
                    console.error('Failed to sync comments:', response.status);
                }
            } catch (error) {
                console.error('Error syncing comments:', error);
            }
        }

        async function saveItem() {
            const itemId = document.getElementById('itemId').value;
            const type = document.getElementById('itemType').value;
            const titleField = type === 'projects' ? 'Title' : 'TicketTitle';
            const isNew = !itemId || itemId.startsWith('new-');

            // Common fields
            const fields = {
                [titleField]: document.getElementById('itemName').value,
                Description: document.getElementById('itemDescription').value,
                Status: document.getElementById('itemStatus').value,
                Priority: document.getElementById('itemPriority').value,
                AssignedTo: document.getElementById('itemAssignee').value,
                Team: document.getElementById('itemTeam').value,
                Customer: document.getElementById('itemCustomer').value,
                DueDate: document.getElementById('itemDueDate').value
            };

            // Add type-specific fields
            if (type === 'projects') {
                fields.PercentComplete = document.getElementById('projectPercent').value;
                fields.Budget = document.getElementById('projectBudgetHours').value;
            }

            // Validate input fields
            const validationErrors = validateItemFields(fields, type);
            if (validationErrors.length > 0) {
                showNotification(validationErrors.join('. '), 'error');
                return;
            }

            // Validate archive: project can only be archived if all tasks are complete
            if (type === 'projects' && fields.Status === 'Archived') {
                const archiveCheck = canArchiveProject(itemId);
                if (!archiveCheck.canArchive) {
                    showNotification(archiveCheck.reason, 'error');
                    return;
                }
            }

            // Show loading state
            const saveBtn = document.querySelector('#modal .btn-primary');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span> Saving...';
            }

            // Continue with type-specific fields (validated above)
            if (type === 'projects') {
                fields.StartDate = document.getElementById('projectStartDate').value || null;
                fields.EndDate = document.getElementById('projectEndDate').value || null;
                fields.PercentComplete = parseInt(document.getElementById('projectPercent').value) || 0;
                fields.BudgetHours = parseInt(document.getElementById('projectBudgetHours').value) || null;
                fields.HoursSpent = parseInt(document.getElementById('projectHoursSpent').value) || null;
                fields.ProjectNumber = document.getElementById('projectNumber').value || null;
                fields.Milestones = document.getElementById('projectMilestones').value;
            } else if (type === 'tickets') {
                fields.TicketNumber = document.getElementById('ticketNumber').value;
                fields.Source = document.getElementById('ticketSource').value;
                fields.Urgency = document.getElementById('ticketUrgency').value;
                fields.SLAStatus = document.getElementById('ticketSLA').value;
                fields.TimeSpent = document.getElementById('ticketTimeSpent').value;
                fields.Resolution = document.getElementById('ticketResolution').value;
            }

            const newItem = {
                id: itemId || 'new-' + Date.now(),
                sharePointId: itemId && !itemId.startsWith('new-') ? itemId : null,
                fields: fields
            };

            const items = type === 'projects' ? projectsData : ticketsData;
            // Find by ID (convert both to string for consistent comparison)
            let existingIndex = items.findIndex(i => String(i.id) === String(itemId));
            // Fallback: try to find by sharePointId if direct ID match fails
            if (existingIndex < 0 && itemId) {
                existingIndex = items.findIndex(i => String(i.sharePointId) === String(itemId));
            }

            if (existingIndex >= 0) {
                // Merge with existing item to preserve any extra properties
                items[existingIndex] = { ...items[existingIndex], ...newItem, fields: { ...items[existingIndex].fields, ...fields } };
                console.log('Updated existing item at index:', existingIndex, 'Status:', fields.Status);
            } else {
                items.push(newItem);
                console.log('Added new item, Status:', fields.Status);
            }

            // Sync to SharePoint for historical tracking (if configured)
            if (CONFIG.siteId && !CONFIG.siteId.includes('{{')) {
                const spResult = await saveToSharePoint(type, newItem, isNew);
                if (spResult) {
                    newItem.sharePointId = spResult.id;
                    newItem.id = spResult.id;
                    newItem.lastModifiedDateTime = spResult.lastModifiedDateTime;
                    console.log('Synced to SharePoint - version history preserved');

                    // AUTO-CREATE LINKED TICKET when new project is created
                    if (type === 'projects' && isNew) {
                        const linkedTicket = await createLinkedTicket(spResult.id, fields.Title, fields);
                        if (linkedTicket) {
                            // Update project with linked ticket ID
                            await updateProjectLinkedTicket(spResult.id, linkedTicket.id);
                            newItem.fields.LinkedTicketID = linkedTicket.id;

                            // CREATE TASKS added in the project modal
                            const pendingTasks = collectPendingTasks();
                            for (const taskData of pendingTasks) {
                                await createTask(linkedTicket.id, taskData);
                            }

                            // Reload tasks data
                            if (pendingTasks.length > 0) {
                                await loadFromSharePoint('tasks');
                            }
                        }
                    }

                    // If editing existing project, create any new tasks added
                    if (type === 'projects' && !isNew) {
                        const pendingTasks = collectPendingTasks();
                        if (pendingTasks.length > 0) {
                            const linkedTicket = ticketsData.find(t => String(t.fields.ProjectID) === String(spResult.id));
                            if (linkedTicket) {
                                for (const taskData of pendingTasks) {
                                    await createTask(linkedTicket.id, taskData);
                                }
                                await loadFromSharePoint('tasks');
                            }
                        }
                    }
                }
            } else {
                logActivity(type, newItem, isNew ? 'created' : 'updated');
            }

            closeModal();

            // Reload ALL data from SharePoint to ensure calendar and todos show accurate info
            // This catches any changes made outside the app (e.g., closed/archived items)
            await Promise.all([
                loadFromSharePoint('projects'),
                loadFromSharePoint('tickets'),
                loadFromSharePoint('tasks')
            ]);

            if (type === 'projects') updateProjectStats(); else updateTicketStats();
            renderItems(type);
            renderTodosByAssignee();
            renderPlanner();
            renderCalendar();
            console.log('All views refreshed after save. Item status:', fields.Status);
        }

        // Create linked ticket for a project
        async function createLinkedTicket(projectId, projectName, projectFields) {
            const ticketNumber = 'TKT-' + String(ticketsData.length + 1).padStart(4, '0');

            const ticketData = {
                fields: {
                    TicketTitle: `${projectName} - Project Ticket`,
                    Description: projectFields.Description || '',
                    Status: 'Open',
                    Priority: projectFields.Priority || 'Medium',
                    AssignedTo: projectFields.AssignedTo || '',
                    Team: projectFields.Team || 'Engineering',
                    Customer: projectFields.Customer || '',
                    DueDate: projectFields.DueDate || null,
                    TicketNumber: ticketNumber,
                    Source: 'Internal',
                    ProjectID: String(projectId),
                    RelatedProject: projectName, // Used in To-Do List display
                    DocumentationLog: JSON.stringify([{
                        timestamp: new Date().toISOString(),
                        type: 'created',
                        author: 'System',
                        text: `Project ticket created for: ${projectName}`
                    }])
                }
            };

            try {
                const token = await getAccessToken();
                const response = await fetch(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.ticketsListId}/items`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(ticketData)
                    }
                );

                if (response.ok) {
                    const result = await response.json();
                    console.log(`Created linked ticket ${ticketNumber} for project ${projectId}`);

                    // Add to local data
                    const newTicket = { ...result, fields: { ...result.fields, ...ticketData.fields } };
                    ticketsData.push(newTicket);
                    documentationLogs[result.id] = [{
                        timestamp: new Date().toISOString(),
                        type: 'created',
                        author: 'System',
                        text: `Project ticket created for: ${projectName}`
                    }];

                    return result;
                }
            } catch (error) {
                console.error('Error creating linked ticket:', error);
            }
            return null;
        }

        // Update project with linked ticket ID
        async function updateProjectLinkedTicket(projectId, ticketId) {
            try {
                const token = await getAccessToken();
                await fetch(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.projectsListId}/items/${projectId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields: { LinkedTicketID: ticketId } })
                    }
                );
                console.log(`Linked project ${projectId} to ticket ${ticketId}`);
            } catch (error) {
                console.error('Error updating project linked ticket:', error);
            }
        }

        // Create a task for a ticket - returns { success, data, error, message }
        async function createTask(ticketId, taskData) {
            if (!ticketId) {
                console.error('createTask: No ticketId provided');
                return { success: false, error: 'NO_TICKET', message: 'No linked ticket available' };
            }

            if (!CONFIG.tasksListId) {
                console.error('createTask: Tasks list not discovered. Please refresh the page.');
                return { success: false, error: 'NO_LIST', message: 'Tasks list not configured. Please refresh the page.' };
            }

            // Validate title length
            if (taskData.title && taskData.title.length > 255) {
                return { success: false, error: 'VALIDATION', message: 'Task title must be 255 characters or less' };
            }

            const ticket = ticketsData.find(t => String(t.id) === String(ticketId));
            const projectId = ticket?.fields?.ProjectID || '';

            console.log('createTask called with ticketId:', ticketId, 'projectId:', projectId);

            const data = {
                fields: {
                    TaskTitle: taskData.title,
                    TaskDescription: (taskData.description || '').slice(0, 5000),
                    TicketID: String(ticketId),
                    ProjectID: String(projectId),
                    Status: 'To Do',
                    Priority: taskData.priority || 'Medium',
                    AssignedTo: taskData.assignee || '',
                    EstimatedHours: taskData.estimatedHours || null,
                    StartDate: taskData.startDate || null,
                    DueDate: taskData.dueDate || null,
                    Phase: taskData.phase || 'Execution',
                    SortOrder: tasksData.filter(t => String(t.fields.TicketID) === String(ticketId)).length
                }
            };

            try {
                const token = await getAccessToken();
                const response = await fetch(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.tasksListId}/items`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    }
                );

                if (response.ok) {
                    const result = await response.json();
                    console.log(`Created task: ${taskData.title} (ID: ${result.id})`);

                    // Add documentation entry (don't fail task creation if this errors)
                    try {
                        await addDocumentationEntry(ticketId, 'task_created', `Task created: ${taskData.title}`);
                    } catch (docError) {
                        console.warn('Failed to add documentation entry:', docError);
                    }

                    return { success: true, data: result };
                } else {
                    // Parse error details
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch {
                        errorData = { error: { message: await response.text() } };
                    }
                    console.error('createTask API error:', response.status, errorData);

                    let message = 'Failed to create task';
                    if (response.status === 403) {
                        message = 'Permission denied. You may not have access to create tasks.';
                    } else if (response.status === 400) {
                        message = errorData.error?.message || 'Invalid task data. Please check your inputs.';
                    } else if (response.status === 404) {
                        message = 'Tasks list not found. Please refresh the page.';
                    }

                    return { success: false, error: 'API_ERROR', status: response.status, message };
                }
            } catch (error) {
                console.error('Error creating task:', error);
                return {
                    success: false,
                    error: 'NETWORK_ERROR',
                    message: 'Network error. Please check your connection and try again.'
                };
            }
        }

        // Update task status
        async function updateTaskStatus(taskId, newStatus) {
            const task = tasksData.find(t => String(t.id) === String(taskId));
            if (!task) return;

            try {
                const token = await getAccessToken();
                await fetch(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.tasksListId}/items/${taskId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields: { Status: newStatus } })
                    }
                );

                task.fields.Status = newStatus;

                // Add documentation entry
                if (task.fields.TicketID) {
                    await addDocumentationEntry(task.fields.TicketID, 'task_updated',
                        `Task "${task.fields.TaskTitle}" status changed to: ${newStatus}`);
                }

                // Recalculate project progress
                calculateAllProjectProgress();

                console.log(`Task ${taskId} status updated to ${newStatus}`);
            } catch (error) {
                console.error('Error updating task status:', error);
            }
        }

        // Add documentation entry to ticket
        async function addDocumentationEntry(ticketId, type, text, author = null) {
            // Use current user's name if not specified
            const authorName = author || currentUser.displayName || 'System';

            const entry = {
                timestamp: new Date().toISOString(),
                type: type,
                author: authorName,
                text: text
            };

            if (!documentationLogs[ticketId]) documentationLogs[ticketId] = [];
            documentationLogs[ticketId].push(entry);

            // Save to SharePoint
            try {
                const token = await getAccessToken();
                await fetch(
                    `${GRAPH_API}/sites/${CONFIG.siteId}/lists/${CONFIG.ticketsListId}/items/${ticketId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: { DocumentationLog: JSON.stringify(documentationLogs[ticketId]) }
                        })
                    }
                );
                console.log(`Documentation entry added to ticket ${ticketId}`);
            } catch (error) {
                console.error('Error saving documentation:', error);
            }
        }

        // ========================================
        // PROJECT DETAIL MODAL FUNCTIONS
        // ========================================

        function showProjectDetail(projectId) {
            console.log('showProjectDetail called with:', projectId, 'type:', typeof projectId);
            console.log('Available projects:', projectsData.map(p => ({id: p.id, type: typeof p.id, name: p.fields?.Title})));
            console.log('projectsData length:', projectsData.length);
            currentProjectId = projectId;
            // Convert to string for comparison since SharePoint IDs can be strings or numbers
            const project = projectsData.find(p => String(p.id) === String(projectId));
            if (!project) {
                console.error('Project not found for ID:', projectId);
                console.error('Available IDs:', projectsData.map(p => p.id));
                showNotification(`Project not found (ID: ${projectId}). Try refreshing the page.`, 'error');
                return;
            }
            console.log('Found project:', project.fields?.Title);

            const f = project.fields;

            // Find linked ticket (use string comparison)
            const linkedTicket = ticketsData.find(t => String(t.fields.ProjectID) === String(projectId));
            currentTicketId = linkedTicket?.id || null;

            // Set header
            document.getElementById('projectDetailTitle').textContent = f.Title || f.LinkTitle || 'Project';
            const statusEl = document.getElementById('projectDetailStatus');
            statusEl.textContent = f.Status || 'Not Started';
            statusEl.style.background = getStatusColor(f.Status);

            // Project Info
            document.getElementById('projectDetailInfo').innerHTML = `
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div style="font-size:13px;color:var(--text-secondary);line-height:1.6;">${f.Description || 'No description'}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div style="background:white;padding:10px;border-radius:var(--radius-sm);">
                            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Priority</div>
                            <div style="font-size:14px;font-weight:600;color:${getPriorityColor(f.Priority)};">${f.Priority || 'Medium'}</div>
                        </div>
                        <div style="background:white;padding:10px;border-radius:var(--radius-sm);">
                            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Team</div>
                            <div style="font-size:14px;font-weight:600;">${f.Team || 'Engineering'}</div>
                        </div>
                        <div style="background:white;padding:10px;border-radius:var(--radius-sm);">
                            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Assigned To</div>
                            <div style="font-size:14px;font-weight:600;">${f.AssignedTo || 'Unassigned'}</div>
                        </div>
                        <div style="background:white;padding:10px;border-radius:var(--radius-sm);">
                            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Due Date</div>
                            <div style="font-size:14px;font-weight:600;">${f.DueDate ? formatDate(f.DueDate) : 'Not set'}</div>
                        </div>
                    </div>
                    ${f.Milestones ? `
                        <div style="background:white;padding:12px;border-radius:var(--radius-sm);">
                            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;">Milestones</div>
                            <div style="font-size:13px;line-height:1.6;white-space:pre-line;">${f.Milestones}</div>
                        </div>
                    ` : ''}
                    ${f.Customer ? `
                        <div style="font-size:12px;color:var(--text-muted);">
                            <strong>Customer:</strong> ${f.Customer}
                        </div>
                    ` : ''}
                </div>
            `;

            // Progress
            const percent = calculateProjectProgress(projectId);
            document.getElementById('projectDetailProgress').innerHTML = `
                <svg class="progress-ring" viewBox="0 0 60 60">
                    <circle cx="30" cy="30" r="26" fill="none" stroke="var(--border)" stroke-width="6"/>
                    <circle cx="30" cy="30" r="26" fill="none" stroke="var(--success)" stroke-width="6"
                        stroke-dasharray="${(percent/100) * 163.36} 163.36"
                        stroke-linecap="round"
                        transform="rotate(-90 30 30)"/>
                    <text x="30" y="35" text-anchor="middle" class="progress-text">${percent}%</text>
                </svg>
                <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);">
                    ${f.BudgetHours ? `${f.HoursSpent || 0} / ${f.BudgetHours} hours` : 'No budget set'}
                </div>
            `;

            // Linked Ticket
            if (linkedTicket) {
                document.getElementById('projectLinkedTicketInfo').innerHTML = `
                    <div class="linked-ticket-badge">
                        <i data-feather="tag" style="width:14px;height:14px;"></i>
                        ${linkedTicket.fields.TicketNumber || 'Linked Ticket'}
                        <span style="color:var(--text-muted);font-weight:400;">${linkedTicket.fields.Status || ''}</span>
                    </div>
                `;
            } else {
                document.getElementById('projectLinkedTicketInfo').innerHTML = `
                    <p style="color:var(--text-muted);font-size:13px;">No linked ticket found.</p>
                `;
            }

            // Render Tasks Kanban
            renderProjectTasks();

            // Render Documentation Log
            renderProjectDocLog();

            // Populate assignee dropdown for new task
            populateTaskAssigneeDropdown();

            // Show modal
            document.getElementById('projectDetailModal').style.display = 'flex';
            safeFeatherReplace();
        }

        function closeProjectDetailModal() {
            document.getElementById('projectDetailModal').style.display = 'none';
            currentProjectId = null;
            currentTicketId = null;
        }

        function editProjectFromDetail() {
            if (currentProjectId) {
                const projectIdToEdit = currentProjectId; // Store ID before closing
                closeProjectDetailModal();
                showModal('edit', 'projects', projectIdToEdit);
            }
        }

        function openLinkedTicket(ticketId) {
            closeProjectDetailModal();
            showModal('edit', 'tickets', ticketId);
        }

        function calculateProjectProgress(projectId) {
            // Find linked ticket
            const linkedTicket = ticketsData.find(t => String(t.fields.ProjectID) === String(projectId));
            if (!linkedTicket) {
                // Fall back to project's stored percent
                const project = projectsData.find(p => String(p.id) === String(projectId));
                return project?.fields?.PercentComplete || 0;
            }

            // Calculate from tasks
            const projectTasks = tasksData.filter(t => String(t.fields.TicketID) === String(linkedTicket.id));
            if (projectTasks.length === 0) return 0;

            const doneTasks = projectTasks.filter(t => t.fields.Status === 'Done').length;
            return Math.round((doneTasks / projectTasks.length) * 100);
        }

        function getStatusColor(status) {
            const colors = {
                'Not Started': 'var(--text-muted)',
                'Open': 'var(--secondary)',
                'In Progress': 'var(--warning)',
                'On Hold': '#f472b6',
                'Pending': '#a78bfa',
                'Completed': 'var(--success)',
                'Resolved': 'var(--success)',
                'Closed': 'var(--text-secondary)'
            };
            return colors[status] || 'var(--primary)';
        }

        function getPriorityColor(priority) {
            const colors = {
                'Low': 'var(--success)',
                'Medium': 'var(--warning)',
                'High': 'var(--danger)',
                'Critical': '#dc2626'
            };
            return colors[priority] || 'var(--text-primary)';
        }

        // ========================================
        // TASKS KANBAN FUNCTIONS
        // ========================================

        function renderProjectTasks() {
            const container = document.getElementById('projectTasksKanban');

            // Get tasks by TicketID or by ProjectID if no linked ticket
            let projectTasks = [];
            if (currentTicketId) {
                projectTasks = tasksData.filter(t => String(t.fields.TicketID) === String(currentTicketId));
            }
            // Also include tasks linked directly to the project (regardless of ticket)
            if (currentProjectId) {
                const directProjectTasks = tasksData.filter(t =>
                    String(t.fields.ProjectID) === String(currentProjectId) &&
                    !projectTasks.some(pt => pt.id === t.id)
                );
                projectTasks = [...projectTasks, ...directProjectTasks];
            }

            if (projectTasks.length === 0 && !currentTicketId) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:var(--text-muted);">
                        <i data-feather="check-square" style="width:40px;height:40px;margin-bottom:12px;"></i>
                        <p>No tasks yet. Create a task to get started.</p>
                    </div>
                `;
                safeFeatherReplace();
                return;
            }
            const statuses = ['To Do', 'In Progress', 'Done'];

            container.innerHTML = statuses.map(status => {
                const tasks = projectTasks.filter(t => t.fields.Status === status);
                return `
                    <div class="tasks-column" data-status="${status}">
                        <div class="tasks-column-header">
                            <span>${status}</span>
                            <span class="tasks-column-count">${tasks.length}</span>
                        </div>
                        <div class="tasks-list" data-status="${status}">
                            ${tasks.length === 0 ? `
                                <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;">
                                    No tasks
                                </div>
                            ` : tasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Initialize drag and drop
            initTasksDragDrop();
            safeFeatherReplace();
        }

        function renderTaskCard(task) {
            const f = task.fields;
            const priorityClass = f.Priority ? `priority-${f.Priority.toLowerCase()}` : '';
            return `
                <div class="task-card ${priorityClass}" data-task-id="${task.id}" draggable="true">
                    <div class="task-title">${f.TaskTitle || 'Untitled Task'}</div>
                    <div class="task-meta">
                        ${f.AssignedTo ? `
                            <div class="task-assignee-avatar">${getInitials(f.AssignedTo)}</div>
                        ` : ''}
                        ${f.DueDate ? `<span>${formatDate(f.DueDate)}</span>` : ''}
                        ${f.EstimatedHours ? `<span>${f.EstimatedHours}h</span>` : ''}
                    </div>
                </div>
            `;
        }

        function initTasksDragDrop() {
            const lists = document.querySelectorAll('.tasks-list');
            lists.forEach(list => {
                new Sortable(list, {
                    group: 'tasks',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function(evt) {
                        const taskId = evt.item.dataset.taskId;
                        const newStatus = evt.to.dataset.status;
                        updateTaskStatus(taskId, newStatus);
                    }
                });
            });
        }

        // ========================================
        // ADD TASK MODAL FUNCTIONS
        // ========================================

        async function showAddTaskModal() {
            // Check if project has a linked ticket
            if (!currentTicketId) {
                // No linked ticket - offer to create one for legacy projects
                if (!currentProjectId) {
                    showNotification('No project or ticket available to add tasks to.', 'error');
                    return;
                }

                const project = projectsData.find(p => String(p.id) === String(currentProjectId));
                if (!project) {
                    showNotification('Project not found.', 'error');
                    return;
                }

                const projectName = project.fields?.Title || 'Untitled Project';
                const userConfirmed = confirm(
                    `This project doesn't have a linked ticket yet.\n\n` +
                    `Would you like to create one now? This will allow you to add tasks to "${projectName}".`
                );

                if (!userConfirmed) {
                    return;
                }

                // Auto-create linked ticket
                showNotification('Creating linked ticket...', 'info');

                try {
                    const linkedTicket = await createLinkedTicket(currentProjectId, projectName, project.fields);
                    if (linkedTicket) {
                        currentTicketId = linkedTicket.id;

                        // Update project with linked ticket ID
                        await updateProjectLinkedTicket(currentProjectId, linkedTicket.id);

                        // Reload tickets data
                        await loadFromSharePoint('tickets');

                        showNotification('Linked ticket created successfully. You can now add tasks.', 'success');

                        // Update project detail view to show ticket info
                        showProjectDetail(currentProjectId);
                    } else {
                        showNotification('Failed to create linked ticket. Please try again.', 'error');
                        return;
                    }
                } catch (err) {
                    console.error('Error creating linked ticket:', err);
                    showNotification('Error creating linked ticket. Please try again.', 'error');
                    return;
                }
            }

            // Clear form
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskDesc').value = '';
            document.getElementById('newTaskPriority').value = 'Medium';
            document.getElementById('newTaskAssignee').value = '';
            document.getElementById('newTaskHours').value = '';
            document.getElementById('newTaskStartDate').value = '';
            document.getElementById('newTaskDueDate').value = '';
            document.getElementById('newTaskPhase').value = 'Execution';

            document.getElementById('addTaskModal').style.display = 'flex';
            safeFeatherReplace();
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
        }

        function populateTaskAssigneeDropdown() {
            const select = document.getElementById('newTaskAssignee');
            select.innerHTML = '<option value="">Unassigned</option>' +
                adUsers.map(u => `<option value="${u.displayName}">${u.displayName}</option>`).join('');
        }

        async function submitNewTask() {
            const title = document.getElementById('newTaskTitle').value.trim();
            if (!title) {
                showNotification('Task title is required', 'error');
                return;
            }

            // Validate title length
            if (title.length > 255) {
                showNotification('Task title must be 255 characters or less', 'error');
                return;
            }

            const taskData = {
                title: title,
                description: document.getElementById('newTaskDesc').value.trim(),
                priority: document.getElementById('newTaskPriority').value,
                assignee: document.getElementById('newTaskAssignee').value,
                estimatedHours: parseInt(document.getElementById('newTaskHours').value) || null,
                startDate: document.getElementById('newTaskStartDate').value || null,
                dueDate: document.getElementById('newTaskDueDate').value || null,
                phase: document.getElementById('newTaskPhase').value
            };

            // Show loading state - find and disable submit button
            const modal = document.getElementById('addTaskModal');
            const submitBtn = modal.querySelector('button.btn-primary');
            const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i data-feather="loader" style="width:14px;height:14px;animation:spin 1s linear infinite;"></i> Creating...';
                safeFeatherReplace();
            }

            // Store ticketId in case modal state changes
            const ticketIdToUse = currentTicketId;

            try {
                // Create task via API
                const result = await createTask(ticketIdToUse, taskData);

                if (result.success) {
                    // Close modal only on success
                    closeAddTaskModal();

                    // Optimistic UI update - add task immediately
                    const newTask = {
                        id: result.data.id,
                        fields: {
                            TaskTitle: taskData.title,
                            TaskDescription: taskData.description,
                            TicketID: String(ticketIdToUse),
                            ProjectID: result.data.fields?.ProjectID || '',
                            Status: 'To Do',
                            Priority: taskData.priority,
                            AssignedTo: taskData.assignee,
                            EstimatedHours: taskData.estimatedHours,
                            StartDate: taskData.startDate,
                            DueDate: taskData.dueDate,
                            Phase: taskData.phase
                        }
                    };
                    tasksData.push(newTask);

                    // Refresh UI immediately
                    renderProjectTasks();
                    renderProjectDocLog();
                    renderTodosByAssignee();

                    showNotification('Task created successfully', 'success');

                    // Background refresh to ensure data consistency
                    loadFromSharePoint('tasks').catch(err => {
                        console.warn('Background task refresh failed:', err);
                    });
                } else {
                    // Keep modal open on failure, show specific error
                    showNotification(result.message || 'Failed to create task. Please try again.', 'error');

                    // Restore button state for retry
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        safeFeatherReplace();
                    }
                }
            } catch (error) {
                console.error('Unexpected error in submitNewTask:', error);
                showNotification('Unexpected error creating task. Please try again.', 'error');

                // Restore button state for retry
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    safeFeatherReplace();
                }
            }
        }

        // ========================================
        // DOCUMENTATION LOG FUNCTIONS
        // ========================================

        function renderProjectDocLog() {
            const container = document.getElementById('projectDocLog');
            if (!currentTicketId) {
                container.innerHTML = '<p style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px;">No linked ticket for documentation.</p>';
                return;
            }

            const logs = documentationLogs[currentTicketId] || [];
            if (logs.length === 0) {
                container.innerHTML = '<p style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px;">No documentation entries yet.</p>';
                return;
            }

            // Sort by timestamp descending (newest first)
            const sortedLogs = [...logs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            container.innerHTML = sortedLogs.map(entry => {
                const icon = getDocEntryIcon(entry.type);
                return `
                    <div class="doc-entry">
                        <div class="doc-entry-icon ${entry.type}">
                            <i data-feather="${icon}" style="width:14px;height:14px;"></i>
                        </div>
                        <div class="doc-entry-content">
                            <div class="doc-entry-header">
                                <span class="doc-entry-author">${entry.author || 'System'}</span>
                                <span class="doc-entry-type">${formatEntryType(entry.type)}</span>
                                <span class="doc-entry-time">${formatTimestamp(entry.timestamp)}</span>
                            </div>
                            <div class="doc-entry-text">${entry.text}</div>
                        </div>
                    </div>
                `;
            }).join('');

            safeFeatherReplace();
        }

        function getDocEntryIcon(type) {
            const icons = {
                'created': 'plus-circle',
                'task_created': 'list-plus',
                'task_updated': 'refresh-cw',
                'note': 'file-text',
                'status_change': 'arrow-right-circle'
            };
            return icons[type] || 'message-circle';
        }

        function formatEntryType(type) {
            const labels = {
                'created': 'Created',
                'task_created': 'Task',
                'task_updated': 'Update',
                'note': 'Note',
                'status_change': 'Status'
            };
            return labels[type] || type;
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        async function addProjectDocNote() {
            const input = document.getElementById('projectDocInput');
            const text = input.value.trim();
            if (!text || !currentTicketId) return;

            // Require user to be selected
            if (!currentUser.displayName || currentUser.displayName === 'Unknown User') {
                alert('Please select your name from the dropdown in the header before adding notes.');
                return;
            }

            input.value = '';
            await addDocumentationEntry(currentTicketId, 'note', text);
            renderProjectDocLog();
        }

        // Note: calculateAllProjectProgress is defined at line ~4711, removed duplicate here

        // AI Panel
        }

        let geminiChatHistory = []; // To store chat history for Gemini
        // AI Panel
        function toggleAIPanel(agent) {
            currentAIAgent = agent;
            const panel = document.getElementById('aiPanel');
            const isOpen = panel.classList.contains('open');

            if (isOpen && panel.dataset.agent === agent) {
                panel.classList.remove('open');
            } else {
                panel.classList.add('open');
                panel.dataset.agent = agent;
                document.getElementById('aiPanelTitle').textContent = agent === 'claude' ? 'Claude Agent' : 'Gemini Agent';
                // Reset chat history when switching agents
                // For a more persistent experience, you might want to save history per agent
                if (agent === 'gemini' && geminiChatHistory.length === 0) {
                     // Initial Gemini message, but only if chat is empty
                    const messages = document.getElementById('aiChatMessages');
                    messages.innerHTML = `<div class="ai-message assistant">
                        <div class="ai-message-avatar">
                            <i data-feather="cpu" style="width:14px;height:14px;"></i>
                        </div>
                        <div class="ai-message-content">
                            Hello! I'm your Gemini AI assistant. I can help you:
                            <ul style="margin:8px 0 0 16px;font-size:13px;">
                                <li>Summarize overdue tasks</li>
                                <li>Analyze ticket trends</li>
                                <li>Generate meeting schedules</li>
                                <li>Create project templates</li>
                                <li>Automate reminders</li>
                            </ul>
                        </div>
                    </div>`;
                    safeFeatherReplace();
                } else if (agent === 'claude') {
                    // Re-render initial Claude message if needed
                    const messages = document.getElementById('aiChatMessages');
                     messages.innerHTML = `<div class="ai-message assistant">
                        <div class="ai-message-avatar">
                            <i data-feather="cpu" style="width:14px;height:14px;"></i>
                        </div>
                        <div class="ai-message-content">
                            Hello! I'm your Claude AI assistant. I can help you:
                            <ul style="margin:8px 0 0 16px;font-size:13px;">
                                <li>Summarize overdue tasks</li>
                                <li>Analyze ticket trends</li>
                                <li>Generate meeting schedules</li>
                                <li>Create project templates</li>
                                <li>Automate reminders</li>
                            </ul>
                        </div>
                    </div>`;
                    safeFeatherReplace();
                }
            }
            // If opening and it's a fresh chat, add initial message
            if (panel.classList.contains('open')) {
                const messages = document.getElementById('aiChatMessages');
                messages.scrollTop = messages.scrollHeight;
            }
            safeFeatherReplace();
        }

        function closeAIPanel() {
            document.getElementById('aiPanel').classList.remove('open');
        }

        async function sendAIMessage() { // Make async
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if (!text) return;

            const messages = document.getElementById('aiChatMessages');

            // Add user message to UI
            messages.innerHTML += `<div class="ai-message user">
                <div class="ai-message-avatar"><i data-feather="user" style="width:14px;height:14px;"></i></div>
                <div class="ai-message-content">${text}</div>
            </div>`;

            input.value = '';
            messages.scrollTop = messages.scrollHeight; // Scroll to bottom

            // Add loading indicator
            const loadingMessageDiv = document.createElement('div');
            loadingMessageDiv.className = 'ai-message assistant loading-message';
            loadingMessageDiv.innerHTML = `<div class="ai-message-avatar"><i data-feather="cpu" style="width:14px;height:14px;"></i></div>
                                          <div class="ai-message-content"><div class="loading-spinner" style="width:20px;height:20px;border-width:2px;"></div></div>`;
            messages.appendChild(loadingMessageDiv);
            safeFeatherReplace();
            messages.scrollTop = messages.scrollHeight;


            try {
                let aiResponseText = '';

                // --- Gather Contextual Information ---
                let context = {
                    currentTab: currentTab,
                    currentUser: currentUser.displayName,
                    tasksSummary: [],
                    projectsSummary: [],
                    timeEntriesSummary: []
                };

                // Summarize active tasks
                const activeTasks = tasksData.filter(t => !['Done', 'Completed', 'Closed'].includes(t.fields?.Status));
                context.tasksSummary = activeTasks.map(t => ({
                    id: t.id,
                    title: t.fields?.TaskTitle,
                    status: t.fields?.Status,
                    priority: t.fields?.Priority,
                    assignee: t.fields?.AssignedTo,
                    dueDate: t.fields?.DueDate,
                    ticketId: t.fields?.TicketID
                }));

                // Summarize active projects
                const activeProjects = projectsData.filter(p => !['Archived', 'Completed'].includes(p.fields?.Status));
                context.projectsSummary = activeProjects.map(p => ({
                    id: p.id,
                    title: p.fields?.Title || p.fields?.LinkTitle,
                    status: p.fields?.Status,
                    priority: p.fields?.Priority,
                    percentComplete: p.fields?.PercentComplete,
                    assignee: p.fields?.AssignedTo
                }));

                // Summarize recent time entries (e.g., last 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const recentTimeEntries = timeEntriesData.filter(e => new Date(e.date) >= sevenDaysAgo);
                context.timeEntriesSummary = recentTimeEntries.map(e => ({
                    employee: e.employee,
                    date: e.date,
                    hours: e.hours,
                    project: e.projectName,
                    type: e.type,
                    description: e.description
                }));

                // Add details for current open project/ticket modal if applicable
                if (document.getElementById('projectDetailModal').style.display === 'flex' && currentProjectId) {
                    const project = projectsData.find(p => String(p.id) === String(currentProjectId));
                    if (project) {
                        context.currentProjectDetails = {
                            id: project.id,
                            title: project.fields?.Title || project.fields?.LinkTitle,
                            description: project.fields?.Description,
                            status: project.fields?.Status,
                            priority: project.fields?.Priority,
                            assignee: project.fields?.AssignedTo,
                            dueDate: project.fields?.DueDate,
                            percentComplete: project.fields?.PercentComplete,
                            budgetHours: project.fields?.BudgetHours,
                            hoursSpent: project.fields?.HoursSpent
                        };
                    }
                } else if (document.getElementById('modal').style.display === 'flex' && document.getElementById('itemType').value === 'tickets' && document.getElementById('itemId').value) {
                     const ticketId = document.getElementById('itemId').value;
                     const ticket = ticketsData.find(t => String(t.id) === String(ticketId));
                     if (ticket) {
                        context.currentTicketDetails = {
                            id: ticket.id,
                            title: ticket.fields?.TicketTitle,
                            description: ticket.fields?.Description,
                            status: ticket.fields?.Status,
                            priority: ticket.fields?.Priority,
                            assignee: ticket.fields?.AssignedTo,
                            dueDate: ticket.fields?.DueDate,
                            ticketNumber: ticket.fields?.TicketNumber
                        };
                     }
                }
                // --- End Gather Contextual Information ---


                if (currentAIAgent === 'gemini') {
                    // Update Gemini chat history with user message
                    geminiChatHistory.push({ "role": "user", "parts": [{"text": text}] });

                    const response = await fetch(CONTAINER_CONFIG.gateway + '/gemini/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt: text, history: geminiChatHistory, context: context }) // Send context
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Gemini API call failed');
                    }

                    const data = await response.json();
                    aiResponseText = data.response;
                    geminiChatHistory = data.history; // Update history with new AI response

                } else if (currentAIAgent === 'claude') {
                    // Simulate Claude response for now
                    const responses = [
                        "I've analyzed your current projects. You have 2 high-priority items that need attention this week.",
                        "Based on your ticket trends, VPN and email issues are the most common. Consider creating a troubleshooting guide.",
                        "I can help you create a sprint template for your engineering team. Want me to draft one?"
                    ];
                    aiResponseText = responses[Math.floor(Math.random() * responses.length)];
                }

                // Remove loading indicator
                if (loadingMessageDiv.parentNode) {
                    loadingMessageDiv.parentNode.removeChild(loadingMessageDiv);
                }

                // Add AI response to UI
                messages.innerHTML += `<div class="ai-message assistant">
                    <div class="ai-message-avatar"><i data-feather="cpu" style="width:14px;height:14px;"></i></div>
                    <div class="ai-message-content">${aiResponseText}</div>
                </div>`;
                messages.scrollTop = messages.scrollHeight;
                safeFeatherReplace();

            } catch (error) {
                console.error('AI message error:', error);
                // Remove loading indicator
                if (loadingMessageDiv.parentNode) {
                    loadingMessageDiv.parentNode.removeChild(loadingMessageDiv);
                }
                messages.innerHTML += `<div class="ai-message assistant">
                    <div class="ai-message-avatar"><i data-feather="alert-triangle" style="width:14px;height:14px;color:var(--danger);"></i></div>
                    <div class="ai-message-content" style="color:var(--danger);">Error: ${error.message || 'Could not get response from AI agent.'}</div>
                </div>`;
                messages.scrollTop = messages.scrollHeight;
                safeFeatherReplace();
            }
        }

        function refreshData() { loadData(); }

        // Utilities
        function getInitials(name) {
            if (!name || name === 'Unassigned') return '?';
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getDueClass(dateStr) {
            if (!dateStr) return '';
            const due = new Date(dateStr); due.setHours(0, 0, 0, 0);
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            if (diff < 0) return 'overdue';
            if (diff <= 3) return 'soon';
            return '';
        }

        // ========================================
        // EXPORT FUNCTIONS
        // ========================================

        function toggleExportDropdown(type) {
            const dropdown = document.getElementById(`export-dropdown-${type}`);
            const allDropdowns = document.querySelectorAll('.export-dropdown');

            // Close other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== `export-dropdown-${type}`) d.classList.remove('show');
            });

            dropdown.classList.toggle('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.export-btn') && !e.target.closest('.export-dropdown')) {
                document.querySelectorAll('.export-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        function exportData(type, format) {
            let data, filename;

            if (type === 'projects') {
                data = getFilteredProjects().map(item => ({
                    'Project Name': item.fields.Title || item.fields.LinkTitle || '',
                    'Description': item.fields.Description || '',
                    'Status': item.fields.Status || '',
                    'Priority': item.fields.Priority || '',
                    'Assigned To': item.fields.AssignedTo || '',
                    'Team': item.fields.Team || '',
                    'Customer': item.fields.Customer || '',
                    'Start Date': item.fields.StartDate || '',
                    'Due Date': item.fields.DueDate || '',
                    'End Date': item.fields.EndDate || '',
                    'Progress %': item.fields.PercentComplete || 0,
                    'Budget Hours': item.fields.BudgetHours || '',
                    'Hours Spent': item.fields.HoursSpent || '',
                    'Created': item.createdDateTime ? new Date(item.createdDateTime).toLocaleDateString() : '',
                    'Modified': item.lastModifiedDateTime ? new Date(item.lastModifiedDateTime).toLocaleDateString() : ''
                }));
                filename = `Projects_Export_${new Date().toISOString().split('T')[0]}`;
            } else if (type === 'todos') {
                // Export all tasks with their parent ticket info
                data = tasksData.map(task => {
                    const ticket = ticketsData.find(t => String(t.id) === String(task.fields?.TicketID));
                    return {
                        'Task Title': task.fields?.TaskTitle || '',
                        'Status': task.fields?.Status || '',
                        'Priority': task.fields?.Priority || '',
                        'Assigned To': task.fields?.AssignedTo || '',
                        'Phase': task.fields?.Phase || '',
                        'Due Date': task.fields?.DueDate || '',
                        'Parent Ticket': ticket?.fields?.TicketTitle || '',
                        'Related Project': ticket?.fields?.RelatedProject || '',
                        'Estimated Hours': task.fields?.EstimatedHours || '',
                        'Created': task.createdDateTime ? new Date(task.createdDateTime).toLocaleDateString() : ''
                    };
                });
                filename = `Tasks_Export_${new Date().toISOString().split('T')[0]}`;
            }

            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }

            if (format === 'excel') {
                exportToExcel(data, filename);
            } else {
                exportToCSV(data, filename);
            }

            // Close dropdown
            document.querySelectorAll('.export-dropdown').forEach(d => d.classList.remove('show'));
        }

        function exportToExcel(data, filename) {
            try {
                const ws = XLSX.utils.json_to_sheet(data);

                // Auto-size columns
                const colWidths = Object.keys(data[0] || {}).map(key => ({
                    wch: Math.max(key.length, ...data.map(row => String(row[key] || '').length))
                }));
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                XLSX.writeFile(wb, `${filename}.xlsx`);

                console.log(`Exported ${data.length} rows to ${filename}.xlsx`);
            } catch (error) {
                console.error('Export to Excel failed:', error);
                alert('Export failed. Please try again.');
            }
        }

        function exportToCSV(data, filename) {
            try {
                if (data.length === 0) return;

                const headers = Object.keys(data[0]);
                const csvRows = [
                    headers.join(','),
                    ...data.map(row =>
                        headers.map(header => {
                            const value = String(row[header] || '');
                            // Escape quotes and wrap in quotes if contains comma, quote, or newline
                            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                return `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(',')
                    )
                ];

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${filename}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                console.log(`Exported ${data.length} rows to ${filename}.csv`);
            } catch (error) {
                console.error('Export to CSV failed:', error);
                alert('Export failed. Please try again.');
            }
        }

        // ========================================
        // GLOBAL SEARCH FUNCTIONS
        // ========================================

        let searchTimeout = null;

        function initGlobalSearch() {
            const searchInput = document.getElementById('globalSearchInput');
            const dropdown = document.getElementById('searchResultsDropdown');

            if (!searchInput) return;

            // Debounced search on input
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                if (searchTimeout) clearTimeout(searchTimeout);

                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }

                searchTimeout = setTimeout(() => {
                    performLocalSearch(query);
                }, 300);
            });

            // Close dropdown on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.global-search-container')) {
                    dropdown.classList.remove('show');
                }
            });

            // Show dropdown on focus if there's content
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim().length >= 2) {
                    performLocalSearch(searchInput.value.trim());
                }
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    searchInput.blur();
                } else if (e.key === 'Enter') {
                    const activeItem = dropdown.querySelector('.search-result-item:hover, .search-result-item:focus');
                    if (activeItem) activeItem.click();
                }
            });
        }

        }

        async function performLocalSearch(query) {
            const dropdown = document.getElementById('searchResultsDropdown');
            const content = document.getElementById('searchResultsContent');
            const searchLoading = document.getElementById('searchLoading');

            searchLoading.style.display = 'block';
            content.innerHTML = '';
            dropdown.classList.add('show');

            try {
                const ragEngineUrl = CONTAINER_CONFIG.gateway.replace(/:\d+$/, ':8082'); // Use rag-engine port
                const response = await fetch(ragEngineUrl + '/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    throw new Error(`RAG search failed: ${response.status}`);
                }

                const data = await response.json();
                searchLoading.style.display = 'none';
                displayRagResults(data.llm_summary, data.results);

            } catch (error) {
                console.error('Global RAG search error:', error);
                searchLoading.style.display = 'none';
                content.innerHTML = `<div class="search-no-results" style="color:var(--danger);">Error: ${error.message}</div>`;
            }
        }

        function displayRagResults(llmSummary, results) {
            const content = document.getElementById('searchResultsContent');
            let html = '';

            if (llmSummary) {
                html += `
                    <div class="search-result-group">
                        <div class="search-result-group-title">AI Summary</div>
                        <div style="background:var(--surface-dark);padding:12px;border-radius:var(--radius-md);margin-bottom:10px;font-size:14px;line-height:1.5;">
                            ${llmSummary}
                        </div>
                    </div>
                `;
            }

            if (!results || results.length === 0) {
                html += `<div class="search-no-results">No relevant documents found.</div>`;
            } else {
                html += `
                    <div class="search-result-group">
                        <div class="search-result-group-title">Matching Documents (${results.length})</div>
                        ${results.map(r => {
                            const metadata = r.metadata || {};
                            const title = metadata.title || 'Untitled Document';
                            const file = metadata.file_path ? metadata.file_path.split('/').pop() : 'Unknown';
                            const tags = metadata.tags || [];
                            const similarity = ((1 - r.distance) * 100).toFixed(1);
                            const preview = (r.content || '').substring(0, 200).replace(/\n/g, ' ') + '...';

                            return `
                                <div class="search-result-item" data-type="document" data-file-path="${metadata.file_path || ''}">
                                    <div class="search-result-title">${highlightMatch(title, '')}</div>
                                    <div class="search-result-meta" style="margin-top:4px;">
                                        <span class="chat-tag" style="background:var(--secondary-light);color:var(--secondary);">
                                            ${similarity}% match
                                        </span>
                                        <span style="font-size:12px;color:var(--text-muted);"> ${file}</span>
                                    </div>
                                    <div style="font-size:13px;color:var(--text-secondary);margin-top:8px;">${preview}</div>
                                    ${tags.length > 0 ? `
                                        <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;">
                                            ${tags.slice(0, 3).map(t => `<span class="chat-tag">${t}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            content.innerHTML = html;
            safeFeatherReplace();
        }

        function highlightMatch(text, query) {
            if (!text || !query) return text;
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function navigateToSearchResult(type, id) {
            // For RAG results, we might just open the document or a relevant modal
            console.log(`Navigate to RAG result: Type: ${type}, ID: ${id}`);
            // Implement opening relevant document or showing more details
            showNotification(`Navigating to ${type} with ID: ${id}`, 'info');
            // Placeholder: Open file in Obsidian if it's a vault path
            if (type === 'document' && id) {
                const filePath = id; // Assuming id is actually the file path
                // For now, just log. In a real app, you might trigger a file open protocol
                console.log(`Opening document: ${filePath}`);
                // window.open(`obsidian://open?vault=YourVaultName&file=${encodeURIComponent(filePath)}`, '_blank');
            }
        }

        // ========================================
        // VERSION HISTORY FUNCTIONS
        // ========================================

        let currentVersionItemId = null;
        let currentVersionItemType = null;
        let allVersionsData = []; // Global variable to store fetched versions

        function showVersionHistoryLoading() {
            const panel = document.getElementById('versionHistoryPanel');
            if (panel) panel.classList.add('loading');
        }

        function hideVersionHistoryLoading() {
            const panel = document.getElementById('versionHistoryPanel');
            if (panel) panel.classList.remove('loading');
        }

        function openVersionHistoryPanel() {
            const panel = document.getElementById('versionHistoryPanel');
            const itemId = document.getElementById('itemId').value;
            const itemType = document.getElementById('itemType').value;

            if (!itemId || !itemType) {
                console.error('No item selected for version history');
                return;
            }

            currentVersionItemId = itemId;
            currentVersionItemType = itemType;

            panel.classList.add('open');
            loadVersionHistory(itemType, itemId);
            safeFeatherReplace();
        }

        function closeVersionHistoryPanel() {
            const panel = document.getElementById('versionHistoryPanel');
            panel.classList.remove('open');
            currentVersionItemId = null;
            currentVersionItemType = null;
        }

        async function loadVersionHistory(type, itemId) {
            const versionList = document.getElementById('versionList');
            versionList.innerHTML = '<div class="version-loading">Loading version history...</div>';

            try {
                const token = await getAccessToken();
                const listId = type === 'projects' ? CONFIG.PROJECTS_LIST_ID : CONFIG.TICKETS_LIST_ID;
                const url = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}/versions`;

                const response = await fetchWithRetry(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to load versions: ${response.status}`);
                }

                const data = await response.json();
                const versions = data.value || [];

                if (versions.length === 0) {
                    versionList.innerHTML = '<div class="version-empty">No version history available</div>';
                    return;
                }

                renderVersionHistory(versions, type);
            } catch (error) {
                console.error('Error loading version history:', error);
                versionList.innerHTML = `
                    <div class="version-empty">
                        <p>Unable to load version history</p>
                        <p style="font-size:12px;margin-top:8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderVersionHistory(versions, type) {
            const versionList = document.getElementById('versionList');

            // Sort versions by ID descending (newest first)
            versions.sort((a, b) => parseFloat(b.id) - parseFloat(a.id));

            const html = versions.map((version, index) => {
                const isCurrent = index === 0;
                const fields = version.fields || {};
                const modifiedDate = new Date(version.lastModifiedDateTime);
                const formattedDate = modifiedDate.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                // Get author info
                const author = version.lastModifiedBy?.user?.displayName || 'Unknown';

                // Determine changes by comparing with previous version
                let changesHtml = '';
                if (index < versions.length - 1) {
                    const prevVersion = versions[index + 1];
                    const changes = getVersionChanges(version.fields, prevVersion.fields, type);
                    if (changes.length > 0) {
                        changesHtml = `
                            <div class="version-changes">
                                ${changes.map(change => `
                                    <div class="version-change-item">
                                        <span class="version-change-field">${change.field}:</span>
                                        <span class="version-change-old">${change.oldValue || '(empty)'}</span>
                                        <span class="version-change-arrow"></span>
                                        <span class="version-change-new">${change.newValue || '(empty)'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }

                return `
                    <div class="version-item ${isCurrent ? 'current' : ''}">
                        <div class="version-header">
                            <div class="version-info">
                                <div class="version-number">
                                    Version ${version.id}
                                    ${isCurrent ? '<span class="current-badge">Current</span>' : ''}
                                </div>
                                <div class="version-meta">
                                    <span class="version-author">${author}</span>  ${formattedDate}
                                </div>
                            </div>
                            ${!isCurrent ? `
                                <button class="version-restore-btn" onclick="restoreVersion('${type}', '${currentVersionItemId}', '${version.id}')">
                                    <i data-feather="rotate-ccw" style="width:12px;height:12px;"></i>
                                    Restore
                                </button>
                                ` : ''}
                                <input type="checkbox" class="version-compare-checkbox" value="${version.id}" onchange="handleVersionComparisonSelection()">
                            </div>
                        </div>
                        ${changesHtml}
                    </div>
                `;
            }).join('');

            versionList.innerHTML = html;
            safeFeatherReplace();

            const versionPanelBody = document.querySelector('.version-panel-body');
            if (versionPanelBody && !document.getElementById('compareVersionsBtn')) {
                const compareControlsHtml = `
                    <div class="compare-controls" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                        <button class="btn btn-secondary" id="compareVersionsBtn" onclick="compareSelectedVersions()" disabled>Compare Selected</button>
                        <span id="selectedVersionsCount" style="font-size:12px;color:var(--text-muted);">0 versions selected</span>
                    </div>
                    <div id="versionComparisonDisplay" style="margin-bottom: 20px;">
                        <!-- Diff will be displayed here -->
                    </div>
                `;
                versionPanelBody.insertAdjacentHTML('afterbegin', compareControlsHtml);
            }
        }

        function handleVersionComparisonSelection() {
            const selectedCheckboxes = document.querySelectorAll('.version-compare-checkbox:checked');
            const compareBtn = document.getElementById('compareVersionsBtn');
            const selectedCountSpan = document.getElementById('selectedVersionsCount');

            selectedCountSpan.textContent = `${selectedCheckboxes.length} versions selected`;

            if (selectedCheckboxes.length === 2) {
                compareBtn.disabled = false;
            } else {
                compareBtn.disabled = true;
            }
        }

        async function compareSelectedVersions() {
            const selectedCheckboxes = document.querySelectorAll('.version-compare-checkbox:checked');
            if (selectedCheckboxes.length !== 2) {
                showNotification('Please select exactly two versions to compare.', 'warning');
                return;
            }

            const versionId1 = selectedCheckboxes[0].value;
            const versionId2 = selectedCheckboxes[1].value;

            const version1 = allVersionsData.find(v => String(v.id) === versionId1);
            const version2 = allVersionsData.find(v => String(v.id) === versionId2);

            if (!version1 || !version2) {
                showNotification('Could not find selected versions.', 'error');
                return;
            }

            const displayArea = document.getElementById('versionComparisonDisplay');
            displayArea.innerHTML = '<div class="search-loading">Comparing versions...</div>';

            // Ensure consistent order for comparison (e.g., older vs newer)
            const olderVersion = parseFloat(version1.id) < parseFloat(version2.id) ? version1 : version2;
            const newerVersion = parseFloat(version1.id) < parseFloat(version2.id) ? version2 : version1;

            const changes = getVersionChanges(newerVersion.fields, olderVersion.fields, currentVersionItemType);

            let html = `
                <div style="background:var(--surface-darker);padding:15px;border-radius:var(--radius-md);margin-bottom:15px;">
                    <h4 style="margin-bottom:10px;color:var(--text-primary);">Comparison: Version ${olderVersion.id} vs Version ${newerVersion.id}</h4>
                    ${changes.length === 0 ? '<p style="color:var(--text-muted);">No detectable changes between these versions.</p>' : ''}
                </div>
            `;

            if (changes.length > 0) {
                html += `
                    <div class="version-changes" style="border:1px solid var(--border);border-radius:var(--radius-md);padding:15px;">
                        ${changes.map(change => `
                            <div class="version-change-item" style="flex-direction:column;align-items:flex-start;">
                                <span class="version-change-field" style="margin-bottom:5px;">${change.field}:</span>
                                ${change.isInlineDiff ? `
                                    <div style="width:100%;">${change.diffHtml}</div>
                                ` : `
                                    <span class="version-change-old">${change.oldValue || '(empty)'}</span>
                                    <span class="version-change-arrow"></span>
                                    <span class="version-change-new">${change.newValue || '(empty)'}</span>
                                `}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            displayArea.innerHTML = html;

            // Clear checkboxes after comparison
            selectedCheckboxes.forEach(cb => cb.checked = false);
            handleVersionComparisonSelection(); // Update count and disable button
        }

        function getVersionChanges(currentFields, previousFields, type) {
            const changes = [];
            const fieldsToCompare = type === 'projects'
                ? ['Title', 'Description', 'Status', 'Priority', 'AssignedTo', 'Team', 'Customer', 'DueDate', 'PercentComplete']
                : ['TicketTitle', 'Description', 'Status', 'Priority', 'AssignedTo', 'Team', 'Customer', 'DueDate', 'Resolution'];

            const fieldLabels = {
                'Title': 'Name',
                'TicketTitle': 'Title',
                'Description': 'Description',
                'Status': 'Status',
                'Priority': 'Priority',
                'AssignedTo': 'Assignee',
                'Team': 'Team',
                'Customer': 'Customer',
                'DueDate': 'Due Date',
                'PercentComplete': 'Progress',
                'Resolution': 'Resolution'
            };

            const dmp = new diff_match_patch();

            for (const field of fieldsToCompare) {
                const currentVal = currentFields?.[field] || '';
                const prevVal = previousFields?.[field] || '';

                if (currentVal !== prevVal) {
                    // Special handling for text fields with inline diff
                    if (field === 'Description' || field === 'Title' || field === 'TicketTitle') {
                        const diff = dmp.diff_main(String(prevVal), String(currentVal));
                        dmp.diff_cleanupSemantic(diff); // Optional: cleanup the diff for better readability
                        const diffHtml = dmp.diff_prettyHtml(diff);
                        changes.push({
                            field: fieldLabels[field] || field,
                            diffHtml: diffHtml,
                            isInlineDiff: true
                        });
                    } else {
                        // For other fields, just show old and new values
                        changes.push({
                            field: fieldLabels[field] || field,
                            oldValue: truncateText(String(prevVal), 30),
                            newValue: truncateText(String(currentVal), 30),
                            isInlineDiff: false
                        });
                    }
                }
            }

            return changes;
        }

        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        async function restoreVersion(type, itemId, versionId) {
            if (!confirm(`Are you sure you want to restore to version ${versionId}? This will create a new version with the restored data.`)) {
                return;
            }

            try {
                const token = await getAccessToken();
                const listId = type === 'projects' ? CONFIG.PROJECTS_LIST_ID : CONFIG.TICKETS_LIST_ID;

                // First, get the version data
                const versionUrl = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}/versions/${versionId}`;
                const versionResponse = await fetchWithRetry(versionUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!versionResponse.ok) {
                    throw new Error(`Failed to get version data: ${versionResponse.status}`);
                }

                const versionData = await versionResponse.json();
                const fieldsToRestore = versionData.fields || {};

                // Prepare the update payload (only restore certain fields)
                const restoreFields = type === 'projects'
                    ? ['Title', 'Description', 'Status', 'Priority', 'AssignedTo', 'Team', 'Customer', 'Notes', 'PercentComplete']
                    : ['TicketTitle', 'Description', 'Status', 'Priority', 'AssignedTo', 'Team', 'Customer', 'Resolution'];

                const updatePayload = { fields: {} };
                for (const field of restoreFields) {
                    if (fieldsToRestore[field] !== undefined) {
                        updatePayload.fields[field] = fieldsToRestore[field];
                    }
                }

                // Update the item with the restored data
                const updateUrl = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}`;
                const updateResponse = await fetchWithRetry(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatePayload)
                });

                if (!updateResponse.ok) {
                    throw new Error(`Failed to restore version: ${updateResponse.status}`);
                }

                alert(`Successfully restored to version ${versionId}`);

                // Reload the version history and refresh data
                loadVersionHistory(type, itemId);

                // Refresh the main data
                if (type === 'projects') {
                    loadProjects();
                } else {
                    loadTickets();
                }

                // Update the modal form with restored data
                const updatedData = await updateResponse.json();
                if (updatedData.fields) {
                    populateModalFields(updatedData.fields, type);
                }

            } catch (error) {
                console.error('Error restoring version:', error);
                alert(`Failed to restore version: ${error.message}`);
            }
        }

        function populateModalFields(fields, type) {
            if (type === 'projects') {
                document.getElementById('itemName').value = fields.Title || '';
                document.getElementById('itemDescription').value = fields.Description || '';
            } else {
                document.getElementById('itemName').value = fields.TicketTitle || '';
                document.getElementById('itemDescription').value = fields.Description || '';
            }
            document.getElementById('itemStatus').value = fields.Status || '';
            document.getElementById('itemPriority').value = fields.Priority || 'Medium';
            document.getElementById('itemAssignee').value = fields.AssignedTo || '';
            document.getElementById('itemTeam').value = fields.Team || 'Engineering';
            document.getElementById('itemCustomer').value = fields.Customer || '';
            document.getElementById('itemNotes').value = fields.Notes || '';
        }

        // ========================================
        // FILE ATTACHMENTS FUNCTIONS
        // ========================================

        // SharePoint REST API base URL (for attachments)
        function getSharePointRestUrl() {
            // Extract tenant and site from site ID
            // Site ID format: tenant.sharepoint.com,guid,guid
            const siteIdParts = CONFIG.SITE_ID.split(',');
            if (siteIdParts.length >= 1) {
                const tenant = siteIdParts[0];
                // Using Microsoft Graph for attachments (simpler approach)
                return GRAPH_API;
            }
            return GRAPH_API;
        }

        // Get list name from type
        function getListName(type) {
            const listNames = {
                'projects': 'Engineering Projects',
                'tickets': 'Engineering Tickets',
                'tasks': 'Engineering Tasks'
            };
            return listNames[type] || type;
        }

        // Get file icon class based on extension
        function getFileIconClass(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['pdf'].includes(ext)) return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'xls';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) return 'img';
            return 'default';
        }

        // Get feather icon name for file type
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['pdf'].includes(ext)) return 'file-text';
            if (['doc', 'docx'].includes(ext)) return 'file-text';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'file-text';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) return 'image';
            return 'file';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Load attachments for an item
        async function loadAttachments(type, itemId) {
            const attachmentList = document.getElementById('attachmentList');
            if (!attachmentList) return;

            attachmentList.innerHTML = '<div class="attachment-loading">Loading attachments...</div>';

            try {
                const token = await getAccessToken();
                const listId = type === 'projects' ? CONFIG.PROJECTS_LIST_ID : CONFIG.TICKETS_LIST_ID;

                // Use Microsoft Graph to get item with drive info
                // Note: SharePoint list items can have attachments via the AttachmentFiles endpoint
                // But Graph API approach uses drive items which is more reliable

                // First, try to get the item's attachments folder in the list's drive
                const driveUrl = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}/driveItem`;

                const response = await fetchWithRetry(driveUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 404) {
                    // No attachments folder exists yet
                    renderAttachments([]);
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Failed to load attachments: ${response.status}`);
                }

                const driveItem = await response.json();

                // Get children of the drive item (attachments)
                const childrenUrl = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}/driveItem/children`;
                const childrenResponse = await fetchWithRetry(childrenUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!childrenResponse.ok) {
                    renderAttachments([]);
                    return;
                }

                const childrenData = await childrenResponse.json();
                renderAttachments(childrenData.value || []);

            } catch (error) {
                console.error('Error loading attachments:', error);
                attachmentList.innerHTML = `
                    <div class="attachment-empty">
                        <p>No attachments yet</p>
                        <p style="font-size:11px;margin-top:4px;color:var(--text-muted);">Drag and drop files above to attach</p>
                    </div>
                `;
            }
        }

        // Render attachments list
        function renderAttachments(attachments) {
            const attachmentList = document.getElementById('attachmentList');

            if (!attachments || attachments.length === 0) {
                attachmentList.innerHTML = `
                    <div class="attachment-empty">
                        <p>No attachments yet</p>
                        <p style="font-size:11px;margin-top:4px;color:var(--text-muted);">Drag and drop files above to attach</p>
                    </div>
                `;
                return;
            }

            const html = attachments.map(file => {
                const iconClass = getFileIconClass(file.name);
                const icon = getFileIcon(file.name);
                const size = formatFileSize(file.size || 0);
                const modifiedDate = file.lastModifiedDateTime ? new Date(file.lastModifiedDateTime).toLocaleDateString() : '';

                return `
                    <div class="attachment-item" data-file-id="${file.id}" data-file-name="${file.name}">
                        <div class="attachment-icon ${iconClass}">
                            <i data-feather="${icon}" style="width:18px;height:18px;"></i>
                        </div>
                        <div class="attachment-info">
                            <div class="attachment-name">${file.name}</div>
                            <div class="attachment-meta">${size}  ${modifiedDate}</div>
                        </div>
                        <div class="attachment-actions">
                            <button class="attachment-btn download" title="Download" onclick="downloadAttachment('${file.id}', '${file.name}')">
                                <i data-feather="download" style="width:14px;height:14px;"></i>
                            </button>
                            <button class="attachment-btn delete" title="Delete" onclick="deleteAttachment('${file.id}', '${file.name}')">
                                <i data-feather="trash-2" style="width:14px;height:14px;"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            attachmentList.innerHTML = html;
            safeFeatherReplace();
        }

        // Upload attachment
        async function uploadAttachment(file) {
            const itemId = document.getElementById('itemId').value;
            const itemType = document.getElementById('itemType').value;

            if (!itemId || !itemType) {
                alert('Please save the item first before adding attachments.');
                return;
            }

            // Check file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                return;
            }

            // Show upload progress
            const attachmentList = document.getElementById('attachmentList');
            const progressHtml = `
                <div class="attachment-upload-progress" id="upload-progress-${file.name.replace(/[^a-z0-9]/gi, '')}">
                    <div class="attachment-icon default">
                        <i data-feather="upload" style="width:18px;height:18px;"></i>
                    </div>
                    <div class="attachment-info" style="flex:1;">
                        <div class="attachment-name">${file.name}</div>
                        <div class="attachment-progress-bar">
                            <div class="attachment-progress-fill" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            `;

            // Prepend progress indicator
            const emptyMsg = attachmentList.querySelector('.attachment-empty');
            if (emptyMsg) emptyMsg.remove();
            attachmentList.insertAdjacentHTML('afterbegin', progressHtml);
            safeFeatherReplace();

            try {
                const token = await getAccessToken();
                const listId = itemType === 'projects' ? CONFIG.PROJECTS_LIST_ID : CONFIG.TICKETS_LIST_ID;

                // Upload using Microsoft Graph - put to driveItem children
                const uploadUrl = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}/driveItem:/${file.name}:/content`;

                const response = await fetchWithRetry(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': file.type || 'application/octet-stream'
                    },
                    body: file
                });

                // Remove progress indicator
                const progressEl = document.getElementById(`upload-progress-${file.name.replace(/[^a-z0-9]/gi, '')}`);
                if (progressEl) progressEl.remove();

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }

                // Reload attachments
                loadAttachments(itemType, itemId);

            } catch (error) {
                console.error('Error uploading attachment:', error);

                // Remove progress indicator
                const progressEl = document.getElementById(`upload-progress-${file.name.replace(/[^a-z0-9]/gi, '')}`);
                if (progressEl) progressEl.remove();

                alert(`Failed to upload "${file.name}": ${error.message}`);
            }
        }

        // Download attachment
        async function downloadAttachment(fileId, fileName) {
            const itemId = document.getElementById('itemId').value;
            const itemType = document.getElementById('itemType').value;

            try {
                const token = await getAccessToken();
                const listId = itemType === 'projects' ? CONFIG.PROJECTS_LIST_ID : CONFIG.TICKETS_LIST_ID;

                // Get download URL
                const url = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}/driveItem/children/${fileId}/content`;

                const response = await fetchWithRetry(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Download failed: ${response.status}`);
                }

                // Create blob and download
                const blob = await response.blob();
                const downloadUrl = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(downloadUrl);

            } catch (error) {
                console.error('Error downloading attachment:', error);
                alert(`Failed to download "${fileName}": ${error.message}`);
            }
        }

        // Delete attachment
        async function deleteAttachment(fileId, fileName) {
            if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
                return;
            }

            const itemId = document.getElementById('itemId').value;
            const itemType = document.getElementById('itemType').value;

            try {
                const token = await getAccessToken();
                const listId = itemType === 'projects' ? CONFIG.PROJECTS_LIST_ID : CONFIG.TICKETS_LIST_ID;

                const url = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}/driveItem/children/${fileId}`;

                const response = await fetchWithRetry(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok && response.status !== 204) {
                    throw new Error(`Delete failed: ${response.status}`);
                }

                // Reload attachments
                loadAttachments(itemType, itemId);

            } catch (error) {
                console.error('Error deleting attachment:', error);
                alert(`Failed to delete "${fileName}": ${error.message}`);
            }
        }

        // Initialize attachments UI
        function initAttachments() {
            const dropzone = document.getElementById('attachmentDropzone');
            const fileInput = document.getElementById('attachmentFileInput');

            if (!dropzone || !fileInput) return;

            // Click to upload
            dropzone.addEventListener('click', () => {
                fileInput.click();
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                for (const file of files) {
                    uploadAttachment(file);
                }
                fileInput.value = ''; // Reset for next upload
            });

            // Drag and drop
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');

                const files = e.dataTransfer.files;
                for (const file of files) {
                    uploadAttachment(file);
                }
            });
        }

        // Load attachments when modal opens
        function loadAttachmentsOnModalOpen() {
            const itemId = document.getElementById('itemId').value;
            const itemType = document.getElementById('itemType').value;

            if (itemId && itemType) {
                loadAttachments(itemType, itemId);
            } else {
                // New item - show empty state
                const attachmentList = document.getElementById('attachmentList');
                if (attachmentList) {
                    attachmentList.innerHTML = `
                        <div class="attachment-empty">
                            <p>Save the item first to add attachments</p>
                        </div>
                    `;
                }
            }
        }

        // Initialize Version History UI
        function initVersionHistory() {
            const historyBtn = document.getElementById('modalHistoryBtn');
            const closeBtn = document.getElementById('closeVersionPanel');

            if (historyBtn) {
                historyBtn.addEventListener('click', openVersionHistoryPanel);
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', closeVersionHistoryPanel);
            }
        }

        // ========================================
        // BULK EDIT FUNCTIONS
        // ========================================

        let bulkSelectedItems = new Set();
        let bulkSelectedType = null;

        function handleCardClick(event, itemId, type) {
            // If clicking the checkbox area, don't open modal
            if (event.target.closest('.chat-card-checkbox')) {
                return;
            }

            // Validate type parameter - must be 'projects' or 'tickets'
            const validTypes = ['projects', 'tickets'];
            if (!validTypes.includes(type)) {
                console.error('handleCardClick: Invalid type parameter:', type);
                showNotification('Unable to open item: invalid type', 'error');
                return;
            }

            // Validate itemId exists
            if (!itemId) {
                console.error('handleCardClick: Missing itemId');
                showNotification('Unable to open item: missing ID', 'error');
                return;
            }

            // Pre-flight check: verify item exists before opening
            if (type === 'projects') {
                const project = projectsData.find(p => String(p.id) === String(itemId));
                if (!project) {
                    console.error('handleCardClick: Project not found:', itemId);
                    showNotification('Project not found. It may have been deleted.', 'error');
                    return;
                }
                showProjectDetail(itemId);
            } else if (type === 'tickets') {
                const ticket = ticketsData.find(t => String(t.id) === String(itemId));
                if (!ticket) {
                    console.error('handleCardClick: Ticket not found:', itemId);
                    showNotification('Ticket not found. It may have been deleted.', 'error');
                    return;
                }
                showModal('edit', type, itemId);
            }
        }

        function toggleBulkSelect(itemId, type) {
            // If selecting a different type, clear previous selection
            if (bulkSelectedType && bulkSelectedType !== type) {
                clearBulkSelection();
            }
            bulkSelectedType = type;

            const card = document.querySelector(`.chat-card[data-id="${itemId}"]`);

            if (bulkSelectedItems.has(itemId)) {
                bulkSelectedItems.delete(itemId);
                card?.classList.remove('selected');
            } else {
                bulkSelectedItems.add(itemId);
                card?.classList.add('selected');
            }

            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const countEl = document.getElementById('bulkSelectedCount');

            if (bulkSelectedItems.size > 0) {
                bar.classList.add('show');
                countEl.textContent = bulkSelectedItems.size;
                safeFeatherReplace();
            } else {
                bar.classList.remove('show');
            }
        }

        function clearBulkSelection() {
            bulkSelectedItems.clear();
            bulkSelectedType = null;
            document.querySelectorAll('.chat-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            updateBulkActionsBar();
        }

        function openBulkEditModal() {
            if (bulkSelectedItems.size === 0) return;

            const modal = document.getElementById('bulkEditModal');
            document.getElementById('bulkEditCount').textContent = bulkSelectedItems.size;

            // Populate assignee dropdown
            const assigneeSelect = document.getElementById('bulkAssignee');
            const users = adUsers.length > 0 ? adUsers : FALLBACK_USERS;
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>' +
                users.map(u => `<option value="${u.displayName}">${u.displayName}</option>`).join('');

            // Reset all toggles and fields
            ['Status', 'Priority', 'Assignee', 'Team', 'DueDate'].forEach(field => {
                document.getElementById(`bulkUpdate${field}`).checked = false;
                document.getElementById(`bulk${field}`).disabled = true;
            });

            // Add toggle listeners
            ['Status', 'Priority', 'Assignee', 'Team', 'DueDate'].forEach(field => {
                const checkbox = document.getElementById(`bulkUpdate${field}`);
                const input = document.getElementById(`bulk${field}`);
                checkbox.onchange = () => {
                    input.disabled = !checkbox.checked;
                };
            });

            modal.style.display = 'flex';
            safeFeatherReplace();
        }

        function closeBulkEditModal() {
            document.getElementById('bulkEditModal').style.display = 'none';
        }

        async function applyBulkEdit() {
            if (bulkSelectedItems.size === 0) return;

            const updates = {};

            // Collect enabled updates
            if (document.getElementById('bulkUpdateStatus').checked) {
                updates.Status = document.getElementById('bulkStatus').value;
            }
            if (document.getElementById('bulkUpdatePriority').checked) {
                updates.Priority = document.getElementById('bulkPriority').value;
            }
            if (document.getElementById('bulkUpdateAssignee').checked) {
                updates.AssignedTo = document.getElementById('bulkAssignee').value;
            }
            if (document.getElementById('bulkUpdateTeam').checked) {
                updates.Team = document.getElementById('bulkTeam').value;
            }
            if (document.getElementById('bulkUpdateDueDate').checked) {
                updates.DueDate = document.getElementById('bulkDueDate').value;
            }

            if (Object.keys(updates).length === 0) {
                alert('Please select at least one field to update.');
                return;
            }

            const token = await getAccessToken();
            const listId = bulkSelectedType === 'projects' ? CONFIG.projectsListId : CONFIG.ticketsListId;
            const items = bulkSelectedType === 'projects' ? projectsData : ticketsData;

            let successCount = 0;
            let errorCount = 0;

            for (const itemId of bulkSelectedItems) {
                try {
                    const url = `${GRAPH_API}/sites/${CONFIG.SITE_ID}/lists/${listId}/items/${itemId}`;
                    const response = await fetchWithRetry(url, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields: updates })
                    });

                    if (response.ok) {
                        // Update local data
                        const item = items.find(i => String(i.id) === String(itemId));
                        if (item) {
                            Object.assign(item.fields, updates);
                        }
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Error updating item:', error);
                    errorCount++;
                }
            }

            closeBulkEditModal();
            clearBulkSelection();

            // Refresh view
            renderItems(bulkSelectedType || 'projects');

            if (errorCount > 0) {
                alert(`Updated ${successCount} items. ${errorCount} failed.`);
            } else {
                alert(`Successfully updated ${successCount} items.`);
            }
        }

        function bulkChangeStatus() {
            const newStatus = prompt('Enter new status (Not Started, In Progress, On Hold, Completed, Archived, Open, Pending, Resolved, Closed):');
            if (!newStatus) return;

            document.getElementById('bulkUpdateStatus').checked = true;
            document.getElementById('bulkStatus').disabled = false;
            document.getElementById('bulkStatus').value = newStatus;
            openBulkEditModal();
        }

        function bulkChangeAssignee() {
            openBulkEditModal();
            document.getElementById('bulkUpdateAssignee').checked = true;
            document.getElementById('bulkAssignee').disabled = false;
        }

        // ========================================
        // CALENDAR VIEW FUNCTIONS
        // ========================================

        let calendarCurrentDate = new Date();

        function initCalendar() {
            const prevBtn = document.getElementById('calendarPrev');
            const nextBtn = document.getElementById('calendarNext');
            const todayBtn = document.getElementById('calendarToday');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
                    renderCalendar();
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
                    renderCalendar();
                });
            }

            if (todayBtn) {
                todayBtn.addEventListener('click', () => {
                    calendarCurrentDate = new Date();
                    renderCalendar();
                });
            }

            // Filter checkboxes
            ['calShowProjects', 'calShowTickets', 'calShowTasks'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', renderCalendar);
                }
            });

            // Don't render here - loadData() will render after data is loaded
        }

        function renderCalendar() {
            const container = document.getElementById('calendarDays');
            const titleEl = document.getElementById('calendarTitle');
            if (!container) return;

            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();

            // Update title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            titleEl.textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const totalDays = lastDay.getDate();

            // Get days from previous month
            const prevMonthLastDay = new Date(year, month, 0).getDate();

            // Get filter settings
            const showProjects = document.getElementById('calShowProjects')?.checked ?? true;
            const showTickets = document.getElementById('calShowTickets')?.checked ?? true;
            const showTasks = document.getElementById('calShowTasks')?.checked ?? true;

            // Build calendar events map
            const eventsMap = buildEventsMap(year, month, showProjects, showTickets, showTasks);

            // Build calendar HTML
            let html = '';
            let dayCount = 1;
            let nextMonthDay = 1;
            const today = new Date();

            // Calculate total cells needed (6 rows max)
            const totalCells = Math.ceil((startingDay + totalDays) / 7) * 7;

            for (let i = 0; i < totalCells; i++) {
                let dayNumber, isOtherMonth = false, dateStr;

                if (i < startingDay) {
                    // Previous month
                    dayNumber = prevMonthLastDay - startingDay + i + 1;
                    isOtherMonth = true;
                    dateStr = formatDateKey(year, month - 1, dayNumber);
                } else if (dayCount > totalDays) {
                    // Next month
                    dayNumber = nextMonthDay++;
                    isOtherMonth = true;
                    dateStr = formatDateKey(year, month + 1, dayNumber);
                } else {
                    // Current month
                    dayNumber = dayCount++;
                    dateStr = formatDateKey(year, month, dayNumber);
                }

                const isToday = !isOtherMonth &&
                    today.getDate() === dayNumber &&
                    today.getMonth() === month &&
                    today.getFullYear() === year;

                const dayEvents = eventsMap[dateStr] || [];
                const displayEvents = dayEvents.slice(0, 3);
                const moreCount = dayEvents.length - 3;

                html += `
                    <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}">
                        <div class="calendar-day-number">${dayNumber}</div>
                        <div class="calendar-events">
                            ${displayEvents.map(event => `
                                <div class="calendar-event ${event.type}" onclick="${event.onclick}" title="${event.title}">
                                    ${event.title}
                                </div>
                            `).join('')}
                            ${moreCount > 0 ? `<div class="calendar-more">+${moreCount} more</div>` : ''}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function formatDateKey(year, month, day) {
            // Handle month overflow
            const date = new Date(year, month, day);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function buildEventsMap(year, month, showProjects, showTickets, showTasks) {
            const eventsMap = {};

            console.log('buildEventsMap called:', { year, month, showProjects, showTickets, showTasks });
            console.log('Projects data count:', projectsData?.length);
            console.log('Active projects:', projectsData?.filter(p => !['Archived', 'Completed'].includes(p.fields?.Status)).map(p => ({
                id: p.id, name: p.fields?.Title, status: p.fields?.Status, due: p.fields?.DueDate
            })));

            // Helper to add event to map (with deduplication)
            const addEvent = (dateStr, event) => {
                if (!eventsMap[dateStr]) eventsMap[dateStr] = [];
                // Prevent duplicate entries with same title on same date
                const isDuplicate = eventsMap[dateStr].some(e =>
                    e.title === event.title && e.type === event.type
                );
                if (!isDuplicate) {
                    eventsMap[dateStr].push(event);
                }
            };

            // Get date range for the calendar view (include prev/next month days shown)
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month + 2, 0);

            // Add projects (exclude archived/completed)
            if (showProjects) {
                projectsData
                    .filter(p => !['Archived', 'Completed'].includes(p.fields?.Status))
                    .forEach(project => {
                        const dueDate = project.fields.DueDate;
                        console.log('Project for calendar:', project.fields?.Title, 'due:', dueDate);
                        if (dueDate) {
                            const dateStr = dueDate.split('T')[0];
                            addEvent(dateStr, {
                                type: 'project',
                                title: project.fields.Title || project.fields.LinkTitle || 'Untitled Project',
                                onclick: `showProjectDetail('${project.id}')`
                            });
                        }
                    });
            }

            // Add tickets (exclude closed/resolved)
            if (showTickets) {
                ticketsData
                    .filter(t => !['Closed', 'Resolved'].includes(t.fields?.Status))
                    .forEach(ticket => {
                        const dueDate = ticket.fields.DueDate;
                        if (dueDate) {
                            const dateStr = dueDate.split('T')[0];
                            addEvent(dateStr, {
                                type: 'ticket',
                                title: ticket.fields.TicketTitle || 'Untitled Ticket',
                                onclick: `showModal('edit', 'tickets', '${ticket.id}')`
                            });
                        }
                    });
            }

            // Add tasks (exclude done/completed)
            // Note: Tasks use 'DueDate' field (not TaskDueDate) as set in createTask()
            if (showTasks) {
                tasksData
                    .filter(t => !['Done', 'Completed', 'Closed'].includes(t.fields?.Status))
                    .forEach(task => {
                        const dueDate = task.fields?.DueDate;
                        if (dueDate) {
                            const dateStr = dueDate.split('T')[0];
                            addEvent(dateStr, {
                                type: 'task',
                                title: task.fields?.TaskTitle || 'Untitled Task',
                                onclick: `showProjectDetail('${task.fields?.ProjectID || ''}')`
                            });
                        }
                    });
            }

            return eventsMap;
        }

        // ========================================
        // TIME TRACKING FUNCTIONS
        // ========================================

        let currentTimeReportView = 'byEmployee';

        function showTimeEntryModal(editEntry = null) {
            const modal = document.getElementById('timeEntryModal');
            const employeeSelect = document.getElementById('timeEntryEmployee');
            const projectSelect = document.getElementById('timeEntryProject');

            // Populate employee dropdown
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            adUsers.forEach(user => {
                employeeSelect.innerHTML += `<option value="${escapeAttr(user.displayName)}">${escapeHtml(user.displayName)}</option>`;
            });

            // Set current user as default
            if (currentUser.displayName && !editEntry) {
                employeeSelect.value = currentUser.displayName;
            }

            // Populate project/ticket dropdown
            projectSelect.innerHTML = '<option value="">None (General)</option>';
            projectsData.forEach(p => {
                const name = p.fields.Title || p.fields.LinkTitle || 'Untitled Project';
                projectSelect.innerHTML += `<option value="project:${escapeAttr(p.id)}">${escapeHtml(name)}</option>`;
            });
            ticketsData.forEach(t => {
                const name = t.fields.TicketTitle || 'Untitled Ticket';
                projectSelect.innerHTML += `<option value="ticket:${escapeAttr(t.id)}">[Ticket] ${escapeHtml(name)}</option>`;
            });

            // Reset task dropdown
            const taskSelect = document.getElementById('timeEntryTask');
            taskSelect.innerHTML = '<option value="">No Task Selected</option>';

            // Set today's date as default
            if (!editEntry) {
                document.getElementById('timeEntryDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('timeEntryHours').value = '';
                document.getElementById('timeEntryDescription').value = '';
                document.getElementById('timeEntryBillable').checked = true;
                document.getElementById('timeEntryType').value = 'Project';
                document.getElementById('timeEntryId').value = '';
                document.getElementById('timeEntryProject').value = '';
                document.getElementById('timeEntryTask').value = '';
            } else {
                document.getElementById('timeEntryId').value = editEntry.id;
                document.getElementById('timeEntryEmployee').value = editEntry.employee;
                document.getElementById('timeEntryDate').value = editEntry.date;
                document.getElementById('timeEntryHours').value = editEntry.hours;
                document.getElementById('timeEntryDescription').value = editEntry.description || '';
                document.getElementById('timeEntryBillable').checked = editEntry.billable !== false;
                document.getElementById('timeEntryType').value = editEntry.type || 'Project';
                document.getElementById('timeEntryProject').value = editEntry.projectRef || '';

                // If editing, populate task dropdown and set value
                if (editEntry.projectRef) {
                    updateTaskDropdown();
                    if (editEntry.taskId) {
                        document.getElementById('timeEntryTask').value = editEntry.taskId;
                    }
                }
            }

            modal.classList.add('active');
            safeFeatherReplace();
        }

        // Update task dropdown based on selected project/ticket
        function updateTaskDropdown() {
            const projectRef = document.getElementById('timeEntryProject').value;
            const taskSelect = document.getElementById('timeEntryTask');

            taskSelect.innerHTML = '<option value="">No Task Selected</option>';

            if (!projectRef) return;

            const [pType, pId] = projectRef.split(':');

            // Find tasks linked to this project or ticket
            let linkedTasks = [];

            if (pType === 'project') {
                // Find the linked ticket for this project
                const linkedTicket = ticketsData.find(t => String(t.fields?.ProjectID) === String(pId));
                if (linkedTicket) {
                    // Get tasks linked to this ticket
                    linkedTasks = tasksData.filter(t => String(t.fields?.TicketID) === String(linkedTicket.id));
                }
            } else if (pType === 'ticket') {
                // Get tasks directly linked to this ticket
                linkedTasks = tasksData.filter(t => String(t.fields?.TicketID) === String(pId));
            }

            if (linkedTasks.length > 0) {
                linkedTasks.forEach(task => {
                    const taskTitle = task.fields?.TaskTitle || 'Untitled Task';
                    const taskStatus = task.fields?.Status || 'To Do';
                    taskSelect.innerHTML += `<option value="${escapeAttr(task.id)}">${escapeHtml(taskTitle)} [${escapeHtml(taskStatus)}]</option>`;
                });
            }
        }

        function closeTimeEntryModal() {
            document.getElementById('timeEntryModal').classList.remove('active');
        }

        async function saveTimeEntry() {
            const id = document.getElementById('timeEntryId').value;
            const employee = document.getElementById('timeEntryEmployee').value;
            const date = document.getElementById('timeEntryDate').value;
            const hours = parseFloat(document.getElementById('timeEntryHours').value);
            const type = document.getElementById('timeEntryType').value;
            const projectRef = document.getElementById('timeEntryProject').value;
            const taskId = document.getElementById('timeEntryTask').value; // NEW: Task linkage
            const description = document.getElementById('timeEntryDescription').value;
            const billable = document.getElementById('timeEntryBillable').checked;

            // Enhanced Validation
            const validationErrors = [];

            // Employee validation
            if (!employee) {
                validationErrors.push('Please select an employee');
            } else if (!ALLOWED_USERS.find(u => u.displayName === employee)) {
                validationErrors.push('Invalid employee selected');
            }

            // Date validation
            if (!date) {
                validationErrors.push('Please select a date');
            } else {
                const entryDate = new Date(date);
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(today.getFullYear() - 1);

                if (entryDate > today) {
                    validationErrors.push('Cannot log time for future dates');
                } else if (entryDate < oneYearAgo) {
                    validationErrors.push('Cannot log time more than 1 year ago');
                }
            }

            // Hours validation
            if (!hours || isNaN(hours)) {
                validationErrors.push('Please enter valid hours');
            } else if (hours <= 0) {
                validationErrors.push('Hours must be greater than 0');
            } else if (hours > 24) {
                validationErrors.push('Hours cannot exceed 24 per day');
            }

            // Check daily total (excluding current entry if editing)
            if (employee && date && hours > 0) {
                const existingId = document.getElementById('timeEntryId').value;
                const dailyTotal = timeEntriesData
                    .filter(e => e.employee === employee && e.date === date && e.id !== existingId)
                    .reduce((sum, e) => sum + (e.hours || 0), 0);

                if (dailyTotal + hours > 24) {
                    validationErrors.push(`Total hours for ${employee} on ${date} would exceed 24 (existing: ${dailyTotal.toFixed(1)}h)`);
                }
            }

            // Show all validation errors
            if (validationErrors.length > 0) {
                showNotification(validationErrors.join('. '), 'error');
                return;
            }

            // Parse project reference
            let projectId = null;
            let projectName = 'General';
            let projectType = null;
            if (projectRef) {
                const [pType, pId] = projectRef.split(':');
                projectId = pId;
                projectType = pType;
                if (pType === 'project') {
                    const proj = projectsData.find(p => String(p.id) === String(pId));
                    projectName = proj ? (proj.fields.Title || proj.fields.LinkTitle) : 'Unknown Project';
                } else {
                    const ticket = ticketsData.find(t => String(t.id) === String(pId));
                    projectName = ticket ? ticket.fields.TicketTitle : 'Unknown Ticket';
                }
            }

            // Parse task reference (NEW)
            let taskName = null;
            let ticketId = null;
            if (taskId) {
                const task = tasksData.find(t => String(t.id) === String(taskId));
                if (task) {
                    taskName = task.fields?.TaskTitle || 'Untitled Task';
                    ticketId = task.fields?.TicketID || null;
                }
            }

            let isNew = false;
            let existingEntry = null;

            const entry = {
                id: id || `time-${Date.now()}`,
                employee,
                date,
                hours,
                type,
                projectId,
                projectType,
                projectName,
                projectRef, // Store for editing
                taskId: taskId || null, // NEW: Link to task
                taskName: taskName, // NEW: Task name for display
                ticketId: ticketId, // NEW: Ticket ID for reports
                description,
                billable,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (id) {
                // Update existing
                const index = timeEntriesData.findIndex(e => e.id === id);
                if (index !== -1) {
                    existingEntry = timeEntriesData[index];
                    entry.createdAt = existingEntry.createdAt;
                    entry.sharePointId = existingEntry.sharePointId;
                    timeEntriesData[index] = entry;
                }
            } else {
                // Add new
                isNew = true;
                timeEntriesData.push(entry);
            }

            // Save to SharePoint first, add to sync queue on failure
            const saved = await saveTimeEntryToSharePoint(entry, isNew);
            if (!saved) {
                // Add to sync queue for later retry
                addToSyncQueue(isNew ? 'create' : 'update', entry);
            } else {
                // Remove from sync queue if it was previously queued
                removeFromSyncQueue(entry.id);
            }

            // Always save to localStorage as backup
            localStorage.setItem('timeEntriesData', JSON.stringify(timeEntriesData));

            // --- Send WebSocket update ---
            if (socket && entry.id && saved) { // Only broadcast if actually saved to SharePoint
                sendUpdateToBackend('timeEntries', entry.id, isNew ? 'created' : 'updated');
            }

            closeTimeEntryModal();
            renderTimeReports();
            showNotification(`Time entry ${id ? 'updated' : 'saved'} ${saved ? 'successfully' : '(offline - will sync later)'}`, saved ? 'success' : 'warning');
        }

        async function deleteTimeEntry(entryId) {
            if (!confirm('Delete this time entry?')) return;

            // Find entry to get SharePoint ID
            const entry = timeEntriesData.find(e => e.id === entryId);
            const sharePointId = entry ? entry.sharePointId : null;

            // Delete from SharePoint, add to sync queue on failure
            const deleted = await deleteTimeEntryFromSharePoint(sharePointId);
            if (!deleted && sharePointId) {
                // Add delete operation to sync queue
                addToSyncQueue('delete', entry);
            }

            // Delete from local array
            timeEntriesData = timeEntriesData.filter(e => e.id !== entryId);
            localStorage.setItem('timeEntriesData', JSON.stringify(timeEntriesData));
            renderTimeReports();
            showNotification(`Time entry deleted ${deleted ? '' : '(will sync later)'}`, deleted ? 'success' : 'warning');
        }

        function setTimeReportView(view) {
            currentTimeReportView = view;
            document.querySelectorAll('.time-view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            renderTimeReports();
        }

        function applyTimeReportFilters() {
            renderTimeReports();
        }

        function getFilteredTimeEntries() {
            const startDate = document.getElementById('timeReportStartDate').value;
            const endDate = document.getElementById('timeReportEndDate').value;
            const employee = document.getElementById('timeReportEmployee').value;
            const project = document.getElementById('timeReportProject').value;

            return timeEntriesData.filter(entry => {
                if (startDate && entry.date < startDate) return false;
                if (endDate && entry.date > endDate) return false;
                if (employee && entry.employee !== employee) return false;
                if (project && `${entry.projectType}:${entry.projectId}` !== project) return false;
                return true;
            });
        }

        // Employee billable rates (will be loaded from SharePoint Employees list)
        let employeeBillableRates = {
            'Mavrick Faison': 150,
            'Patrick McFarland': 135,
            'Robbie McFarland': 200
        };

        function getEmployeeBillableRate(employeeName) {
            return employeeBillableRates[employeeName] || 125; // Default rate
        }

        function renderTimeReports() {
            const entries = getFilteredTimeEntries();
            const container = document.getElementById('timeReportContent');

            // Calculate summary stats
            const totalHours = entries.reduce((sum, e) => sum + e.hours, 0);
            const billableHours = entries.filter(e => e.billable !== false).reduce((sum, e) => sum + e.hours, 0);
            const nonBillableHours = totalHours - billableHours;
            const uniqueEmployees = new Set(entries.map(e => e.employee)).size;
            const projectsCovered = new Set(entries.filter(e => e.projectId).map(e => e.projectId)).size;
            const uniqueDays = new Set(entries.map(e => e.date)).size;

            // Calculate billable amount
            let totalBillableAmount = 0;
            entries.forEach(e => {
                if (e.billable !== false) {
                    const rate = getEmployeeBillableRate(e.employee);
                    totalBillableAmount += e.hours * rate;
                }
            });

            // Calculate utilization rate (billable / total)
            const utilizationRate = totalHours > 0 ? ((billableHours / totalHours) * 100).toFixed(0) : 0;

            // Update summary stats
            document.getElementById('totalHoursWorked').textContent = totalHours.toFixed(1);
            document.getElementById('billableHoursTotal').textContent = billableHours.toFixed(1);
            document.getElementById('billableAmount').textContent = '$' + totalBillableAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('utilizationRate').textContent = utilizationRate + '%';
            document.getElementById('uniqueEmployees').textContent = uniqueEmployees;
            document.getElementById('projectsCovered').textContent = projectsCovered;

            // Update filter dropdowns
            updateTimeReportFilters();

            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:60px;text-align:center;">
                        <i data-feather="clock" style="width:48px;height:48px;color:var(--text-muted);margin-bottom:16px;"></i>
                        <h3 style="color:var(--text);margin-bottom:8px;">No Time Entries</h3>
                        <p style="color:var(--text-muted);margin-bottom:20px;">No entries match your filters</p>
                        <button class="btn btn-primary" onclick="showTimeEntryModal()">
                            <i data-feather="plus" style="width:16px;height:16px;"></i>
                            Log Time Entry
                        </button>
                    </div>
                `;
                safeFeatherReplace();
                return;
            }

            switch (currentTimeReportView) {
                case 'byEmployee':
                    renderByEmployeeView(entries, container);
                    break;
                case 'byProject':
                    renderByProjectView(entries, container);
                    break;
                case 'byTask':
                    renderByTaskView(entries, container);
                    break;
                case 'entries':
                    renderEntriesView(entries, container);
                    break;
                case 'billing':
                    renderBillingView(entries, container);
                    break;
            }
            renderHoursByWorkTypeChart(entries); // Call the new chart function
            safeFeatherReplace();
        }

        let hoursByWorkTypeChartInstance = null; // To store the chart instance

        function renderHoursByWorkTypeChart(entries) {
            const ctx = document.getElementById('hoursByWorkTypeChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (hoursByWorkTypeChartInstance) {
                hoursByWorkTypeChartInstance.destroy();
            }

            const workTypeData = {};
            entries.forEach(entry => {
                const type = entry.type || 'Other';
                workTypeData[type] = (workTypeData[type] || 0) + entry.hours;
            });

            const labels = Object.keys(workTypeData);
            const data = Object.values(workTypeData);

            const colors = [
                '#6366f1', // primary
                '#0ea5e9', // secondary
                '#10b981', // success
                '#f59e0b', // warning
                '#ef4444', // danger
                '#8b5cf6', // purple
                '#ec4899', // pink
                '#64748b'  // text-secondary
            ];

            hoursByWorkTypeChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                                font: {
                                    size: 13
                                }
                            }
                        },
                        title: {
                            display: false,
                            text: 'Hours by Work Type',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim()
                        }
                    }
                }
            });
        }

        function renderByEmployeeView(entries, container) {
            const byEmployee = {};
            entries.forEach(e => {
                if (!byEmployee[e.employee]) {
                    byEmployee[e.employee] = { hours: 0, billableHours: 0, entries: [] };
                }
                byEmployee[e.employee].hours += e.hours;
                if (e.billable) byEmployee[e.employee].billableHours += e.hours;
                byEmployee[e.employee].entries.push(e);
            });

            const sorted = Object.entries(byEmployee).sort((a, b) => b[1].hours - a[1].hours);

            container.innerHTML = `
                <div class="time-report-table">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--bg-tertiary);">
                                <th style="text-align:left;padding:12px;border-bottom:1px solid var(--border);">Employee</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Total Hours</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Billable</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Non-Billable</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Entries</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(([employee, data]) => `
                                <tr style="border-bottom:1px solid var(--border);">
                                    <td style="padding:12px;">
                                        <div style="display:flex;align-items:center;gap:10px;">
                                            <div class="chat-assignee-avatar">${escapeHtml(getInitials(employee))}</div>
                                            <span style="font-weight:500;">${escapeHtml(employee)}</span>
                                        </div>
                                    </td>
                                    <td style="text-align:right;padding:12px;font-weight:600;color:var(--primary);">${data.hours.toFixed(1)}h</td>
                                    <td style="text-align:right;padding:12px;color:var(--success);">${data.billableHours.toFixed(1)}h</td>
                                    <td style="text-align:right;padding:12px;color:var(--text-muted);">${(data.hours - data.billableHours).toFixed(1)}h</td>
                                    <td style="text-align:right;padding:12px;">${data.entries.length}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderByProjectView(entries, container) {
            const byProject = {};
            entries.forEach(e => {
                const key = e.projectId || 'general';
                if (!byProject[key]) {
                    byProject[key] = { name: e.projectName, type: e.projectType, hours: 0, billableHours: 0, employees: new Set() };
                }
                byProject[key].hours += e.hours;
                if (e.billable) byProject[key].billableHours += e.hours;
                byProject[key].employees.add(e.employee);
            });

            const sorted = Object.entries(byProject).sort((a, b) => b[1].hours - a[1].hours);

            container.innerHTML = `
                <div class="time-report-table">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--bg-tertiary);">
                                <th style="text-align:left;padding:12px;border-bottom:1px solid var(--border);">Project/Ticket</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Total Hours</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Billable</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Team Members</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(([id, data]) => `
                                <tr style="border-bottom:1px solid var(--border);">
                                    <td style="padding:12px;">
                                        <div style="display:flex;align-items:center;gap:10px;">
                                            <i data-feather="${data.type === 'ticket' ? 'tag' : 'folder'}" style="width:16px;height:16px;color:var(--${data.type === 'ticket' ? 'warning' : 'primary'});"></i>
                                            <span style="font-weight:500;">${escapeHtml(data.name)}</span>
                                        </div>
                                    </td>
                                    <td style="text-align:right;padding:12px;font-weight:600;color:var(--primary);">${data.hours.toFixed(1)}h</td>
                                    <td style="text-align:right;padding:12px;color:var(--success);">${data.billableHours.toFixed(1)}h</td>
                                    <td style="text-align:right;padding:12px;">${data.employees.size}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // NEW: Render time entries grouped by Task (within Projects)
        function renderByTaskView(entries, container) {
            // Group by Project first, then by Task
            const byProject = {};

            entries.forEach(e => {
                const projectKey = e.projectId || 'general';
                if (!byProject[projectKey]) {
                    byProject[projectKey] = {
                        name: e.projectName || 'General',
                        type: e.projectType,
                        hours: 0,
                        billableHours: 0,
                        tasks: {},
                        unassignedHours: 0,
                        unassignedBillable: 0
                    };
                }

                byProject[projectKey].hours += e.hours;
                if (e.billable) byProject[projectKey].billableHours += e.hours;

                // Group by task within project
                if (e.taskId) {
                    const taskKey = e.taskId;
                    if (!byProject[projectKey].tasks[taskKey]) {
                        byProject[projectKey].tasks[taskKey] = {
                            name: e.taskName || 'Unnamed Task',
                            hours: 0,
                            billableHours: 0,
                            employees: new Set()
                        };
                    }
                    byProject[projectKey].tasks[taskKey].hours += e.hours;
                    if (e.billable) byProject[projectKey].tasks[taskKey].billableHours += e.hours;
                    byProject[projectKey].tasks[taskKey].employees.add(e.employee);
                } else {
                    // Time not assigned to a task
                    byProject[projectKey].unassignedHours += e.hours;
                    if (e.billable) byProject[projectKey].unassignedBillable += e.hours;
                }
            });

            const sortedProjects = Object.entries(byProject).sort((a, b) => b[1].hours - a[1].hours);

            container.innerHTML = `
                <div class="time-report-table">
                    ${sortedProjects.map(([projectId, project]) => {
                        const taskEntries = Object.entries(project.tasks).sort((a, b) => b[1].hours - a[1].hours);
                        const hasUnassigned = project.unassignedHours > 0;

                        return `
                            <div style="margin-bottom:24px;background:var(--bg-secondary);border-radius:var(--radius);overflow:hidden;">
                                <!-- Project Header -->
                                <div style="padding:16px;background:var(--bg-tertiary);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                                    <div style="display:flex;align-items:center;gap:12px;">
                                        <i data-feather="${project.type === 'ticket' ? 'tag' : 'folder'}" style="width:20px;height:20px;color:var(--${project.type === 'ticket' ? 'warning' : 'primary'});"></i>
                                        <div>
                                            <div style="font-weight:600;font-size:15px;">${escapeHtml(project.name)}</div>
                                            <div style="font-size:12px;color:var(--text-muted);">${taskEntries.length} tasks with time logged</div>
                                        </div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-weight:700;font-size:18px;color:var(--primary);">${project.hours.toFixed(1)}h</div>
                                        <div style="font-size:12px;color:var(--success);">${project.billableHours.toFixed(1)}h billable</div>
                                    </div>
                                </div>

                                <!-- Tasks Table -->
                                <table style="width:100%;border-collapse:collapse;">
                                    <thead>
                                        <tr style="background:var(--bg);">
                                            <th style="text-align:left;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;text-transform:uppercase;color:var(--text-muted);">Task</th>
                                            <th style="text-align:right;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;text-transform:uppercase;color:var(--text-muted);">Hours</th>
                                            <th style="text-align:right;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;text-transform:uppercase;color:var(--text-muted);">Billable</th>
                                            <th style="text-align:right;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;text-transform:uppercase;color:var(--text-muted);">% of Project</th>
                                            <th style="text-align:right;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;text-transform:uppercase;color:var(--text-muted);">Team</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${taskEntries.map(([taskId, task]) => {
                                            const percentage = project.hours > 0 ? ((task.hours / project.hours) * 100).toFixed(0) : 0;
                                            return `
                                                <tr style="border-bottom:1px solid var(--border);">
                                                    <td style="padding:12px 16px;">
                                                        <div style="display:flex;align-items:center;gap:8px;">
                                                            <i data-feather="check-square" style="width:14px;height:14px;color:var(--text-muted);"></i>
                                                            <span style="font-weight:500;">${escapeHtml(task.name)}</span>
                                                        </div>
                                                    </td>
                                                    <td style="text-align:right;padding:12px 16px;font-weight:600;">${task.hours.toFixed(1)}h</td>
                                                    <td style="text-align:right;padding:12px 16px;color:var(--success);">${task.billableHours.toFixed(1)}h</td>
                                                    <td style="text-align:right;padding:12px 16px;">
                                                        <div style="display:flex;align-items:center;justify-content:flex-end;gap:8px;">
                                                            <div style="width:60px;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden;">
                                                                <div style="width:${percentage}%;height:100%;background:var(--primary);"></div>
                                                            </div>
                                                            <span style="font-size:12px;color:var(--text-muted);min-width:35px;">${percentage}%</span>
                                                        </div>
                                                    </td>
                                                    <td style="text-align:right;padding:12px 16px;font-size:12px;color:var(--text-muted);">${task.employees.size} member${task.employees.size !== 1 ? 's' : ''}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                        ${hasUnassigned ? `
                                            <tr style="border-bottom:1px solid var(--border);background:var(--bg);">
                                                <td style="padding:12px 16px;">
                                                    <div style="display:flex;align-items:center;gap:8px;">
                                                        <i data-feather="clock" style="width:14px;height:14px;color:var(--text-muted);"></i>
                                                        <span style="font-style:italic;color:var(--text-muted);">Unassigned to task</span>
                                                    </div>
                                                </td>
                                                <td style="text-align:right;padding:12px 16px;font-weight:600;color:var(--text-muted);">${project.unassignedHours.toFixed(1)}h</td>
                                                <td style="text-align:right;padding:12px 16px;color:var(--text-muted);">${project.unassignedBillable.toFixed(1)}h</td>
                                                <td style="text-align:right;padding:12px 16px;">
                                                    <span style="font-size:12px;color:var(--text-muted);">${project.hours > 0 ? ((project.unassignedHours / project.hours) * 100).toFixed(0) : 0}%</span>
                                                </td>
                                                <td style="text-align:right;padding:12px 16px;">-</td>
                                            </tr>
                                        ` : ''}
                                        ${taskEntries.length === 0 && !hasUnassigned ? `
                                            <tr>
                                                <td colspan="5" style="padding:20px;text-align:center;color:var(--text-muted);font-style:italic;">
                                                    No time logged for tasks in this project
                                                </td>
                                            </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderEntriesView(entries, container) {
            const sorted = [...entries].sort((a, b) => b.date.localeCompare(a.date));

            container.innerHTML = `
                <div class="time-report-table">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--bg-tertiary);">
                                <th style="text-align:left;padding:12px;border-bottom:1px solid var(--border);">Date</th>
                                <th style="text-align:left;padding:12px;border-bottom:1px solid var(--border);">Employee</th>
                                <th style="text-align:left;padding:12px;border-bottom:1px solid var(--border);">Project</th>
                                <th style="text-align:left;padding:12px;border-bottom:1px solid var(--border);">Description</th>
                                <th style="text-align:right;padding:12px;border-bottom:1px solid var(--border);">Hours</th>
                                <th style="text-align:center;padding:12px;border-bottom:1px solid var(--border);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(entry => `
                                <tr style="border-bottom:1px solid var(--border);">
                                    <td style="padding:12px;">${escapeHtml(formatDate(entry.date))}</td>
                                    <td style="padding:12px;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <div class="chat-assignee-avatar" style="width:24px;height:24px;font-size:10px;">${escapeHtml(getInitials(entry.employee))}</div>
                                            ${escapeHtml(entry.employee)}
                                        </div>
                                    </td>
                                    <td style="padding:12px;">
                                        <span class="chat-tag" style="background:var(--${entry.projectType === 'ticket' ? 'warning' : 'primary'}-light);color:var(--${entry.projectType === 'ticket' ? 'warning' : 'primary'});">
                                            ${escapeHtml(entry.projectName)}
                                        </span>
                                    </td>
                                    <td style="padding:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeAttr(entry.description || '')}">${escapeHtml(entry.description || '-')}</td>
                                    <td style="text-align:right;padding:12px;font-weight:600;">
                                        ${entry.hours.toFixed(2)}h
                                        ${entry.billable ? '<span style="color:var(--success);font-size:10px;margin-left:4px;">$</span>' : ''}
                                    </td>
                                    <td style="text-align:center;padding:12px;">
                                        <button class="btn btn-secondary" style="padding:4px 8px;" onclick="showTimeEntryModal(timeEntriesData.find(e => e.id === '${escapeAttr(entry.id)}'))">
                                            <i data-feather="edit-2" style="width:12px;height:12px;"></i>
                                        </button>
                                        <button class="btn btn-secondary" style="padding:4px 8px;margin-left:4px;" onclick="deleteTimeEntry('${escapeAttr(entry.id)}')">
                                            <i data-feather="trash-2" style="width:12px;height:12px;color:var(--error);"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Billing Summary View - Shows billable amounts by project for invoicing
        function renderBillingView(entries, container) {
            // Group by project with billing calculations
            const byProject = {};
            let grandTotalHours = 0;
            let grandBillableHours = 0;
            let grandBillableAmount = 0;

            entries.forEach(e => {
                const projectKey = e.projectId || 'general';
                if (!byProject[projectKey]) {
                    byProject[projectKey] = {
                        name: e.projectName || 'General / Unassigned',
                        type: e.projectType || 'general',
                        totalHours: 0,
                        billableHours: 0,
                        billableAmount: 0,
                        employees: {},
                        entries: []
                    };
                }

                const rate = getEmployeeBillableRate(e.employee);
                const entryBillableAmount = e.billable !== false ? e.hours * rate : 0;

                byProject[projectKey].totalHours += e.hours;
                if (e.billable !== false) {
                    byProject[projectKey].billableHours += e.hours;
                    byProject[projectKey].billableAmount += entryBillableAmount;
                }
                byProject[projectKey].entries.push(e);

                // Track by employee within project
                if (!byProject[projectKey].employees[e.employee]) {
                    byProject[projectKey].employees[e.employee] = { hours: 0, billableHours: 0, amount: 0, rate };
                }
                byProject[projectKey].employees[e.employee].hours += e.hours;
                if (e.billable !== false) {
                    byProject[projectKey].employees[e.employee].billableHours += e.hours;
                    byProject[projectKey].employees[e.employee].amount += entryBillableAmount;
                }

                grandTotalHours += e.hours;
                if (e.billable !== false) {
                    grandBillableHours += e.hours;
                    grandBillableAmount += entryBillableAmount;
                }
            });

            const sorted = Object.entries(byProject).sort((a, b) => b[1].billableAmount - a[1].billableAmount);

            container.innerHTML = `
                <div class="billing-summary" style="background:linear-gradient(135deg,var(--success),#059669);color:white;padding:24px;border-radius:var(--radius-lg);margin-bottom:24px;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:24px;text-align:center;">
                        <div>
                            <div style="font-size:32px;font-weight:700;">$${grandBillableAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            <div style="opacity:0.9;font-size:14px;">Total Billable Amount</div>
                        </div>
                        <div>
                            <div style="font-size:32px;font-weight:700;">${grandBillableHours.toFixed(1)}h</div>
                            <div style="opacity:0.9;font-size:14px;">Billable Hours</div>
                        </div>
                        <div>
                            <div style="font-size:32px;font-weight:700;">$${grandBillableHours > 0 ? (grandBillableAmount / grandBillableHours).toFixed(2) : '0.00'}</div>
                            <div style="opacity:0.9;font-size:14px;">Avg Rate/Hour</div>
                        </div>
                    </div>
                </div>

                <div class="time-report-table">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--bg-tertiary);">
                                <th style="text-align:left;padding:12px;border-bottom:2px solid var(--border);">Project / Client</th>
                                <th style="text-align:right;padding:12px;border-bottom:2px solid var(--border);">Total Hours</th>
                                <th style="text-align:right;padding:12px;border-bottom:2px solid var(--border);">Billable Hours</th>
                                <th style="text-align:right;padding:12px;border-bottom:2px solid var(--border);">Billable Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(([id, data]) => `
                                <tr style="border-bottom:1px solid var(--border);cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'table-row' : 'none'">
                                    <td style="padding:12px;">
                                        <div style="display:flex;align-items:center;gap:10px;">
                                            <i data-feather="${data.type === 'ticket' ? 'tag' : data.type === 'general' ? 'inbox' : 'folder'}" style="width:16px;height:16px;color:var(--${data.type === 'ticket' ? 'warning' : 'primary'});"></i>
                                            <span style="font-weight:600;">${escapeHtml(data.name)}</span>
                                            <span style="color:var(--text-muted);font-size:11px;">(click to expand)</span>
                                        </div>
                                    </td>
                                    <td style="text-align:right;padding:12px;">${data.totalHours.toFixed(1)}h</td>
                                    <td style="text-align:right;padding:12px;color:var(--success);font-weight:500;">${data.billableHours.toFixed(1)}h</td>
                                    <td style="text-align:right;padding:12px;font-weight:700;color:var(--primary);font-size:16px;">$${data.billableAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                                </tr>
                                <tr style="display:none;background:var(--surface-dark);">
                                    <td colspan="4" style="padding:0 12px 12px 40px;">
                                        <table style="width:100%;border-collapse:collapse;margin-top:8px;">
                                            <thead>
                                                <tr style="font-size:12px;color:var(--text-muted);">
                                                    <th style="text-align:left;padding:8px;">Employee</th>
                                                    <th style="text-align:right;padding:8px;">Rate</th>
                                                    <th style="text-align:right;padding:8px;">Hours</th>
                                                    <th style="text-align:right;padding:8px;">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(data.employees).map(([emp, empData]) => `
                                                    <tr style="font-size:13px;">
                                                        <td style="padding:6px 8px;">${escapeHtml(emp)}</td>
                                                        <td style="text-align:right;padding:6px 8px;color:var(--text-muted);">$${empData.rate}/hr</td>
                                                        <td style="text-align:right;padding:6px 8px;">${empData.billableHours.toFixed(1)}h</td>
                                                        <td style="text-align:right;padding:6px 8px;font-weight:500;">$${empData.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background:var(--surface-darker);font-weight:700;">
                                <td style="padding:16px 12px;">TOTAL</td>
                                <td style="text-align:right;padding:16px 12px;">${grandTotalHours.toFixed(1)}h</td>
                                <td style="text-align:right;padding:16px 12px;color:var(--success);">${grandBillableHours.toFixed(1)}h</td>
                                <td style="text-align:right;padding:16px 12px;color:var(--primary);font-size:18px;">$${grandBillableAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="exportBillingReport()">
                        <i data-feather="file-text" style="width:14px;height:14px;"></i>
                        Export Billing Report
                    </button>
                </div>
            `;
        }

        // Export billing report with rates and amounts
        function exportBillingReport() {
            const entries = getFilteredTimeEntries();
            if (entries.length === 0) {
                showNotification('No entries to export', 'error');
                return;
            }

            const data = entries.filter(e => e.billable !== false).map(e => {
                const rate = getEmployeeBillableRate(e.employee);
                return {
                    Date: e.date,
                    Employee: e.employee,
                    Project: e.projectName || 'General',
                    Task: e.taskName || '',
                    Hours: e.hours,
                    'Rate ($/hr)': rate,
                    'Amount ($)': (e.hours * rate).toFixed(2),
                    Description: e.description || ''
                };
            });

            // Add summary row
            const totalHours = data.reduce((sum, d) => sum + d.Hours, 0);
            const totalAmount = data.reduce((sum, d) => sum + parseFloat(d['Amount ($)']), 0);
            data.push({
                Date: '',
                Employee: '',
                Project: 'TOTAL',
                Task: '',
                Hours: totalHours,
                'Rate ($/hr)': '',
                'Amount ($)': totalAmount.toFixed(2),
                Description: ''
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Billing Report');

            // Get date range for filename
            const startDate = document.getElementById('timeReportStartDate').value || 'all';
            const endDate = document.getElementById('timeReportEndDate').value || 'dates';
            XLSX.writeFile(wb, `billing-report-${startDate}-to-${endDate}.xlsx`);
            showNotification('Billing report exported', 'success');
        }

        function updateTimeReportFilters() {
            const employeeSelect = document.getElementById('timeReportEmployee');
            const projectSelect = document.getElementById('timeReportProject');
            const currentEmployee = employeeSelect.value;
            const currentProject = projectSelect.value;

            // Update employee filter
            const employees = [...new Set(timeEntriesData.map(e => e.employee))].sort();
            employeeSelect.innerHTML = '<option value="">All Employees</option>';
            employees.forEach(emp => {
                employeeSelect.innerHTML += `<option value="${escapeAttr(emp)}">${escapeHtml(emp)}</option>`;
            });
            employeeSelect.value = currentEmployee;

            // Update project filter
            const projects = [...new Set(timeEntriesData.filter(e => e.projectId).map(e => `${e.projectType}:${e.projectId}:${e.projectName}`))];
            projectSelect.innerHTML = '<option value="">All Projects/Tickets</option>';
            projects.forEach(p => {
                const [type, id, name] = p.split(':');
                projectSelect.innerHTML += `<option value="${type}:${id}">${escapeHtml(name)}</option>`;
            });
            projectSelect.value = currentProject;
        }

        function exportTimeReport() {
            const entries = getFilteredTimeEntries();
            if (entries.length === 0) {
                showNotification('No entries to export', 'error');
                return;
            }

            const data = entries.map(e => ({
                Date: e.date,
                Employee: e.employee,
                Project: e.projectName,
                Type: e.type,
                Hours: e.hours,
                Billable: e.billable ? 'Yes' : 'No',
                Description: e.description || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Time Report');
            XLSX.writeFile(wb, `time-report-${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Time report exported', 'success');
        }

        function initTimeReports() {
            // Load saved entries from localStorage
            const saved = localStorage.getItem('timeEntriesData');
            if (saved) {
                try {
                    timeEntriesData = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load time entries:', e);
                }
            }

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            document.getElementById('timeReportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('timeReportEndDate').value = today.toISOString().split('T')[0];

            renderTimeReports();
        }

        // Initialize search on load
        document.addEventListener('DOMContentLoaded', initGlobalSearch);
        document.addEventListener('DOMContentLoaded', initVersionHistory);
        document.addEventListener('DOMContentLoaded', initAttachments);
        document.addEventListener('DOMContentLoaded', initCalendar);
        document.addEventListener('DOMContentLoaded', initTimeReports);
        document.addEventListener('DOMContentLoaded', () => {
            loadSyncQueue();
            updateSyncIndicator();
            // Auto-sync on load if there are pending items
            if (timeEntrySyncQueue.length > 0 && CONFIG.timeEntriesListId) {
                setTimeout(processSyncQueue, 3000); // Wait 3s for auth to complete
            }
        });

        // Event listeners
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeModal();
                closeProjectDetailModal();
                closeAddTaskModal();
                closeAIPanel();
                closeVersionHistoryPanel();
                closeTimeEntryModal();
            }
        });
        document.getElementById('modal').addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) closeModal(); });
        document.getElementById('projectDetailModal').addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) closeProjectDetailModal(); });
        document.getElementById('addTaskModal').addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) closeAddTaskModal(); });
        document.getElementById('timeEntryModal').addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) closeTimeEntryModal(); });
        document.getElementById('aiInput').addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAIMessage(); } });
    </script>
</body>
</html>
