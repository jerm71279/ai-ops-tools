###############################################################################
# CD Workflow - Deploy to Production
# 
# Purpose:
# This workflow handles automatic deployment to production when code is merged
# to the main branch. It integrates with Lovable's automatic deployment system.
#
# Triggers:
# - Push to 'main' branch only
# - Manual trigger via workflow_dispatch (for emergency deployments)
#
# What it does:
# 1. Checks out the code from the repository
# 2. Validates that the code builds successfully
# 3. Triggers Lovable's automatic deployment
# 4. Notifies team of deployment status
#
# How Lovable Deployment Works:
# - Lovable automatically watches your GitHub repository
# - When changes are pushed to the main branch, Lovable:
#   1. Pulls the latest code
#   2. Builds the React application
#   3. Deploys edge functions to Supabase
#   4. Updates the production environment
#   5. Runs database migrations if needed
#
# Important Notes:
# - Edge functions deploy automatically (department-assistant, workflow-executor, 
#   workflow-webhook, mcp-server)
# - Database changes require manual migration approval in Lovable
# - Production uses the same Supabase project (can be separated later)
# - SSL certificates are automatically managed by Lovable
###############################################################################

name: Deploy to Production

# Trigger this workflow on push to main branch or manual trigger
on:
  push:
    branches: 
      - main  # Only deploy when code is merged to main
  workflow_dispatch:  # Allow manual triggering from GitHub Actions UI
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

jobs:
  # Job: deploy
  # Validates the build and triggers deployment
  deploy:
    runs-on: ubuntu-latest
    
    # Only run if commit message doesn't contain [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Step 2: Set up Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # Step 4: Build the application
      # This validates that the code builds successfully before deployment
      # Lovable will do this again, but we check here to fail fast
      - name: Build application
        run: npm run build
        env:
          # These are public keys, safe to include
          # Lovable automatically provides these in production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      
      # Step 5: Notify deployment start
      # This creates a deployment event in GitHub
      - name: Create deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ github.token }}
          environment: production
          initial-status: in_progress
      
      # Step 6: Lovable automatic deployment
      # Lovable watches the main branch and deploys automatically
      # This step just logs that we're waiting for Lovable
      - name: Trigger Lovable deployment
        run: |
          echo "‚úÖ Code pushed to main branch"
          echo "üöÄ Lovable is automatically deploying..."
          echo "üì¶ Deploying edge functions:"
          echo "   - department-assistant"
          echo "   - workflow-executor"
          echo "   - workflow-webhook"
          echo "   - mcp-server"
          echo "üåê Production URL will be updated shortly"
          echo "‚è±Ô∏è  Deployment typically takes 2-3 minutes"
      
      # Step 7: Wait for deployment to complete
      # In a production setup, you could ping a health endpoint here
      # For now, we just wait a reasonable time
      - name: Wait for deployment
        run: |
          echo "Waiting for Lovable deployment to complete..."
          sleep 30
      
      # Step 8: Update deployment status
      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: success
          environment-url: https://yourproject.lovable.app
      
      # Step 9: Update deployment status on failure
      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: failure

###############################################################################
# Post-Deployment Checklist (Manual)
# After deployment completes, verify:
# 
# ‚úÖ Frontend
# - Homepage loads correctly
# - Navigation works
# - All dashboard pages accessible
# - Authentication flow works
# 
# ‚úÖ Backend
# - Edge functions are responding
# - Database queries working
# - RLS policies enforced
# - Webhooks receiving data
# 
# ‚úÖ Security
# - HTTPS certificate valid
# - CORS headers correct
# - API keys not exposed
# - User data protected by RLS
# 
# ‚úÖ Monitoring
# - Check edge function logs for errors
# - Verify database connection stable
# - Monitor authentication metrics
# - Review any new error reports
###############################################################################
