<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>SOP-SP-002_SharePoint_Permissions_v1.0.0</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">SOP-SP-002_SharePoint_Permissions_v1.0.0</h1>
</header>
<p>Error executing tool write_file: Tool ‚Äúwrite_file‚Äù not found in
registry. Tools must use the exact names that are registered. Did you
mean one of: ‚Äúread_file‚Äù, ‚Äúwrite_todos‚Äù, ‚Äúweb_fetch‚Äù? I am unable to
create files directly. However, I have generated the complete SOP
markdown for <code>SOP-SP-002.md</code>. You can copy the content below
and save it to the desired file.</p>
<p>```markdown # Standard Operating Procedure: SOP-SP-002</p>
<p><strong>Title:</strong> Adding SharePoint Read-Only Permissions to an
Existing Azure Application <strong>Version:</strong> 1.0
<strong>Effective Date:</strong> 2025-12-02 <strong>Owner:</strong>
System Administrator</p>
<hr />
<h2 id="purpose">1.0 Purpose</h2>
<p>This document outlines the standard procedure for adding
<code>Sites.Read.All</code> and <code>Files.Read.All</code> application
permissions to an existing Azure Active Directory (Azure AD)
application. This enables the application to securely authenticate and
retrieve data from SharePoint on behalf of the system, without user
interaction, adhering to the principle of least privilege.</p>
<h2 id="scope">2.0 Scope</h2>
<p>This procedure applies to the existing Azure AD application used for
the SecondBrain project. It is intended for administrators with the
necessary permissions to manage application registrations and grant
tenant-wide admin consent in the Azure portal.</p>
<h2 id="prerequisites">3.0 Prerequisites</h2>
<ul>
<li>An existing Azure AD application registration.</li>
<li>Administrative access to the Azure portal
(<code>portal.azure.com</code>).</li>
<li>The name or Application ID of the target Azure application.</li>
<li>Terminal access to the application server to update environment
files.</li>
</ul>
<h2 id="procedure">4.0 Procedure</h2>
<p>The procedure is divided into four main parts: adding API
permissions, granting consent, obtaining credentials, and configuring
the local environment.</p>
<h3 id="add-api-permissions">4.1 Add API Permissions</h3>
<ol type="1">
<li>Navigate to the Azure portal and open <strong>Azure Active
Directory</strong>.</li>
<li>Go to <strong>App registrations</strong> and select your existing
application.</li>
<li>In the left sidebar, click on <strong>API permissions</strong>.</li>
<li>Click the <strong>+ Add a permission</strong> button.</li>
<li>In the ‚ÄúRequest API permissions‚Äù panel, select <strong>Microsoft
Graph</strong>.</li>
<li>Select <strong>Application permissions</strong>. This allows the
application to authenticate on its own, which is required for a
background service.</li>
<li>In the ‚ÄúSelect permissions‚Äù search box, find and add the following
two permissions:
<ul>
<li><strong><code>Sites.Read.All</code></strong>: Check the box. This
permits reading items in all site collections.</li>
<li><strong><code>Files.Read.All</code></strong>: Check the box. This
permits reading files in all site collections.</li>
</ul></li>
<li>Click the <strong>Add permissions</strong> button at the bottom of
the panel.</li>
</ol>
<h3 id="grant-admin-consent">4.2 Grant Admin Consent</h3>
<ol type="1">
<li>Once the permissions are added, they will appear in the API
permissions list with a status of ‚ÄúNot granted‚Äù.</li>
<li>Click the <strong>‚ÄúGrant admin consent for [Your Tenant
Name]‚Äù</strong> button located above the permissions list.</li>
<li>A confirmation dialog will appear. Click <strong>Yes</strong>.</li>
<li>Wait for the status of the new permissions to update to ‚ÄúGranted‚Äù,
indicated by a green checkmark. The final configuration should appear as
follows:
<code>‚úì User.Read (Delegated) - Granted     ‚úì Sites.Read.All (Application) - Granted     ‚úì Files.Read.All (Application) - Granted</code></li>
</ol>
<h3 id="obtain-application-credentials">4.3 Obtain Application
Credentials</h3>
<p>Three pieces of information are required to configure the
application.</p>
<ol type="1">
<li><strong>Tenant ID</strong>:
<ul>
<li>Navigate to the <strong>Overview</strong> page for your
application.</li>
<li>Copy the <strong>Directory (tenant) ID</strong> value.</li>
</ul></li>
<li><strong>Application (Client) ID</strong>:
<ul>
<li>On the same <strong>Overview</strong> page, copy the
<strong>Application (client) ID</strong> value.</li>
</ul></li>
<li><strong>Client Secret</strong>:
<ul>
<li>Navigate to the <strong>Certificates &amp; secrets</strong>
page.</li>
<li>If you do not have an active, unexpired secret whose value you have
saved, you must create a new one.</li>
<li>Click <strong>+ New client secret</strong>.</li>
<li>Provide a description (e.g.,
<code>SecondBrain SharePoint Access</code>).</li>
<li>Set the expiration period (e.g., <code>24 months</code>).</li>
<li>Click <strong>Add</strong>.</li>
<li><strong>CRITICAL:</strong> Immediately copy the new secret‚Äôs
<strong>Value</strong> and store it in a secure location. This value is
only shown once.</li>
</ul></li>
</ol>
<h3 id="configure-environment-file">4.4 Configure Environment File</h3>
<ol type="1">
<li>Connect to the application server via terminal.</li>
<li>Navigate to the project directory:
<code>bash     cd /path/to/project</code></li>
<li>Open the <code>.env</code> file for editing:
<code>bash     nano .env</code></li>
<li>Add or update the following lines with the credentials obtained in
the previous step:
<code>bash     AZURE_TENANT_ID=your-tenant-id-here     AZURE_CLIENT_ID=your-application-client-id-here     AZURE_CLIENT_SECRET=your-client-secret-value-here</code></li>
<li>Save the file and exit the editor (<code>Ctrl+X</code>, then
<code>Y</code>, then <code>Enter</code>).</li>
</ol>
<h2 id="verification">5.0 Verification</h2>
<p>To confirm that the permissions and credentials are correctly
configured, run the test script.</p>
<ol type="1">
<li>Navigate to the project directory:
<code>bash     cd /path/to/project</code></li>
<li>Execute the SharePoint importer script using the project‚Äôs virtual
environment:
<code>bash     ./venv/bin/python sharepoint_importer.py</code></li>
<li><strong>Expected Output</strong>: The script should successfully
list the available SharePoint sites without any permission errors.
<code>üìç Listing SharePoint sites...     üìç Found X SharePoint sites:        - Site Name 1 (https://...)        - Site Name 2 (https://...)</code></li>
</ol>
<h2 id="security-considerations">6.0 Security Considerations</h2>
<ul>
<li><strong>Principle of Least Privilege</strong>: This procedure grants
read-only access (<code>.Read.All</code>). <strong>DO NOT</strong> grant
write permissions (e.g., <code>Sites.ReadWrite.All</code>,
<code>Sites.FullControl.All</code>) unless explicitly required and
approved.</li>
<li><strong>Permission Scope</strong>:
<ul>
<li><code>Sites.Read.All</code>: Allows the application to list sites
and read metadata. It does not permit creating, altering, or deleting
sites.</li>
<li><code>Files.Read.All</code>: Allows the application to download
files and read file metadata. It does not permit uploading, altering, or
deleting files.</li>
</ul></li>
<li><strong>Credential Security</strong>: The
<code>AZURE_CLIENT_SECRET</code> is a sensitive credential. Ensure it is
stored securely and is not committed to version control. Use environment
files (<code>.env</code>) or a secrets management system.</li>
</ul>
<h2 id="troubleshooting">7.0 Troubleshooting</h2>
<ul>
<li><strong>Error: ‚ÄúInsufficient privileges to complete the
operation‚Äù</strong>
<ul>
<li><strong>Cause</strong>: Admin consent has not been granted or has
not yet propagated.</li>
<li><strong>Solution</strong>: Ensure you have completed step
<strong>4.2 Grant Admin Consent</strong>. Wait up to 5-10 minutes for
permissions to fully propagate across Microsoft‚Äôs systems.</li>
</ul></li>
<li><strong>Error: ‚ÄúFailed to get access token‚Äù</strong>
<ul>
<li><strong>Cause</strong>: The credentials in the <code>.env</code>
file are incorrect.</li>
<li><strong>Solution</strong>: Double-check that the
<code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code>, and
<code>AZURE_CLIENT_SECRET</code> values are copied correctly and have no
extra characters or whitespace. Verify the client secret has not
expired.</li>
</ul></li>
<li><strong>Error: ‚ÄúCollection does not exist‚Äù</strong>
<ul>
<li><strong>Cause</strong>: The Site ID used in a script is
incorrect.</li>
<li><strong>Solution</strong>: Ensure you are using the correct
<code>site_id</code> as provided by the verification script in section
<strong>5.0</strong>.</li>
</ul></li>
</ul>
<h2 id="appendix">8.0 Appendix</h2>
<h3 id="post-setup-actions">8.1 Post-Setup Actions</h3>
<p>After successful verification, you can use the configured importer to
interact with SharePoint.</p>
<ol type="1">
<li><p>Launch the Python interpreter within the project‚Äôs environment:
<code>bash     ./venv/bin/python</code></p></li>
<li><p>Use the <code>SharePointImporter</code> class to list libraries
and download files:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sharepoint_importer <span class="im">import</span> SharePointImporter</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>importer <span class="op">=</span> SharePointImporter()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: List document libraries in a specific site</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries = importer.list_document_libraries(site_id=&quot;YOUR_SITE_ID&quot;)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Download files from a specific library</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># importer.download_files_from_library(</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     site_id=&quot;YOUR_SITE_ID&quot;,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     drive_id=&quot;YOUR_DRIVE_ID&quot;,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     output_dir=&quot;input_documents/sharepoint/oberaconnect&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div></li>
</ol>
<h3 id="completion-checklist">8.2 Completion Checklist</h3>
<ul class="task-list">
<li><label><input type="checkbox" /><code>Sites.Read.All</code>
(Application) permission added.</label></li>
<li><label><input type="checkbox" /><code>Files.Read.All</code>
(Application) permission added.</label></li>
<li><label><input type="checkbox" />Admin consent granted for new
permissions.</label></li>
<li><label><input type="checkbox" />Tenant ID copied from application
Overview page.</label></li>
<li><label><input type="checkbox" />Application (Client) ID copied from
application Overview page.</label></li>
<li><label><input type="checkbox" />Client Secret created and its value
securely copied.</label></li>
<li><label><input type="checkbox" /><code>AZURE_TENANT_ID</code>,
<code>AZURE_CLIENT_ID</code>, and <code>AZURE_CLIENT_SECRET</code> added
to <code>.env</code> file.</label></li>
<li><label><input type="checkbox" />Connection verified successfully
with <code>sharepoint_importer.py</code>.</label></li>
</ul>
</body>
</html>
