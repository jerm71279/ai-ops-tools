version: '3.8'

services:
  # =============================================================================
  # n8n - Workflow Automation Platform (SECURED)
  # =============================================================================
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "127.0.0.1:5678:5678"  # SECURED: Only listen on localhost
    environment:
      # Basic Auth (REQUIRED)
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:?N8N_BASIC_AUTH_PASSWORD is required}

      # Encryption (REQUIRED)
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:?N8N_ENCRYPTION_KEY is required}

      # Webhook URL (for external access via reverse proxy)
      - WEBHOOK_URL=${WEBHOOK_URL:-https://localhost:5678}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https

      # Timezone
      - GENERIC_TIMEZONE=${TIMEZONE:-America/Chicago}
      - TZ=${TIMEZONE:-America/Chicago}

      # Execution settings
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_PROGRESS=false
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true

      # Performance
      - N8N_PAYLOAD_SIZE_MAX=64

      # Qdrant connection (internal Docker network with API key)
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:?QDRANT_API_KEY is required}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/home/node/workflows
      - ./backups:/home/node/backups
    networks:
      - secondbrain-network
    depends_on:
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # =============================================================================
  # Qdrant - Vector Database (SECURED with API Key)
  # =============================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "127.0.0.1:6333:6333"  # SECURED: Only listen on localhost
      - "127.0.0.1:6334:6334"  # SECURED: gRPC also localhost only
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      # SECURITY: API Key Authentication
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY:?QDRANT_API_KEY is required}
      - QDRANT__SERVICE__READ_ONLY_API_KEY=${QDRANT_READ_ONLY_API_KEY:-}
    volumes:
      - qdrant_storage:/qdrant/storage
      - qdrant_snapshots:/qdrant/snapshots
    networks:
      - secondbrain-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "--header", "api-key: ${QDRANT_API_KEY}", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M

  # =============================================================================
  # Nginx Reverse Proxy (For SSL termination - RECOMMENDED)
  # =============================================================================
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - secondbrain-network
    depends_on:
      - n8n
    profiles:
      - ssl  # Only start with: docker-compose --profile ssl up

# =============================================================================
# Networks
# =============================================================================
networks:
  secondbrain-network:
    driver: bridge
    name: secondbrain-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  n8n_data:
    name: n8n_data
  qdrant_storage:
    name: qdrant_storage
  qdrant_snapshots:
    name: qdrant_snapshots
